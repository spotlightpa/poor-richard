{{ define "main" }}
  <div class="mx-auto px-4 py-8">
    <div id="checkout-wrapper">
      <div id="checkout-loading"></div>
      <div id="checkout"></div>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('pk_live_51Mmd3kPgmnviwloDdsisjwVxkC83MMcGgttB9kXXJs3gj0MakZRrWPqMtCq3uOSZB7G4prfxYPGvbNnwsvjDNx2E00EdEf2rFP');

  fetch('/.netlify/functions/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      priceId: '{{ .Params.stripe_price_id }}'
    })
  })
    .then((res) => res.json())
    .then((data) => {
      if (!data.clientSecret) {
        throw new Error(data.error || 'Missing clientSecret from server');
      }

      return stripe.initEmbeddedCheckout({
        clientSecret: data.clientSecret,
      });
    })
    .then((checkout) => {
      const loadingEl = document.getElementById('checkout-loading');
      if (loadingEl) loadingEl.style.display = 'none';

      checkout.mount('#checkout');
    })
    .catch((error) => {
      console.error('Stripe checkout error:', error);
      const loadingEl = document.getElementById('checkout-loading');
      if (loadingEl) {
        loadingEl.innerText = 'Error loading checkout. Please try again.';
      }
    });
</script>
{{ end }}
