<div class="carousel-container">
  <div class="carousel-arrow left-arrow">
    <svg class="h-16 w-16 fill-white">
      {{ partial "helper/svg.html" "chevron-left" }}
    </svg>
  </div>

  <div class="carousel-content">
    {{ range $index, $item := site.Data.carousel.items }}
      {{ $w := int $item.width }}
      {{ $h := int $item.height }}
      <div class="carousel-item" data-index="{{ $index }}">
        <img
          class="carousel-photo"
          src="{{ partial "helper/imgproxy" (dict "filename" $item.image "width" 1200 "height" 800) }}"
          alt="{{ $item.alt }}"
        />
        <div class="carousel-blurb">
          <div class="carousel-grid">
            <div class="carousel-title">Spotlight PA Featured Impact</div>
            <div class="carousel-tagline">{{ $item.tagline }}</div>
            <div class="carousel-text">{{ $item.text }}</div>
            <div class="read-the-series">
              <a href="{{ $item.link }}" target="_blank">
                {{ $item.linkText }}
                <svg class="h-5 w-5 fill-black">
                  {{ partial "helper/svg.html" "right" }}
                </svg>
              </a>
            </div>
          </div>
        </div>
        <div class="carousel-right-half"></div>
      </div>
    {{ end }}
  </div>

  <div class="carousel-arrow right-arrow">
    <svg class="h-16 w-16 fill-white">
      {{ partial "helper/svg.html" "chevron-right" }}
    </svg>
  </div>
</div>

<div class="bottom-bar">
  <div class="bottom-bar-gradient-box left-gradient-box"></div>
  <div class="bottom-bar-gradient-box right-gradient-box"></div>

  <div class="bottom-bar-arrows">
    <div class="bottom-bar-arrow left-bottom-arrow"></div>
    <div class="bottom-bar-arrow right-bottom-arrow"></div>
  </div>

  <div class="bottom-bar-boxes-container">
    <div class="impact-boxes-wrapper">
      {{ range $index, $item := site.Data.carousel.items }}
        <div class="impact-box" data-index="{{ $index }}">
          <div class="impact-box-photo">
            <img
              src="{{ partial "helper/imgproxy" (dict "filename" $item.image "width" 200 "height" 150) }}"
              alt="{{ $item.alt }}"
              class="impact-box-image"
            />
          </div>
          <div class="impact-box-text-container">
            <div class="impact-box-tag">{{ $item.tagline }}</div>
            <div class="impact-box-text">{{ $item.short }}</div>
          </div>
        </div>
      {{ end }}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const carouselItems = document.querySelectorAll(".carousel-item");
    const leftArrow = document.querySelector(".left-arrow");
    const rightArrow = document.querySelector(".right-arrow");
    const bottomBarContainer = document.querySelector(
      ".bottom-bar-boxes-container",
    );
    const impactBoxes = document.querySelectorAll(".impact-box");

    let currentIndex = 0;

    function updateCarousel() {
      carouselItems.forEach((item, index) => {
        const photo = item.querySelector(".carousel-photo");
        const impactBoxImage = document.querySelector(
          `.impact-box[data-index="${index}"] .impact-box-image`,
        );

        if (index === currentIndex) {
          item.style.display = "flex";
          photo.classList.add("active");
          if (impactBoxImage) impactBoxImage.classList.add("active");
        } else {
          item.style.display = "none";
          photo.classList.remove("active");
          if (impactBoxImage) impactBoxImage.classList.remove("active");
        }
      });

      scrollToActiveBox();
      updateCarouselArrowStates();

      document
        .querySelectorAll(".impact-box-text-container")
        .forEach((container) => {
          container.classList.remove("active");
        });

      const activeImpactBox = document.querySelector(
        `.impact-box[data-index="${currentIndex}"] .impact-box-text-container`,
      );
      if (activeImpactBox) {
        activeImpactBox.classList.add("active");
      }

      updateGradients();
    }

    function updateCarouselArrowStates() {
      leftArrow.style.opacity = currentIndex === 0 ? "0.5" : "1";
      leftArrow.style.pointerEvents = currentIndex === 0 ? "none" : "auto";
      rightArrow.style.opacity =
        currentIndex === carouselItems.length - 1 ? "0.5" : "1";
      rightArrow.style.pointerEvents =
        currentIndex === carouselItems.length - 1 ? "none" : "auto";
    }

    function navigateCarousel(direction) {
      if (direction === "left" && currentIndex > 0) {
        currentIndex--;
      }
      if (direction === "right" && currentIndex < carouselItems.length - 1) {
        currentIndex++;
      }
      updateCarousel();
    }

    function scrollToActiveBox() {
      const activeBox = document.querySelector(
        `.impact-box[data-index="${currentIndex}"]`,
      );
      if (activeBox) {
        const containerLeft = bottomBarContainer.scrollLeft;
        const containerRight = containerLeft + bottomBarContainer.clientWidth;
        const boxLeft = activeBox.offsetLeft;
        const boxRight = boxLeft + activeBox.offsetWidth;

        if (boxLeft < containerLeft) {
          bottomBarContainer.scrollBy({
            left: boxLeft - containerLeft,
            behavior: "smooth",
          });
        } else if (boxRight > containerRight) {
          bottomBarContainer.scrollBy({
            left: boxRight - containerRight,
            behavior: "smooth",
          });
        }
      }
    }

    function handleBottomBoxClick(event) {
      const clickedBox = event.target.closest(".impact-box");
      if (clickedBox) {
        const index = parseInt(clickedBox.dataset.index, 10);
        if (!isNaN(index)) {
          currentIndex = index;
          updateCarousel();
        }
      }
    }

    leftArrow.addEventListener("click", () => navigateCarousel("left"));
    rightArrow.addEventListener("click", () => navigateCarousel("right"));

    impactBoxes.forEach((box) => {
      box.addEventListener("click", handleBottomBoxClick);
    });

    const leftGradient = document.querySelector(".left-gradient-box");
    const rightGradient = document.querySelector(".right-gradient-box");

    function updateGradients() {
      const scrollLeft = bottomBarContainer.scrollLeft;
      const scrollWidth = bottomBarContainer.scrollWidth;
      const clientWidth = bottomBarContainer.clientWidth;

      if (scrollLeft > 0) {
        leftGradient.style.display = "block";
      } else {
        leftGradient.style.display = "none";
      }

      if (scrollLeft + clientWidth < scrollWidth) {
        rightGradient.style.display = "block";
      } else {
        rightGradient.style.display = "none";
      }
    }

    bottomBarContainer.addEventListener("scroll", updateGradients);

    window.addEventListener("resize", updateGradients);

    updateCarousel();
    updateGradients();
  });
</script>

<style>
  .carousel-container {
    display: flex;
    align-items: center;
    position: relative;
    width: 100%;
    background-color: #cfcfcf;
  }

  .carousel-arrow {
    position: absolute;
    z-index: 3;
    cursor: pointer;
  }

  .carousel-arrow svg {
    fill: #ffffff;
    stroke: #2e2e2e;
    stroke-width: 4px;
    filter: drop-shadow(3px 3px 2px rgba(0, 0, 0, 0.7));
  }

  .carousel-arrow.left-arrow {
    left: 5px;
  }

  .carousel-arrow.right-arrow {
    right: 5px;
  }

  .carousel-arrow svg {
    fill: #ffffff;
  }

  .carousel-title {
    font-size: 38px;
    color: #ffffff;
    font-weight: bold;
  }

  @media (max-width: 980px) {
    .carousel-title {
      font-size: 32px;
    }
  }

  .carousel-tagline {
    font-size: 12px;
    background-color: #fff;
    text-transform: uppercase;
    font-weight: 600;
    width: fit-content;
    padding: 8px;
  }

  .carousel-text {
    color: #fff;
  }

  .carousel-text::first-letter {
    font-size: 48px;
    float: left;
    margin-right: 5px;
    line-height: 1;
    margin-top: -7px;
  }

  .read-the-series a {
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    background-color: #fff;
    text-align: center;
    padding: 10px 25px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
  }

  .read-the-series a svg {
    margin-left: 10px;
  }

  .carousel-content {
    display: flex;
    flex-direction: row;
    width: 100%;
    position: relative;
    height: 450px;
  }

  .carousel-item {
    display: flex;
    position: relative;
    width: 100%;
    height: 100%;
  }

  .carousel-photo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
  }

  .carousel-blurb {
    z-index: 2;
    flex: 1;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 25px 25px 25px 70px;
  }

  .carousel-right-half {
    flex: 1;
    position: relative;
    z-index: 2;
    background: transparent;
  }

  .carousel-grid {
    display: grid;
    grid-template-rows: auto auto auto auto;
    gap: 15px;
  }

  @media (max-width: 780px) {
    .carousel-item {
      flex-direction: column;
    }

    .carousel-blurb {
      order: 1;
      padding: 80px;
      height: 100%;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7);
      box-sizing: border-box;
    }

    .carousel-right-half {
      order: 2;
      display: none;
    }

    .carousel-photo {
      object-fit: cover;
    }

    .carousel-text::first-letter {
      font-size: 32px;
      float: none;
      margin-right: 0;
    }

    .read-the-series a {
      padding: 10px 20px;
    }
  }

  @media (max-width: 495px) {
    .carousel-blurb {
      padding: 40px;
    }

    .carousel-arrow svg {
      height: 3rem;
    }

    .carousel-arrow.left-arrow {
      left: -11px;
    }

    .carousel-arrow.right-arrow {
      right: -11px;
    }
  }

  @media (max-width: 425px) {
    .carousel-title {
      font-size: 28px;
    }

    .carousel-content {
      height: 600px;
    }

    .carousel-blurb {
      padding: 40px 50px;
    }
  }

  .bottom-bar {
    background: #424242;
    width: 100%;
    height: 170px;
    position: relative;
  }

  .bottom-bar-boxes-container {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 35px;
    right: 35px;
    height: 130px;
    overflow-x: auto;
    overflow-y: hidden;
    z-index: 2;
    scrollbar-width: none;
  }

  .bottom-bar-boxes-container::-webkit-scrollbar {
    display: none;
  }

  .impact-boxes-wrapper {
    display: inline-flex;
    gap: 20px;
  }

  .impact-box {
    width: 400px;
    height: 130px;
    display: flex;
    flex: 0 0 auto;
    cursor: pointer;
  }

  .impact-box-photo {
    width: 400px;
    height: 100%;
    position: relative;
  }

  .impact-box-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .impact-box-image.active {
    transition: opacity 0.3s ease;
    opacity: 0.4;
  }

  .impact-box-text-container {
    width: 100%;
  }

  .impact-box-text-container.active {
    transition: background-color 0.3s ease;
    opacity: 0.4;
  }

  .impact-box-tag {
    text-transform: uppercase;
    font-size: 13px;
    background-color: black;
    font-weight: bold;
    color: #fff;
    width: fit-content;
    padding: 1px 5px;
    margin-left: 10px;
  }

  .impact-box-text {
    font-size: 13px;
    padding: 5px 0px 0px 10px;
    color: #fff;
    white-space: normal;
  }

  .bottom-bar-gradient-box {
    position: absolute;
    top: 0;
    width: 75px;
    height: 100%;
    z-index: 3;
  }

  .left-gradient-box {
    left: 35px;
    background: linear-gradient(
      to right,
      rgba(66, 66, 66, 1) 0%,
      rgba(66, 66, 66, 1) 30%,
      rgba(66, 66, 66, 0) 100%
    );
  }

  .right-gradient-box {
    right: 35px;
    background: linear-gradient(
      to right,
      rgba(66, 66, 66, 0) 0%,
      rgba(66, 66, 66, 1) 70%,
      rgba(66, 66, 66, 1) 100%
    );
  }
</style>
