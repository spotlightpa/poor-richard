{{ $css := resources.Get "css/carousel.css" | minify | fingerprint }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}" />

<div class="carousel-container">
  <div class="carousel-arrow left-arrow">
    <svg class="h-16 w-16 fill-white">
      {{ partial "helper/svg.html" "chevron-left" }}
    </svg>
  </div>

  <div class="carousel-content">
    {{ range $index, $item := site.Data.carousel.items }}
      {{ $w := int $item.width }}
      {{ $h := int $item.height }}
      <div class="carousel-item" data-index="{{ $index }}">
        <img
          class="carousel-photo"
          src="{{ partial "helper/imgproxy" (dict "filename" $item.image "width" 1200 "height" 800) }}"
          alt="{{ $item.alt }}"
        />
        <div class="carousel-blurb">
          <div class="carousel-grid">
            <div class="carousel-title">Spotlight PA Featured Impact</div>
            <div class="carousel-tagline">{{ $item.tagline }}</div>
            <div class="carousel-text">{{ $item.text }}</div>
            <div class="read-the-series">
              <a href="{{ $item.link }}" target="_blank">
                {{ $item.linkText }}
                <svg class="h-5 w-5 fill-black">
                  {{ partial "helper/svg.html" "right" }}
                </svg>
              </a>
            </div>
          </div>
        </div>
        <div class="carousel-right-half"></div>
      </div>
    {{ end }}
  </div>

  <div class="carousel-arrow right-arrow">
    <svg class="h-16 w-16 fill-white">
      {{ partial "helper/svg.html" "chevron-right" }}
    </svg>
  </div>
</div>

<div class="bottom-bar">
  <div class="bottom-bar-gradient-box left-gradient-box"></div>
  <div class="bottom-bar-gradient-box right-gradient-box"></div>

  <div class="bottom-bar-arrows">
    <div class="bottom-bar-arrow left-bottom-arrow"></div>
    <div class="bottom-bar-arrow right-bottom-arrow"></div>
  </div>

  <div class="bottom-bar-boxes-container">
    <div class="impact-boxes-wrapper">
      {{ range $index, $item := site.Data.carousel.items }}
        <div class="impact-box" data-index="{{ $index }}">
          <div class="impact-box-photo">
            <img
              src="{{ partial "helper/imgproxy" (dict "filename" $item.image "width" 200 "height" 150) }}"
              alt="{{ $item.alt }}"
              class="impact-box-image"
            />
          </div>
          <div class="impact-box-text-container">
            <div class="impact-box-tag">{{ $item.tagline }}</div>
            <div class="impact-box-text">{{ $item.short }}</div>
          </div>
        </div>
      {{ end }}
    </div>
  </div>
</div>

<script>
  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      const later = () => {
        timeout = null;
        func.apply(this, args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const carouselItems = document.querySelectorAll(".carousel-item");
    const leftArrow = document.querySelector(".left-arrow");
    const rightArrow = document.querySelector(".right-arrow");
    const bottomBarContainer = document.querySelector(
      ".bottom-bar-boxes-container",
    );
    const impactBoxes = document.querySelectorAll(".impact-box");

    let currentIndex = 0;

    function updateCarousel() {
      carouselItems.forEach((item, index) => {
        const photo = item.querySelector(".carousel-photo");
        const impactBoxImage = document.querySelector(
          `.impact-box[data-index="${index}"] .impact-box-image`,
        );

        if (index === currentIndex) {
          item.style.display = "flex";
          photo.classList.add("active");
          if (impactBoxImage) impactBoxImage.classList.add("active");
        } else {
          item.style.display = "none";
          photo.classList.remove("active");
          if (impactBoxImage) impactBoxImage.classList.remove("active");
        }
      });

      scrollToActiveBox();
      updateCarouselArrowStates();

      document
        .querySelectorAll(".impact-box-text-container")
        .forEach((container) => {
          container.classList.remove("active");
        });

      const activeImpactBox = document.querySelector(
        `.impact-box[data-index="${currentIndex}"] .impact-box-text-container`,
      );
      if (activeImpactBox) {
        activeImpactBox.classList.add("active");
      }

      updateGradients();
    }

    function updateCarouselArrowStates() {
      leftArrow.style.opacity = currentIndex === 0 ? "0.5" : "1";
      leftArrow.style.pointerEvents = currentIndex === 0 ? "none" : "auto";
      rightArrow.style.opacity =
        currentIndex === carouselItems.length - 1 ? "0.5" : "1";
      rightArrow.style.pointerEvents =
        currentIndex === carouselItems.length - 1 ? "none" : "auto";
    }

    function navigateCarousel(direction) {
      if (direction === "left" && currentIndex > 0) {
        currentIndex--;
      }
      if (direction === "right" && currentIndex < carouselItems.length - 1) {
        currentIndex++;
      }
      updateCarousel();
    }

    function scrollToActiveBox() {
      const activeBox = document.querySelector(
        `.impact-box[data-index="${currentIndex}"]`,
      );
      if (activeBox) {
        const containerLeft = bottomBarContainer.scrollLeft;
        const containerRight = containerLeft + bottomBarContainer.clientWidth;
        const boxLeft = activeBox.offsetLeft;
        const boxRight = boxLeft + activeBox.offsetWidth;

        if (boxLeft < containerLeft) {
          bottomBarContainer.scrollBy({
            left: boxLeft - containerLeft,
            behavior: "smooth",
          });
        } else if (boxRight > containerRight) {
          bottomBarContainer.scrollBy({
            left: boxRight - containerRight,
            behavior: "smooth",
          });
        }
      }
    }

    function handleBottomBoxClick(event) {
      const clickedBox = event.target.closest(".impact-box");
      if (clickedBox) {
        const index = parseInt(clickedBox.dataset.index, 10);
        if (!isNaN(index)) {
          currentIndex = index;
          updateCarousel();
        }
      }
    }

    leftArrow.addEventListener("click", () => navigateCarousel("left"));
    rightArrow.addEventListener("click", () => navigateCarousel("right"));

    impactBoxes.forEach((box) => {
      box.addEventListener("click", handleBottomBoxClick);
    });

    const leftGradient = document.querySelector(".left-gradient-box");
    const rightGradient = document.querySelector(".right-gradient-box");

    function updateGradients() {
      const scrollLeft = bottomBarContainer.scrollLeft;
      const scrollWidth = bottomBarContainer.scrollWidth;
      const clientWidth = bottomBarContainer.clientWidth;

      if (scrollLeft > 0) {
        leftGradient.style.display = "block";
      } else {
        leftGradient.style.display = "none";
      }

      if (scrollLeft + clientWidth < scrollWidth) {
        rightGradient.style.display = "block";
      } else {
        rightGradient.style.display = "none";
      }
    }

    const debouncedUpdateGradients = debounce(updateGradients, 20);

    bottomBarContainer.addEventListener("scroll", debouncedUpdateGradients);
    window.addEventListener("resize", debouncedUpdateGradients);

    updateCarousel();
    updateGradients();
  });
</script>
