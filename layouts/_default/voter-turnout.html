{{ define "main" }}
  {{ $params := partialCached "helper/page-params" .Page .RelPermalink }}
  {{ $bylineLink := "" }}
  {{ with .Param "authors" }}
    {{ if len . | eq 1 }}
      {{ $name := index . 0 }}
      {{ $author := partial "helper/get-author" $name }}
      {{ if $author.link }}
        {{ $bylineLink = $author.link }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ partial "s3-data-loader.html" . }}
  <script data-sources="{{ .Params.geojson.sources | jsonify }}">
    let sourcesParam = JSON.parse(document.currentScript.dataset.sources);

    function pollUntil(conditionCallback) {
      return new Promise((resolve) => {
        if (conditionCallback()) {
          resolve();
        } else {
          let interval;
          interval = setInterval(() => {
            if (conditionCallback()) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        }
      });
    }

    function splVoterRegGraphic() {
      return {
        apDateLabelFromMDY(mdy) {
          if (!mdy || typeof mdy !== "string") return null;
          const parts = mdy.split("/");
          if (parts.length !== 3) return null;
          const [mm, dd, yyyy] = parts.map((p) => parseInt(p, 10));
          if (!mm || !dd || !yyyy) return null;
          const months = [
            "Jan.",
            "Feb.",
            "March",
            "April",
            "May",
            "June",
            "July",
            "Aug.",
            "Sept.",
            "Oct.",
            "Nov.",
            "Dec.",
          ];
          return `${months[mm - 1] || ""} ${dd}, ${yyyy}`;
        },
        isoFromMDY(mdy) {
          if (!mdy || typeof mdy !== "string") return null;
          const parts = mdy.split("/");
          if (parts.length !== 3) return null;
          const [mm, dd, yyyy] = parts.map((p) => parseInt(p, 10));
          if (!mm || !dd || !yyyy) return null;
          const mm2 = String(mm).padStart(2, "0");
          const dd2 = String(dd).padStart(2, "0");
          return `${yyyy}-${mm2}-${dd2}`;
        },

        getPartyData() {
          const datasets = this.datasets || {};
          const counts =
            datasets.counts || datasets["Counts"] || datasets["Sheet1"];

          if (Array.isArray(counts) && counts.length > 0) {
            const row =
              counts.find(
                (r) => (r.Area || "").toLowerCase() === "pennsylvania",
              ) || counts[0];

            const num = (v) =>
              typeof v === "number"
                ? v
                : Number(
                    String(v ?? "")
                      .replace(/,/g, "")
                      .replace(/%/g, "")
                      .trim(),
                  ) || 0;

            const pct = (v) => {
              const n = num(v);
              return n > 0 && n <= 1 ? n * 100 : n;
            };

            const demTurnout = num(row["Democrats registered"]);
            const repTurnout = num(row["Republicans registered"]);
            const otherTurnout = num(row["Other party registered"]);

            const demPct = pct(row["Democratic turnout percentage"]);
            const repPct = pct(row["Republican turnout percentage"]);
            const otherPct = pct(row["Other party turnout percentage"]);

            return [
              {
                name: "Democrat",
                party: "Dem.",
                value: demTurnout,
                pct: demPct,
                color: "#009edb",
              },
              {
                name: "Republican",
                party: "Rep.",
                value: repTurnout,
                pct: repPct,
                color: "#d70000",
              },
              {
                name: "Other",
                party: "Other",
                value: otherTurnout,
                pct: otherPct,
                color: "#1b998b",
              },
            ];
          }

          const totalData = datasets["total"] || [];
          if (!Array.isArray(totalData) || totalData.length === 0) return [];
          const rows = totalData.filter((r) => r.Party && r.Party !== "Total");
          const dem = rows.find((r) => r.Party === "Democrat") || { Total: 0 };
          const rep = rows.find((r) => r.Party === "Republican") || {
            Total: 0,
          };
          const other = rows.find((r) => r.Party === "Other") || { Total: 0 };
          return [
            {
              name: "Democrat",
              party: "Dem.",
              value: typeof dem.Total === "number" ? dem.Total : 0,
              color: "#009edb",
            },
            {
              name: "Republican",
              party: "Rep.",
              value: typeof rep.Total === "number" ? rep.Total : 0,
              color: "#d70000",
            },
            {
              name: "Other",
              party: "Other",
              value: typeof other.Total === "number" ? other.Total : 0,
              color: "#1b998b",
            },
          ];
        },

        renderBarchart() {
          const container = this.$refs.barchartContainer;
          if (!container) return;

          const partyData = this.getPartyData();
          if (partyData.length === 0) return;

          const sortedData = [...partyData].sort((a, b) => b.value - a.value);

          container.innerHTML = "";
          const containerWidth = container.clientWidth;
          const containerHeight = container.clientHeight;
          if (containerWidth < 100 || containerHeight < 100) return;

          const margin = { top: 32, right: 0, bottom: 28, left: 0 };

          const width = containerWidth - margin.left - margin.right;
          const height = containerHeight - margin.top - margin.bottom;

          const PADDING_RIGHT = 0;
          const LABEL_COL_W = 0;

          const svg = d3
            .select(container)
            .append("svg")
            .attr("width", containerWidth)
            .attr("height", containerHeight)
            .style("display", "block")
            .style("max-width", "100%")
            .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          const x = d3
            .scaleLinear()
            .domain([0, 100])
            .range([0, width - PADDING_RIGHT - LABEL_COL_W]);

          const y = d3
            .scaleBand()
            .domain(sortedData.map((d) => d.name))
            .range([0, height])
            .padding(0.6)
            .paddingOuter(0);

          const gap = y.step() - y.bandwidth();

          const clampX = (val) =>
            Math.max(LABEL_COL_W, Math.min(val, width - PADDING_RIGHT));

          svg
            .selectAll(".separator")
            .data(sortedData.slice(1))
            .join("line")
            .attr("class", "separator")
            .attr("x1", 0)
            .attr("x2", width - PADDING_RIGHT)
            .attr("y1", (d) => y(d.name) - gap / 2)
            .attr("y2", (d) => y(d.name) - gap / 2)
            .attr("stroke", "#4b5563")
            .attr("stroke-width", 1)
            .attr("stroke-dasharray", "3,3");

          const bars = svg
            .selectAll(".bar")
            .data(sortedData)
            .join("g")
            .attr("class", "bar");

          bars
            .append("rect")
            .attr("x", LABEL_COL_W)
            .attr("y", (d) => y(d.name))
            .attr("width", width - PADDING_RIGHT - LABEL_COL_W)
            .attr("height", y.bandwidth())
            .attr("fill", "#e5e7eb");

          bars
            .append("rect")
            .attr("x", LABEL_COL_W)
            .attr("y", (d) => y(d.name))
            .attr("width", (d) => x(d.pct))
            .attr("height", y.bandwidth())
            .attr("fill", (d) => d.color);

          bars
            .append("text")
            .attr("x", LABEL_COL_W)
            .attr("y", (d) => y(d.name) - 6)
            .attr("text-anchor", "start")
            .attr("fill", "#ffffff")
            .attr("font-size", "20px")
            .attr("font-weight", "700")
            .text((d) => {
              if (d.name === "Democrat") return "Democratic Party";
              if (d.name === "Republican") return "Republican Party";
              if (d.name === "Other") return "Other";
            });

          bars
            .append("text")
            .attr("x", width - PADDING_RIGHT - 4)
            .attr("y", (d) => y(d.name) + y.bandwidth() + 22)
            .attr("text-anchor", "end")
            .attr("fill", "#ffffff")
            .attr("font-size", "18px")
            .attr("font-weight", "400")
            .text((d) => {
              const base = d.value.toLocaleString();
              return d.name === "Democrat" ? `${base} registered voters` : base;
            });

          bars
            .append("text")
            .attr("x", (d) => {
              const end = LABEL_COL_W + x(d.pct);
              return d.pct >= 25 ? end - 8 : end + 8;
            })
            .attr("y", (d) => y(d.name) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", (d) => (d.pct >= 25 ? "end" : "start"))
            .attr("fill", (d) => (d.pct >= 25 ? "#ffffff" : "#111111"))
            .attr("font-size", "20px")
            .attr("font-weight", "700")
            .text((d) => `${Math.round(d.pct)}%`);
        },
      };
    }
    function splPartyChart() {
      return {
        selectedParty: "democrat",
        isSearching: false,
        partyConfig: Object.freeze({
          democrat: {
            colors: Object.freeze([
              "#d4f1ff",
              "#8fd6ff",
              "#4bbcff",
              "#009eff",
              "#0079d1",
              "#005aa3",
              "#003c75",
              "#001f47",
            ]),
            labels: Object.freeze([
              "10%",
              "20%",
              "30%",
              "40%",
              "50%",
              "60%",
              "70%",
            ]),
            borderColor: "#1abeff",
          },
          republican: {
            colors: Object.freeze([
              "#ffe0e0",
              "#ffb3b3",
              "#ff8080",
              "#ff4d4d",
              "#e00000",
              "#b30000",
              "#7a0000",
              "#330000",
            ]),
            labels: Object.freeze([
              "10%",
              "20%",
              "30%",
              "40%",
              "50%",
              "60%",
              "70%",
            ]),
            borderColor: "#ff1a1a",
          },
          other: {
            colors: Object.freeze([
              "#d8fbf6",
              "#aff5ea",
              "#86efe0",
              "#5de9d6",
              "#22cdb8",
              "#199e8e",
              "#0f6f63",
              "#083934",
            ]),
            labels: Object.freeze(["1%", "2%", "3%", "4%", "5%", "6%", "7%"]),
            borderColor: "#24ccb8",
          },
        }),
      };
    }
    function splRenderData() {
      return {
        datasets: {},
        svg: null,
        selectedCounty: "Pennsylvania",
        init() {
          const onReady = (e) => {
            this.datasets = e.detail.datasets || {};
            this.render();
          };
          window.addEventListener("inspections-data-ready", onReady);
          window.addEventListener("inspections-data-updated", (e) => {
            this.datasets = (e.detail && e.detail.datasets) || this.datasets;
            this.render();
          });
          window.addEventListener("resize", () => this.render());
          window.addEventListener("county-changed", (e) => {
            this.selectedCounty = e.detail;
            this.render();
          });
          this.$nextTick(() => this.render());
        },
        parseRows() {
          let sourceData;
          if (this.selectedCounty === "Pennsylvania") {
            sourceData = this.datasets["party-year"] || [];
          } else {
            const countyYearData = this.datasets["county-year"] || [];
            sourceData = countyYearData.filter(
              (d) => d.County === this.selectedCounty,
            );
          }
          const rows = sourceData
            .map((d) => ({
              Year: +d.Year,
              Democrat: +(d.Democrat || d.Democratic || 0),
              Republican: +d.Republican,
              Other: +(d["Other Parties"] ?? d.Other ?? 0),
            }))
            .filter((d) => Number.isFinite(d.Year) && d.Year > 0);
          rows.sort((a, b) => a.Year - b.Year);
          return rows;
        },
        formatNumber(num) {
          if (num >= 1000000) {
            const millions = num / 1000000;
            return millions % 1 === 0
              ? `${millions}M`
              : `${millions.toFixed(1)}M`;
          } else if (num >= 1000) {
            const thousands = num / 1000;
            return thousands % 1 === 0
              ? `${thousands}K`
              : `${thousands.toFixed(1)}K`;
          }
          return num.toLocaleString();
        },
        render() {
          const data = this.parseRows();
          const wrap = this.$refs.wrap;
          const svg = d3.select(this.$refs.svg);
          if (!wrap || data.length === 0) {
            if (svg) svg.selectAll("*").remove();
            return;
          }
          const W = wrap.clientWidth;
          const H = 350;
          const margin = {
            top: 12,
            right: window.innerWidth < 450 ? 10 : 50,
            bottom: 30,
            left: 40,
          };
          const width = Math.max(200, W - margin.left - margin.right);
          const height = H - margin.top - margin.bottom;
          svg.selectAll("*").remove();
          svg.attr("width", W).attr("height", H);
          const g = svg
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
          const series = [
            { key: "Democrat", color: "#009edb", label: "Democrat" },
            { key: "Republican", color: "#d70000", label: "Republican" },
            { key: "Other", color: "#1b998b", label: "Other parties" },
          ];
          const x = d3
            .scaleLinear()
            .domain(d3.extent(data, (d) => d.Year))
            .range([0, width]);
          const y = d3
            .scaleLinear()
            .domain([
              0,
              d3.max(data, (d) => Math.max(d.Democrat, d.Republican, d.Other)) *
                1.05,
            ])
            .nice()
            .range([height, 0]);
          g.append("g")
            .attr("class", "y-grid")
            .attr("opacity", 0.25)
            .call(
              d3.axisLeft(y).tickSize(-width).tickFormat("").tickSizeOuter(0),
            )
            .call((g) => g.select(".domain").remove())
            .selectAll("line")
            .attr("stroke", "#9ca3af");
          const isMobile = window.innerWidth < 768;
          const xAxis = d3.axisBottom(x).tickSize(0);
          if (isMobile) {
            const allYears = data.map((d) => d.Year);
            const isVerySmall = window.innerWidth < 580;
            const filteredYears = allYears.filter((year) => {
              if (isVerySmall) {
                return year % 4 === 0;
              }
              return year % 2 === 0;
            });
            xAxis.tickValues(filteredYears);
            xAxis.tickFormat((d) =>
              d === 1998 ? "" : `'${String(d).slice(-2)}`,
            );
          } else {
            xAxis.tickFormat((d) => (d === 1998 ? "" : d3.format("d")(d)));
          }
          g.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .call((a) =>
              a
                .selectAll("text")
                .attr("font-size", 14)
                .attr("fill", "#f9f9f9")
                .attr("dy", "1em"),
            );
          g.append("g")
            .attr("class", "y-axis")
            .call(
              d3
                .axisLeft(y)
                .ticks(6)
                .tickFormat((d) =>
                  d === 0 ? "" : d3.format("~s")(d).replace("G", "B"),
                )
                .tickSize(0),
            )
            .call((a) =>
              a
                .selectAll("text")
                .attr("font-size", 14)
                .attr("fill", "#e2e2e2")
                .attr("dx", "-3"),
            )
            .call((a) => a.select(".domain").remove());
          const line = d3
            .line()
            .defined((d) => Number.isFinite(d.value))
            .x((d) => x(d.Year))
            .y((d) => y(d.value))
            .curve(d3.curveMonotoneX);
          series.forEach((s) => {
            const values = data.map((d) => ({
              Year: d.Year,
              value: d[s.key],
            }));
            g.append("path")
              .datum(values)
              .attr("fill", "none")
              .attr("stroke", s.color)
              .attr("stroke-width", 3)
              .attr("d", line);
          });
          const shortLabel = {
            Democrat: "Dem.",
            Republican: "Rep.",
            Other: "Other",
          };
          const isSmallScreen = window.innerWidth < 450;
          if (!isSmallScreen) {
            const last = data[data.length - 1];
            const labelPositions = series
              .filter((s) => Number.isFinite(last[s.key]))
              .map((s) => ({ series: s, y: y(last[s.key]) }))
              .sort((a, b) => a.y - b.y);

            const minGap = 18;
            for (let i = 1; i < labelPositions.length; i++) {
              const prev = labelPositions[i - 1];
              const curr = labelPositions[i];
              if (curr.y - prev.y < minGap) {
                curr.y = prev.y + minGap;
              }
            }

            labelPositions.forEach(({ series: s, y: adjustedY }) => {
              g.append("text")
                .attr("x", x(last.Year) + 6)
                .attr("y", adjustedY)
                .attr("dominant-baseline", "middle")
                .attr("font-weight", 700)
                .attr("font-size", 14)
                .attr("fill", s.color)
                .text(shortLabel[s.key]);
            });
          }
          const bisect = d3.bisector((d) => d.Year).left;
          const focus = g.append("g").style("display", "none");
          focus
            .append("line")
            .attr("class", "x-guide")
            .attr("y1", 0)
            .attr("y2", height)
            .attr("stroke", "#111")
            .attr("stroke-dasharray", "3,3")
            .attr("opacity", 0.4);
          const dots = {};
          series.forEach((s) => {
            dots[s.key] = focus
              .append("circle")
              .attr("r", 4.5)
              .attr("fill", s.color)
              .attr("stroke", "#fff")
              .attr("stroke-width", 1.5);
          });
          const tooltip = d3.select(this.$refs.tooltip);
          svg
            .append("rect")
            .attr("transform", `translate(${margin.left},${margin.top})`)
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "transparent")
            .style("cursor", "crosshair")
            .on("mousemove", (event) => {
              const [px] = d3.pointer(event);
              const year = x.invert(px);
              let idx = bisect(data, year);
              if (idx > 0 && idx < data.length) {
                const d0 = data[idx - 1];
                const d1 = data[idx];
                idx = year - d0.Year > d1.Year - year ? idx : idx - 1;
              } else if (idx >= data.length) {
                idx = data.length - 1;
              } else {
                idx = 0;
              }
              const d = data[idx];
              focus.style("display", null);
              focus
                .select(".x-guide")
                .attr("transform", `translate(${x(d.Year)},0)`);
              series.forEach((s) => {
                dots[s.key].attr("cx", x(d.Year)).attr("cy", y(d[s.key]));
              });
              tooltip.classed("hidden", false).html(`
       <div style='font-weight:700; margin-bottom:4px'>${d.Year}</div>
       <div>Democrat: ${d3.format(",")(d.Democrat)}</div>
       <div>Republican: ${d3.format(",")(d.Republican)}</div>
       <div>Other: ${d3.format(",")(d.Other)}</div>
       `);
              const tW = tooltip.node().offsetWidth || 140;
              const tH = tooltip.node().offsetHeight || 60;
              const tx =
                margin.left + x(d.Year) + 12 + tW > W
                  ? margin.left + x(d.Year) - 12 - tW
                  : margin.left + x(d.Year) + 12;
              const minY = Math.min(y(d.Democrat), y(d.Republican), y(d.Other));
              const ty = margin.top + minY - tH - 8;
              tooltip
                .style("left", `${Math.max(8, tx)}px`)
                .style("top", `${Math.max(8, ty)}px`);
            })
            .on("mouseleave", () => {
              focus.style("display", "none");
              tooltip.classed("hidden", true);
            });
        },
      };
    }
    function splMapData() {
      return {
        selected: "county",
        selectedParty: "democrat",
        map: null,
        geojsonData: {},
        countyData: [],
        popup: null,
        hoveredId: null,
        hoveredDistrictId: null,
        searchPopup: null,
        isSearching: false,
        async geocodeAddress(q) {
          if (!q || typeof q !== "string") return null;
          const params = new URLSearchParams({ address: q });
          const res = await fetch(
            `https://viz-sample-ballot-2024.data.spotlightpa.org/api/geolocate?${params.toString()}`,
          ).catch(() => null);
          if (!res || !res.ok) return null;
          const data = await res.json().catch(() => null);
          if (
            !data ||
            data.status !== "OK" ||
            !data.results ||
            !data.results.length
          )
            return null;
          const result = data.results[0];
          const addressComponents = result.address_components || [];
          const isJustState =
            addressComponents.length <= 2 &&
            result.types.includes("administrative_area_level_1");
          if (isJustState) return null;
          const hasPennsylvania = addressComponents.some(
            (c) =>
              c.types.includes("administrative_area_level_1") &&
              (c.short_name === "PA" || c.long_name === "Pennsylvania"),
          );
          if (!hasPennsylvania) return null;
          const hasCounty = addressComponents.some((c) =>
            c.types.includes("administrative_area_level_2"),
          );
          const hasLocality = addressComponents.some((c) =>
            c.types.includes("locality"),
          );
          const hasStreetAddress = addressComponents.some(
            (c) =>
              c.types.includes("street_number") || c.types.includes("route"),
          );
          if (!hasCounty && !hasLocality && !hasStreetAddress) return null;
          const location = result.geometry?.location;
          if (!location) return null;
          const lon = parseFloat(location.lng);
          const lat = parseFloat(location.lat);
          return Number.isFinite(lon) && Number.isFinite(lat)
            ? { lon, lat }
            : null;
        },
        isPointInRing([x, y], ring) {
          let inside = false;
          for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
            const xi = ring[i][0],
              yi = ring[i][1];
            const xj = ring[j][0],
              yj = ring[j][1];
            const intersect =
              yi > y !== yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
            if (intersect) inside = !inside;
          }
          return inside;
        },
        isPointInFeature([x, y], feature) {
          const g = feature?.geometry;
          if (!g) return false;
          if (g.type === "Polygon") {
            const [outer, ...holes] = g.coordinates;
            if (!this.isPointInRing([x, y], outer)) return false;
            return !holes.some((h) => this.isPointInRing([x, y], h));
          }
          if (g.type === "MultiPolygon") {
            return g.coordinates.some((poly) => {
              const [outer, ...holes] = poly;
              if (!this.isPointInRing([x, y], outer)) return false;
              return !holes.some((h) => this.isPointInRing([x, y], h));
            });
          }
          return false;
        },
        getFeatureBounds(feature) {
          const g = feature.geometry;
          let minX = Infinity,
            minY = Infinity,
            maxX = -Infinity,
            maxY = -Infinity;
          const walk = (coords) => {
            if (typeof coords[0] === "number") {
              const [x, y] = coords;
              if (x < minX) minX = x;
              if (y < minY) minY = y;
              if (x > maxX) maxX = x;
              if (y > maxY) maxY = y;
            } else coords.forEach(walk);
          };
          walk(g.coordinates);
          return [
            [minX, minY],
            [maxX, maxY],
          ];
        },
        getGeoJSONBounds() {
          const fc = this.geojsonData?.county;
          if (!fc?.features?.length)
            return [
              [-80.5199, 39.7198],
              [-74.6895, 42.26986],
            ];
          let minX = Infinity,
            minY = Infinity,
            maxX = -Infinity,
            maxY = -Infinity;
          fc.features.forEach((feature) => {
            const [[fMinX, fMinY], [fMaxX, fMaxY]] =
              this.getFeatureBounds(feature);
            if (fMinX < minX) minX = fMinX;
            if (fMinY < minY) minY = fMinY;
            if (fMaxX > maxX) maxX = fMaxX;
            if (fMaxY > maxY) maxY = fMaxY;
          });
          return [
            [minX, minY],
            [maxX, maxY],
          ];
        },
        findContainingFeature(lon, lat) {
          const order = [this.selected, "county"];
          for (const layer of order) {
            const fc = this.geojsonData?.[layer];
            if (!fc?.features) continue;
            const hit = fc.features.find((f) =>
              this.isPointInFeature([lon, lat], f),
            );
            if (hit) return { layerType: layer, feature: hit };
          }
          return null;
        },

        buildHoverPopupHTML(feature, layerType) {
          const partyKeyMap = {
            democrat: {
              share: "democratShare",
              total: "democratTotal",
              color: "#0079d1",
              text: "#ffffff",
              label: "Democrat",
            },
            republican: {
              share: "republicanShare",
              total: "republicanTotal",
              color: "#d70000",
              text: "#ffffff",
              label: "Republican",
            },
            other: {
              share: "otherShare",
              total: "otherTotal",
              color: "#1b998b",
              text: "#ffffff",
              label: "Other",
            },
          };
          const activeParty = this.selectedParty;
          const active = partyKeyMap[activeParty];
          const shareVal = feature.properties?.[active.share];
          const totalVal = feature.properties?.[active.total];
          const sharePct = Number.isFinite(shareVal)
            ? Math.max(0, Math.min(100, Math.round(shareVal)))
            : null;

          {
            const breaks = this.getBreaksForParty(activeParty);
            let idx = -1;
            if (Number.isFinite(sharePct)) {
              idx = breaks.findIndex((b) => sharePct < b);
              if (idx === -1) idx = breaks.length - 1;
            }
            window.dispatchEvent(
              new CustomEvent("legend-active-bin", {
                detail: { party: activeParty, index: idx },
              }),
            );
          }
          const title =
            layerType === "county"
              ? `${feature.properties?.county_nam || "County"} County`
              : feature.properties?.districtName ||
                `District ${feature.properties?.DISTRICT || ""}`;
          const others = Object.entries(partyKeyMap)
            .filter(([k]) => k !== activeParty)
            .map(([k, meta]) => ({
              label: meta.label,
              color: meta.color,
              textColor: meta.text,
              pct: Number.isFinite(feature.properties?.[meta.share])
                ? Math.max(
                    0,
                    Math.min(100, Math.round(feature.properties?.[meta.share])),
                  )
                : 0,
            }));
          const renderBar = ({ label, pct, color, textColor }) =>
            [
              "<div style='margin-top:8px;'>",
              `<span style='font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;'>${label}:</span>`,
              "<div style='position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;'>",
              `<div style='width:${pct || 0}%; background:${color}; height:100%; position:relative;'>`,
              pct >= 30
                ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${pct}%</span>`
                : "",
              "</div>",
              pct < 30
                ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${pct || 0}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${pct}%</span>`
                : "",
              "</div>",
              "</div>",
            ].join("");
          const html = [
            "<div style='padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;'>",
            `<strong style='font-size: 1.15rem; display: block; margin-bottom: 6px;'>${title}</strong>`,
            "<div style='position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;'>",
            `<div style='width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;'>`,
            sharePct !== null && sharePct >= 30
              ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${sharePct}%</span>`
              : "",
            "</div>",
            sharePct !== null && sharePct < 30
              ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${sharePct}%</span>`
              : "",
            "</div>",
            "<div style='height:6px;'></div>",
            "<span style='font-size:0.95rem; font-weight:700;'>Total:</span> ",
            `<span style='font-size:0.95rem;'>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : "â€”"}</span>`,
            "<div style='height:8px;'></div>",
            "<div style='height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;'></div>",
            renderBar(others[0]),
            renderBar(others[1]),
            "</div>",
          ].join("");
          return html;
        },
        async handleAddressSearch(query) {
          try {
            if (!query || query.trim() === "") {
              window.dispatchEvent(new CustomEvent("search-complete"));
              return;
            }
            const hit = await this.geocodeAddress(query);
            if (!hit) {
              window.dispatchEvent(new CustomEvent("search-complete"));
              const input = document.querySelector(
                "input[placeholder*=&quot;Search&quot;]",
              );
              if (input) {
                input.value = "";
                input.placeholder = "Not Found";
                setTimeout(() => {
                  input.placeholder = "Search location";
                }, 3000);
              }
              return;
            }
            const { lon, lat } = hit;
            const containing = this.findContainingFeature(lon, lat);
            if (containing) {
              const { feature, layerType } = containing;
              if (layerType !== this.selected) {
                this.selected = layerType;
                this.updateLayerVisibility?.();
              }
              this.map.fitBounds(this.getFeatureBounds(feature), {
                padding: window.innerWidth < 768 ? 20 : 32,
                maxZoom: window.innerWidth < 768 ? 8 : 10,
              });
              if (!this.popup)
                this.popup = new maplibregl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                });
              this.popup
                .setLngLat([lon, lat])
                .setHTML(this.buildHoverPopupHTML(feature, layerType))
                .addTo(this.map);
            } else {
              this.map.flyTo({ center: [lon, lat], zoom: 12 });
              if (this.popup) this.popup.remove();
            }
          } finally {
            window.dispatchEvent(new CustomEvent("search-complete"));
          }
        },
        properCase(str) {
          return str.toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
        },
        async loadGeoJSON() {
          const sources = sourcesParam;
          const [counties, house, congress, senate] = await Promise.all(
            sources.map((url) => fetch(url).then((r) => r.json())),
          );
          if (counties && counties.features) {
            counties.features.forEach((feature) => {
              if (feature.properties && feature.properties.county_nam) {
                feature.properties.county_nam = this.properCase(
                  feature.properties.county_nam,
                );
              }
              const name = feature.properties?.county_nam || "";
              feature.properties.__id = name.toLowerCase().replace(/\s+/g, "_");
            });
          }
          this.geojsonData = {
            county: counties,
            house: house,
            congressional: congress,
            senate: senate,
          };
          if (this.map && this.map.loaded()) {
            await this.joinCountyData();
            await this.joinDistrictData();
            this.setupLayers();
          }
        },

        async joinCountyData() {
          await pollUntil(
            () =>
              this.datasets &&
              (this.datasets.counts ||
                this.datasets.Counts ||
                this.datasets.Sheet1),
          );

          this.countyData =
            this.datasets.counts ||
            this.datasets.Counts ||
            this.datasets.Sheet1 ||
            [];

          if (this.geojsonData.county && this.geojsonData.county.features) {
            this.geojsonData.county.features.forEach((feature) => {
              const countyName = feature.properties.county_nam;

              const countyRecord = this.countyData.find((d) => {
                const value = d.Area || d.County || d.CountyName || d.county;
                if (!value) return false;
                return (
                  value.toLowerCase() === countyName.toLowerCase() ||
                  value.toLowerCase().replace(" county", "") ===
                    countyName.toLowerCase()
                );
              });

              if (countyRecord) {
                const toNum = (v) =>
                  typeof v === "number"
                    ? v
                    : Number(
                        String(v ?? "")
                          .replace(/,/g, "")
                          .replace(/%/g, "")
                          .trim(),
                      );

                const pct = (v) => {
                  const n = toNum(v);
                  return Number.isFinite(n)
                    ? n > 0 && n <= 1
                      ? n * 100
                      : n
                    : null;
                };

                feature.properties.democratShare = pct(
                  countyRecord["Democratic turnout percentage"],
                );
                feature.properties.republicanShare = pct(
                  countyRecord["Republican turnout percentage"],
                );
                feature.properties.otherShare = pct(
                  countyRecord["Other party turnout percentage"],
                );

                feature.properties.democratTotal =
                  Number(countyRecord["Democrats registered"]) || 0;
                feature.properties.republicanTotal =
                  Number(countyRecord["Republicans registered"]) || 0;
                feature.properties.otherTotal =
                  Number(countyRecord["Other party registered"]) || 0;
              } else {
                console.warn(`No data found for county: ${countyName}`);
              }
            });
          }
        },
        async joinDistrictData() {
          await pollUntil(
            () =>
              this.datasets &&
              (this.datasets.counts ||
                this.datasets.Counts ||
                this.datasets.Sheet1),
          );

          if (
            this.geojsonData.congressional &&
            this.geojsonData.congressional.features
          ) {
            const countsTable =
              this.datasets.counts ||
              this.datasets.Counts ||
              this.datasets.Sheet1 ||
              [];

            const toNum = (v) =>
              typeof v === "number"
                ? v
                : Number(
                    String(v ?? "")
                      .replace(/,/g, "")
                      .replace(/%/g, "")
                      .trim(),
                  );

            const pct = (v) => {
              const n = toNum(v);
              return Number.isFinite(n)
                ? n > 0 && n <= 1
                  ? n * 100
                  : n
                : null;
            };

            this.geojsonData.congressional.features.forEach((feature) => {
              const districtId = feature.properties.DISTRICT;
              const pad2 = (n) => String(Number(n)).padStart(2, "0");
              const areaCode = `USC${pad2(districtId)}`;

              const rec = countsTable.find((d) => {
                const area = (d.Area || d.District || d.DistrictCode || "")
                  .toString()
                  .trim()
                  .toUpperCase();
                return (
                  area === areaCode ||
                  area === pad2(districtId) ||
                  area === String(districtId)
                );
              });

              if (!rec) return;

              feature.properties.democratShare = pct(
                rec["Democratic turnout percentage"],
              );
              feature.properties.republicanShare = pct(
                rec["Republican turnout percentage"],
              );
              feature.properties.otherShare = pct(
                rec["Other party turnout percentage"],
              );

              feature.properties.democratTotal =
                toNum(rec["Democrats registered"]) || 0;
              feature.properties.republicanTotal =
                toNum(rec["Republicans registered"]) || 0;
              feature.properties.otherTotal =
                toNum(rec["Other party registered"]) || 0;

              feature.properties.districtName = `Congressional District ${districtId}`;
            });
          }

          if (this.geojsonData.senate && this.geojsonData.senate.features) {
            const countsTable =
              this.datasets.counts ||
              this.datasets.Counts ||
              this.datasets.Sheet1 ||
              [];

            const toNum = (v) =>
              typeof v === "number"
                ? v
                : Number(
                    String(v ?? "")
                      .replace(/,/g, "")
                      .replace(/%/g, "")
                      .trim(),
                  );

            const pct = (v) => {
              const n = toNum(v);
              return Number.isFinite(n)
                ? n > 0 && n <= 1
                  ? n * 100
                  : n
                : null;
            };

            this.geojsonData.senate.features.forEach((feature) => {
              const districtId = feature.properties.DISTRICT;
              const pad2 = (n) => String(Number(n)).padStart(2, "0");
              const areaCode = `STS${pad2(districtId)}`;

              const rec = countsTable.find((d) => {
                const area = (d.Area || d.District || d.DistrictCode || "")
                  .toString()
                  .trim()
                  .toUpperCase();
                return (
                  area === areaCode ||
                  area === pad2(districtId) ||
                  area === String(districtId)
                );
              });

              if (!rec) return;

              feature.properties.democratShare = pct(
                rec["Democratic turnout percentage"],
              );
              feature.properties.republicanShare = pct(
                rec["Republican turnout percentage"],
              );
              feature.properties.otherShare = pct(
                rec["Other party turnout percentage"],
              );

              feature.properties.democratTotal =
                toNum(rec["Democrats registered"]) || 0;
              feature.properties.republicanTotal =
                toNum(rec["Republicans registered"]) || 0;
              feature.properties.otherTotal =
                toNum(rec["Other party registered"]) || 0;

              feature.properties.districtName = `Senate District ${districtId}`;
            });
          }
          if (this.geojsonData.house && this.geojsonData.house.features) {
            const countsTable =
              this.datasets.counts ||
              this.datasets.Counts ||
              this.datasets.Sheet1 ||
              [];

            const toNum = (v) =>
              typeof v === "number"
                ? v
                : Number(
                    String(v ?? "")
                      .replace(/,/g, "")
                      .replace(/%/g, "")
                      .trim(),
                  );

            const pct = (v) => {
              const n = toNum(v);
              return Number.isFinite(n)
                ? n > 0 && n <= 1
                  ? n * 100
                  : n
                : null;
            };

            this.geojsonData.house.features.forEach((feature) => {
              const districtId = feature.properties.DISTRICT;
              const pad3 = (n) => String(Number(n)).padStart(3, "0");
              const areaCode = `STH${pad3(districtId)}`;

              const rec = countsTable.find((d) => {
                const area = (d.Area || d.District || d.DistrictCode || "")
                  .toString()
                  .trim()
                  .toUpperCase();
                return (
                  area === areaCode ||
                  area === pad3(districtId) ||
                  area === String(districtId)
                );
              });

              if (!rec) return;

              feature.properties.democratShare = pct(
                rec["Democratic turnout percentage"],
              );
              feature.properties.republicanShare = pct(
                rec["Republican turnout percentage"],
              );
              feature.properties.otherShare = pct(
                rec["Other party turnout percentage"],
              );

              feature.properties.democratTotal =
                toNum(rec["Democrats registered"]) || 0;
              feature.properties.republicanTotal =
                toNum(rec["Republicans registered"]) || 0;
              feature.properties.otherTotal =
                toNum(rec["Other party registered"]) || 0;

              feature.properties.districtName = `House District ${districtId}`;
            });
          }
        },
        getBreaksForParty(party) {
          if (party === "other") return [1, 2, 3, 4, 5, 6, 7, 999];
          return [10, 20, 30, 40, 50, 60, 70, 999];
        },
        handleDistrictHover(e, layerType) {
          if (e.features.length > 0) {
            this.map.getCanvas().style.cursor = "crosshair";
            const feature = e.features[0];
            if (
              this.hoveredDistrictId !== undefined &&
              this.hoveredDistrictId !== feature.id
            ) {
              this.map.setFeatureState(
                { source: layerType, id: this.hoveredDistrictId },
                { hover: false },
              );
            }
            this.hoveredDistrictId = feature.id;
            this.map.setFeatureState(
              { source: layerType, id: this.hoveredDistrictId },
              { hover: true },
            );
            if (!this.popup) {
              this.popup = new maplibregl.Popup({
                closeButton: false,
                closeOnClick: false,
              });
            }
            const partyKeyMap = {
              democrat: {
                share: "democratShare",
                total: "democratTotal",
                color: "#0079d1",
                text: "#ffffff",
                label: "Democrat",
              },
              republican: {
                share: "republicanShare",
                total: "republicanTotal",
                color: "#d70000",
                text: "#ffffff",
                label: "Republican",
              },
              other: {
                share: "otherShare",
                total: "otherTotal",
                color: "#1b998b",
                text: "#ffffff",
                label: "Other",
              },
            };
            const activeParty = this.selectedParty;
            const active = partyKeyMap[activeParty];
            const shareVal = feature.properties[active.share];
            const totalVal = feature.properties[active.total];
            const sharePct = Number.isFinite(shareVal)
              ? Math.max(0, Math.min(100, Math.round(shareVal)))
              : null;

            {
              const breaks = this.getBreaksForParty(activeParty);
              let idx = -1;
              if (Number.isFinite(sharePct)) {
                idx = breaks.findIndex((b) => sharePct < b);
                if (idx === -1) idx = breaks.length - 1;
              }
              window.dispatchEvent(
                new CustomEvent("legend-active-bin", {
                  detail: { party: activeParty, index: idx },
                }),
              );
            }
            const others = Object.entries(partyKeyMap)
              .filter(([k]) => k !== activeParty)
              .map(([k, meta]) => ({
                label: meta.label,
                color: meta.color,
                textColor: meta.text,
                pct: Number.isFinite(feature.properties[meta.share])
                  ? Math.max(
                      0,
                      Math.min(100, Math.round(feature.properties[meta.share])),
                    )
                  : 0,
              }));
            const districtName =
              feature.properties.districtName ||
              `District ${feature.properties.DISTRICT}`;
            const renderBar = ({ label, pct, color, textColor }) =>
              [
                "<div style='margin-top:8px;'>",
                `<span style='font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;'>${label}:</span>`,
                "<div style='position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;'>",
                `<div style='width:${pct || 0}%; background:${color}; height:100%; position:relative;'>`,
                pct >= 30
                  ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${pct}%</span>`
                  : "",
                "</div>",
                pct < 30
                  ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${pct || 0}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${pct}%</span>`
                  : "",
                "</div>",
                "</div>",
              ].join("");
            const htmlContent = [
              "<div style='padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;'>",
              `<strong style='font-size: 1.15rem; display: block; margin-bottom: 6px;'>${districtName}</strong>`,
              "<div style='position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;'>",
              `<div style='width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;'>`,
              sharePct !== null && sharePct >= 30
                ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${sharePct}%</span>`
                : "",
              "</div>",
              sharePct !== null && sharePct < 30
                ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${sharePct}%</span>`
                : "",
              "</div>",
              "<div style='height:6px;'></div>",
              "<span style='font-size:0.95rem; font-weight:700;'>Total:</span> ",
              `<span style='font-size:0.95rem;'>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : "â€”"}</span>`,
              "<div style='height:8px;'></div>",
              "<div style='height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;'></div>",
              renderBar(others[0]),
              renderBar(others[1]),
              "</div>",
            ].join("");
            this.popup.setLngLat(e.lngLat).setHTML(htmlContent).addTo(this.map);
            const popupEl = this.popup.getElement();
            popupEl.style.zIndex = "9999";
            const contentEl = popupEl.querySelector(
              ".maplibregl-popup-content",
            );
            if (contentEl) {
              contentEl.style.padding = "8px";
              contentEl.style.boxSizing = "border-box";
            }
          }
        },
        handleDistrictLeave(layerType) {
          this.map.getCanvas().style.cursor = "";
          if (this.popup) {
            this.popup.remove();
          }
          window.dispatchEvent(new Event("legend-clear"));
          if (this.hoveredDistrictId !== undefined) {
            this.map.setFeatureState(
              { source: layerType, id: this.hoveredDistrictId },
              { hover: false },
            );
            this.hoveredDistrictId = undefined;
          }
        },
        getPaletteForParty(party) {
          const cfg = {
            democrat: [
              "#d4f1ff",
              "#8fd6ff",
              "#4bbcff",
              "#009eff",
              "#0079d1",
              "#005aa3",
              "#003c75",
              "#001f47",
            ],
            republican: [
              "#ffe0e0",
              "#ffb3b3",
              "#ff8080",
              "#ff4d4d",
              "#e00000",
              "#b30000",
              "#7a0000",
              "#330000",
            ],
            other: [
              "#d8fbf6",
              "#aff5ea",
              "#86efe0",
              "#5de9d6",
              "#22cdb8",
              "#199e8e",
              "#0f6f63",
              "#083934",
            ],
          };
          return [...cfg[party]];
        },
        getSharePropKey(party) {
          return {
            democrat: "democratShare",
            republican: "republicanShare",
            other: "otherShare",
          }[party];
        },
        buildFillColorExpression(party) {
          const key = this.getSharePropKey(party);
          const breaks = this.getBreaksForParty(party);
          const colorMap = {
            democrat: [
              "#d4f1ff",
              "#8fd6ff",
              "#4bbcff",
              "#009eff",
              "#0079d1",
              "#005aa3",
              "#003c75",
              "#001f47",
            ],
            republican: [
              "#ffe0e0",
              "#ffb3b3",
              "#ff8080",
              "#ff4d4d",
              "#e00000",
              "#b30000",
              "#7a0000",
              "#330000",
            ],
            other: [
              "#d8fbf6",
              "#aff5ea",
              "#86efe0",
              "#5de9d6",
              "#22cdb8",
              "#199e8e",
              "#0f6f63",
              "#083934",
            ],
          };
          const colors = [...colorMap[party]];
          const expr = ["case", ["==", ["get", key], null], "#cccccc"];
          for (let i = 0; i < breaks.length - 1; i++) {
            expr.push(["<", ["get", key], breaks[i]], colors[i]);
          }
          expr.push(colors[colors.length - 1]);
          return JSON.parse(JSON.stringify(expr));
        },
        setupLayers() {
          if (!this.map || !this.geojsonData.county) return;
          const labelLayerId = this.map
            .getStyle()
            .layers.find(
              (l) => l.type === "symbol" && l.layout && l.layout["text-field"],
            )?.id;
          if (!this.map.getSource("counties")) {
            this.map.addSource("counties", {
              type: "geojson",
              data: this.geojsonData.county,
              promoteId: "__id",
            });
            this.map.addLayer(
              {
                id: "counties-fill",
                type: "fill",
                source: "counties",
                paint: {
                  "fill-color": this.buildFillColorExpression("democrat"),
                  "fill-opacity": 1.0,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "counties-outline",
                type: "line",
                source: "counties",
                paint: {
                  "line-color": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    "#000000",
                    "#ffffff",
                  ],
                  "line-width": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    3,
                    1,
                  ],
                },
              },
              labelLayerId,
            );
            this.map.addLayer({
              id: "counties-outline-hover",
              type: "line",
              source: "counties",
              layout: {
                "line-join": "round",
                "line-cap": "round",
              },
              paint: {
                "line-color": "#000000",
                "line-width": 4,
                "line-opacity": [
                  "case",
                  ["boolean", ["feature-state", "hover"], false],
                  1,
                  0,
                ],
              },
            });
            this.map.on("mousemove", "counties-fill", (e) => {
              if (e.features.length > 0) {
                this.map.getCanvas().style.cursor = "crosshair";
                const feature = e.features[0];
                if (this.hoveredId !== feature.id) {
                  if (this.hoveredId) {
                    this.map.setFeatureState(
                      { source: "counties", id: this.hoveredId },
                      { hover: false },
                    );
                  }
                  this.hoveredId = feature.id;
                  this.map.setFeatureState(
                    { source: "counties", id: this.hoveredId },
                    { hover: true },
                  );
                }
                if (!this.popup) {
                  this.popup = new maplibregl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                  });
                }
                const partyKeyMap = {
                  democrat: {
                    share: "democratShare",
                    total: "democratTotal",
                    color: "#0079d1",
                    text: "#ffffff",
                    label: "Democrat",
                  },
                  republican: {
                    share: "republicanShare",
                    total: "republicanTotal",
                    color: "#d70000",
                    text: "#ffffff",
                    label: "Republican",
                  },
                  other: {
                    share: "otherShare",
                    total: "otherTotal",
                    color: "#1b998b",
                    text: "#ffffff",
                    label: "Other",
                  },
                };
                const activeParty = this.selectedParty;
                const active = partyKeyMap[activeParty];
                const shareVal = feature.properties[active.share];
                const totalVal = feature.properties[active.total];
                const sharePct = Number.isFinite(shareVal)
                  ? Math.max(0, Math.min(100, Math.round(shareVal)))
                  : null;

                {
                  const breaks = this.getBreaksForParty(activeParty);
                  let idx = -1;
                  if (Number.isFinite(sharePct)) {
                    idx = breaks.findIndex((b) => sharePct < b);
                    if (idx === -1) idx = breaks.length - 1;
                  }
                  window.dispatchEvent(
                    new CustomEvent("legend-active-bin", {
                      detail: { party: activeParty, index: idx },
                    }),
                  );
                }
                const others = Object.entries(partyKeyMap)
                  .filter(([k]) => k !== activeParty)
                  .map(([k, meta]) => ({
                    label: meta.label,
                    color: meta.color,
                    textColor: meta.text,
                    pct: Number.isFinite(feature.properties[meta.share])
                      ? Math.max(
                          0,
                          Math.min(
                            100,
                            Math.round(feature.properties[meta.share]),
                          ),
                        )
                      : 0,
                  }));
                const countyName = feature.properties.county_nam;
                const renderBar = ({ label, pct, color, textColor }) =>
                  [
                    "<div style='margin-top:8px;'>",
                    `<span style='font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;'>${label}:</span>`,
                    "<div style='position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;'>",
                    `<div style='width:${pct || 0}%; background:${color}; height:100%; position:relative;'>`,
                    pct >= 30
                      ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${pct}%</span>`
                      : "",
                    "</div>",
                    pct < 30
                      ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${
                          pct || 0
                        }% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${pct}%</span>`
                      : "",
                    "</div>",
                    "</div>",
                  ].join("");
                const htmlContent = [
                  "<div style='padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;'>",
                  `<strong style='font-size: 1.15rem; display: block; margin-bottom: 6px;'>${countyName} County</strong>`,
                  "<div style='position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;'>",
                  `<div style='width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;'>`,
                  sharePct !== null && sharePct >= 30
                    ? `<span style='position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;'>${sharePct}%</span>`
                    : "",
                  "</div>",
                  sharePct !== null && sharePct < 30
                    ? `<span style='position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;'>${sharePct}%</span>`
                    : "",
                  "</div>",
                  "<div style='height:6px;'></div>",
                  "<span style='font-size:0.95rem; font-weight:700;'>Total:</span> ",
                  `<span style='font-size:0.95rem;'>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : "â€”"}</span>`,
                  "<div style='height:8px;'></div>",
                  "<div style='height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;'></div>",
                  renderBar(others[0]),
                  renderBar(others[1]),
                  "</div>",
                ].join("");
                this.popup
                  .setLngLat(e.lngLat)
                  .setHTML(htmlContent)
                  .addTo(this.map);
                const popupEl = this.popup.getElement();
                popupEl.style.zIndex = "9999";
                const contentEl = popupEl.querySelector(
                  ".maplibregl-popup-content",
                );
                if (contentEl) {
                  contentEl.style.padding = "8px";
                  contentEl.style.boxSizing = "border-box";
                }
              }
            });
            this.map.on("mouseleave", "counties-fill", () => {
              this.map.getCanvas().style.cursor = "";
              if (this.hoveredId) {
                this.map.setFeatureState(
                  { source: "counties", id: this.hoveredId },
                  { hover: false },
                );
                this.hoveredId = null;
              }
              if (this.popup) {
                this.popup.remove();
              }
              window.dispatchEvent(new Event("legend-clear"));
            });
          }
          if (!this.map.getSource("house") && this.geojsonData.house) {
            this.map.addSource("house", {
              type: "geojson",
              data: this.geojsonData.house,
              promoteId: "DISTRICT",
            });
            this.map.addLayer(
              {
                id: "house-fill",
                type: "fill",
                source: "house",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "fill-color": this.buildFillColorExpression(
                    this.selectedParty,
                  ),
                  "fill-opacity": 1.0,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "house-outline",
                type: "line",
                source: "house",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "line-color": "#ffffff",
                  "line-width": 1,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "house-outline-hover",
                type: "line",
                source: "house",
                layout: {
                  visibility: "none",
                  "line-join": "round",
                  "line-cap": "round",
                },
                paint: {
                  "line-color": "#000000",
                  "line-width": 4,
                  "line-opacity": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    1,
                    0,
                  ],
                },
              },
              labelLayerId,
            );
            this.map.on("mousemove", "house-fill", (e) => {
              if (this.selected === "house") {
                this.handleDistrictHover(e, "house");
              }
            });
            this.map.on("mouseleave", "house-fill", () => {
              if (this.selected === "house") {
                this.handleDistrictLeave("house");
              }
            });
          }
          if (
            !this.map.getSource("congressional") &&
            this.geojsonData.congressional
          ) {
            this.map.addSource("congressional", {
              type: "geojson",
              data: this.geojsonData.congressional,
              promoteId: "DISTRICT",
            });
            this.map.addLayer(
              {
                id: "congressional-fill",
                type: "fill",
                source: "congressional",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "fill-color": this.buildFillColorExpression(
                    this.selectedParty,
                  ),
                  "fill-opacity": 1.0,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "congressional-outline",
                type: "line",
                source: "congressional",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "line-color": "#ffffff",
                  "line-width": 1,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "congressional-outline-hover",
                type: "line",
                source: "congressional",
                layout: {
                  visibility: "none",
                  "line-join": "round",
                  "line-cap": "round",
                },
                paint: {
                  "line-color": "#000000",
                  "line-width": 4,
                  "line-opacity": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    1,
                    0,
                  ],
                },
              },
              labelLayerId,
            );
            this.map.on("mousemove", "congressional-fill", (e) => {
              if (this.selected === "congressional") {
                this.handleDistrictHover(e, "congressional");
              }
            });
            this.map.on("mouseleave", "congressional-fill", () => {
              if (this.selected === "congressional") {
                this.handleDistrictLeave("congressional");
              }
            });
          }
          if (!this.map.getSource("senate") && this.geojsonData.senate) {
            this.map.addSource("senate", {
              type: "geojson",
              data: this.geojsonData.senate,
              promoteId: "DISTRICT",
            });
            this.map.addLayer(
              {
                id: "senate-fill",
                type: "fill",
                source: "senate",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "fill-color": this.buildFillColorExpression(
                    this.selectedParty,
                  ),
                  "fill-opacity": 1.0,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "senate-outline",
                type: "line",
                source: "senate",
                layout: {
                  visibility: "none",
                },
                paint: {
                  "line-color": "#ffffff",
                  "line-width": 1,
                },
              },
              labelLayerId,
            );
            this.map.addLayer(
              {
                id: "senate-outline-hover",
                type: "line",
                source: "senate",
                layout: {
                  visibility: "none",
                  "line-join": "round",
                  "line-cap": "round",
                },
                paint: {
                  "line-color": "#000000",
                  "line-width": 4,
                  "line-opacity": [
                    "case",
                    ["boolean", ["feature-state", "hover"], false],
                    1,
                    0,
                  ],
                },
              },
              labelLayerId,
            );
            this.map.on("mousemove", "senate-fill", (e) => {
              if (this.selected === "senate") {
                this.handleDistrictHover(e, "senate");
              }
            });
            this.map.on("mouseleave", "senate-fill", () => {
              if (this.selected === "senate") {
                this.handleDistrictLeave("senate");
              }
            });
          }
          this.updateLayerVisibility();
        },
        updateLayerVisibility() {
          if (!this.map) return;
          const layers = {
            county: [
              "counties-fill",
              "counties-outline",
              "counties-outline-hover",
            ],
            congressional: [
              "congressional-fill",
              "congressional-outline",
              "congressional-outline-hover",
            ],
            senate: ["senate-fill", "senate-outline", "senate-outline-hover"],
            house: ["house-fill", "house-outline", "house-outline-hover"],
          };
          Object.entries(layers).forEach(([key, layerIds]) => {
            const visibility = key === this.selected ? "visible" : "none";
            layerIds.forEach((id) => {
              if (this.map.getLayer(id)) {
                this.map.setLayoutProperty(id, "visibility", visibility);
              }
            });
          });
        },
        initMap() {
          const el = this.$refs.mapCanvas;
          if (!el || this.map) return;
          const mapComponent = window.maplibreComponent({
            id: "pa-map",
            styleURL: "https://tiles.openfreemap.org/styles/positron",
            bounds: [
              [-80.5199, 39.7198],
              [-74.6895, 42.26986],
            ],
            padding: window.innerWidth < 768 ? 20 : 40,
            minZoom: 3,
            maxZoom: 18,
            zoom: 6,
            controls: ["navigation"],
            attributionCompact: true,
          });
          mapComponent.init.call({
            $refs: { canvas: el },
            map: null,
            _io: null,
            _ro: null,
            _initializing: false,
            _flyToHandler: null,
            _mobileViewHandler: null,
            _markerInstances: [],
            _baseMarkerInstances: [],
            ...mapComponent,
          });
          setTimeout(() => {
            if (window.maplibregl && window.maplibregl.Map) {
              this.map = new maplibregl.Map({
                container: el,
                style: "https://tiles.openfreemap.org/styles/positron",
                center: [-77.5, 40.9],
                zoom: window.innerWidth < 768 ? 5.5 : 6,
                minZoom: window.innerWidth < 768 ? 5 : 5.5,
                maxZoom: 18,
                maxBounds: [
                  [-83, 38],
                  [-72, 43.5],
                ],
                attributionControl: false,
                cooperativeGestures: true,
              });
              this.map.addControl(
                new maplibregl.NavigationControl({
                  showCompass: false,
                  showZoom: true,
                  visualizePitch: false,
                }),
                "top-right",
              );

              [".maplibregl-ctrl-attrib", ".mapboxgl-ctrl-attrib"].forEach(
                (sel) => {
                  document.querySelectorAll(sel).forEach((el) => el.remove());
                },
              );

              const attribCtrl = new maplibregl.AttributionControl({
                compact: true,
              });
              this.map.addControl(attribCtrl, "bottom-right");

              this.map.on("load", () => {
                setTimeout(() => {
                  if (this.map && el.offsetWidth > 0 && el.offsetHeight > 0) {
                    this.map.fitBounds(
                      [
                        [-80.5199, 39.7198],
                        [-74.6895, 42.26986],
                      ],
                      {
                        padding: window.innerWidth < 768 ? 20 : 40,
                        maxZoom: window.innerWidth < 768 ? 6 : 8,
                      },
                    );
                  }
                }, 100);
                this.map.getStyle().layers.forEach((layer) => {
                  if (
                    layer.type === "symbol" &&
                    layer.layout &&
                    layer.layout["text-field"]
                  ) {
                    this.map.setPaintProperty(
                      layer.id,
                      "text-halo-color",
                      "#ffffff",
                    );
                    this.map.setPaintProperty(layer.id, "text-halo-width", 2.5);
                    this.map.setPaintProperty(layer.id, "text-halo-blur", 0.5);
                    this.map.setPaintProperty(
                      layer.id,
                      "text-color",
                      "#111111",
                    );
                  }
                });
                Promise.all([
                  this.joinCountyData(),
                  this.joinDistrictData(),
                ]).then(() => {
                  this.setupLayers();
                  if (this.map.getLayer("counties-fill")) {
                    this.map.setPaintProperty(
                      "counties-fill",
                      "fill-color",
                      this.buildFillColorExpression(this.selectedParty),
                    );
                  }
                  if (this.map && el.offsetWidth > 0 && el.offsetHeight > 0) {
                    try {
                      this.map.fitBounds(this.getGeoJSONBounds(), {
                        padding: window.innerWidth < 768 ? 20 : 40,
                        maxZoom: window.innerWidth < 768 ? 6 : 8,
                        duration: 0,
                      });
                    } catch (e) {
                      console.warn("Could not fit bounds, will retry", e);
                      setTimeout(() => {
                        if (this.map) {
                          this.map.fitBounds(this.getGeoJSONBounds(), {
                            padding: window.innerWidth < 768 ? 20 : 40,
                            maxZoom: window.innerWidth < 768 ? 6 : 8,
                            duration: 0,
                          });
                        }
                      }, 200);
                    }
                  }
                });
                this.map.getCanvas().addEventListener("mouseleave", () => {
                  window.dispatchEvent(new Event("legend-clear"));
                });
              });
              this.loadGeoJSON();
            }
          }, 100);
        },
      };
    }
  </script>
  <div
    class="grid min-h-screen w-screen grid-cols-1 grid-rows-[auto_minmax(300px,auto)_minmax(500px,1fr)_auto_auto] lg:grid-cols-12 lg:grid-rows-[repeat(4,minmax(0,1fr))_auto_auto_auto]"
    x-data="{...s3DataLoader(), ...splVoterRegGraphic() }"
    x-init="init()"
  >
    <div
      class="order-1 col-span-1 row-span-1 flex flex-col items-start justify-center bg-black px-6 pt-6 text-white lg:col-span-5 lg:row-span-2 lg:px-12 lg:pt-12"
    >
      {{ with .Param "kicker" }}
        <p class="font-sans font-bold uppercase text-yellow">{{ . }}</p>
      {{ end }}
      <h1 class="my-4 font-serif text-3xl uppercase leading-hed lg:text-4xl">
        {{ .Title }}
      </h1>
      {{ with .Param "dek" }}
        <p class="mb-4 text-2xl">{{ . }}</p>
      {{ else }}
        {{ with .Description }}
          <p class="mb-4 text-2xl">{{ . }}</p>
        {{ end }}
      {{ end }}
      {{ with $params.byline }}
        <p class="text-base font-light">
          <span>by</span>
          <span class="font-semibold">
            {{ if $bylineLink }}
              <a href="{{ $bylineLink }}">{{ . }}</a>
            {{ else }}
              {{ . }}
            {{ end }}
          </span>
          {{ if and (not $params.evergreen) $params.published }}
            {{ $display := $.Param "display-date" }}
            {{ $published := $.Param "published" }}
            {{ if $display }}
              <span
                >| <time datetime="{{ $published }}">{{ $display }}</time></span
              >
            {{ end }}
          {{ end }}
        </p>
      {{ end }}
      {{ if not $params.evergreen | and $params.published }}
        <a
          href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-2 block"
        >
          <span class="font-semibold">Source:</span> TKTK Pennsylvania
          Department of State
        </a>
      {{ end }}
    </div>
    <div
      class="order-3 col-span-1 row-span-1 flex flex-col overflow-visible bg-black p-4 max-[440px]:pb-4 lg:order-2 lg:col-span-7 lg:row-span-4 lg:px-4 lg:pb-4 lg:pr-12 lg:pt-12"
      @search-complete.window="isSearching = false"
      x-data="splPartyChart()"
    >
      <div
        class="mb-4 grid w-full grid-cols-1 items-stretch gap-3 sm:grid-cols-2"
      >
        <div class="relative h-full">
          <select
            @change="window.dispatchEvent(new CustomEvent('party-changed', { detail: $event.target.value }))"
            x-model="selectedParty"
            :style="`border-color: ${partyConfig[selectedParty].borderColor};`"
            class="h-full w-full cursor-pointer appearance-none rounded-lg border-[3px] bg-white px-4 py-3.5 pr-12 text-base font-semibold text-black shadow-lg transition-all duration-200 hover:shadow-xl focus:outline-none focus:ring-0"
          >
            <option value="democrat">Democrat</option>
            <option value="republican">Republican</option>
            <option value="other">Other</option>
          </select>
          <div
            class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4"
          >
            <svg
              class="text-gray-700 h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </div>
        </div>
        <form
          @submit.prevent="isSearching = true; window.dispatchEvent(new CustomEvent('search-submitted', { detail: { query: $refs.addressSearch.value } }))"
          class="relative h-full"
        >
          <input
            x-ref="addressSearch"
            type="text"
            placeholder="Search location"
            class="placeholder-gray-5 h-full w-full rounded-lg border-[3px] border-g-4 bg-white px-4 py-3.5 pr-12 text-base font-semibold text-black shadow-lg transition-all duration-200 hover:shadow-xl focus:outline-none focus:ring-0"
          />
          <button
            type="submit"
            class="absolute inset-y-0 right-0 flex items-center pr-4 text-g-7 hover:opacity-80 focus:outline-none"
            title="Search"
          >
            <svg
              x-show="!isSearching"
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"
              />
            </svg>
            <svg
              x-show="isSearching"
              class="h-5 w-5 animate-spin"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </button>
        </form>
      </div>
      <div class="relative mb-10 w-full">
        <div
          x-ref="legend"
          class="flex h-6 w-full gap-[1px] rounded-sm border border-g-1 bg-g-1"
          x-init="
            const highlight = (idx) => {
            const bins = $refs.legend.querySelectorAll('.legend-bin');
            const clear = idx == null || idx < 0 || Number.isNaN(idx);
            bins.forEach((b, i) => {
            const active = !clear && i === idx;
            b.style.outline = active ? '4px solid #fff' : '';
            b.style.outlineOffset = '-2px';
            b.style.opacity = clear ? '1' : (active ? '1' : '0.4');
            b.style.transition = 'opacity 0.15s ease, outline 0.15s ease';
            });
            };
            window.addEventListener('legend-active-bin', (e) => {
            if (e.detail.party !== selectedParty) return;
            highlight(e.detail.index);
            });
            window.addEventListener('legend-clear', () => {
            const bins = $refs.legend.querySelectorAll('.legend-bin');
            bins.forEach(b => {
            b.style.outline = '';
            b.style.opacity = '1';
            });
            });
            "
        >
          <template
            x-for="(color, index) in partyConfig[selectedParty].colors"
            :key="index"
          >
            <div
              class="legend-bin flex-1"
              :style="`background-color: ${color}`"
            ></div>
          </template>
        </div>
        <div
          class="absolute left-0 top-6 w-full text-base font-extrabold text-white"
        >
          <span
            class="absolute left-[12.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[0]"
          ></span>
          <span
            class="absolute left-[25%] hidden -translate-x-1/2 min-[460px]:block"
            x-text="partyConfig[selectedParty].labels[1]"
          ></span>
          <span
            class="absolute left-[37.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[2]"
          ></span>
          <span
            class="absolute left-[50%] hidden -translate-x-1/2 min-[460px]:block"
            x-text="partyConfig[selectedParty].labels[3]"
          ></span>
          <span
            class="absolute left-[62.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[4]"
          ></span>
          <span
            class="absolute left-[75%] hidden -translate-x-1/2 min-[460px]:block"
            x-text="partyConfig[selectedParty].labels[5]"
          ></span>
          <span
            class="absolute left-[87.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[6]"
          ></span>
        </div>
      </div>
      <div
        class="max-[440px] relative h-full w-full"
        @search-submitted.window="handleAddressSearch((($event.detail?.query || '').trim() ? ($event.detail.query.trim() + ', Pennsylvania') : ''))"
        x-data="splMapData()"
        x-init="
         initMap();
         $watch('selected', () => {
         updateLayerVisibility();
         window.dispatchEvent(new Event('legend-clear'));
         });
         window.addEventListener('party-changed', (e) => {
         selectedParty = e.detail;
         if (map) {
         ['counties-fill', 'congressional-fill', 'senate-fill', 'house-fill'].forEach(layerId => {
         if (map.getLayer(layerId)) {
         map.setPaintProperty(layerId, 'fill-color', buildFillColorExpression(selectedParty));
         }
         });
         window.dispatchEvent(new Event('legend-clear'));
         }
         });
         "
      >
        <div
          x-ref="mapCanvas"
          class="absolute inset-0 h-full w-full max-[440px]:top-[44px]"
          style="overflow: visible"
        ></div>
        <div
          class="absolute right-[50px] top-[10px] z-20 flex overflow-hidden rounded-md border border-g-3 bg-white shadow max-[440px]:left-0 max-[440px]:right-0 max-[440px]:top-0 max-[440px]:h-11 max-[440px]:w-full max-[440px]:rounded-b-none max-[440px]:border-b-0 max-[440px]:shadow-none"
        >
          <button
            :data-checked="selected === 'county'"
            @click="selected='county'"
            title="County"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2 max-[440px]:flex-1"
          >
            <span class="max-[440px]:hidden">Counties</span
            ><span class="hidden max-[440px]:inline">County</span>
          </button>
          <button
            :data-checked="selected === 'congressional'"
            @click="selected='congressional'"
            title="Congressional"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2 max-[440px]:flex-1"
          >
            <span class="max-[440px]:hidden">Congressional</span
            ><span class="hidden max-[440px]:inline">Congress</span>
          </button>
          <button
            :data-checked="selected === 'senate'"
            @click="selected='senate'"
            title="Senate"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2 max-[440px]:flex-1"
          >
            Senate
          </button>
          <button
            :data-checked="selected === 'house'"
            @click="selected='house'"
            title="House"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2 max-[440px]:flex-1"
          >
            House
          </button>
        </div>
      </div>
    </div>
    <div
      class="order-2 col-span-1 row-span-1 bg-black p-4 lg:order-3 lg:col-span-5 lg:row-span-2 lg:pb-2 lg:pl-12 lg:pr-2"
      x-ref="barchartContainer"
      x-show="datasets && ((((datasets.counts || datasets['counts_Sheet1'] || datasets['Counts'] || datasets['Sheet1']) || []).length > 0) || (datasets.total && datasets.total.length > 0))"
      x-init="
          window.addEventListener('inspections-data-ready', () => { $nextTick(() => renderBarchart()); });
          $watch('datasets', () => {
            const counts = (datasets && (datasets.counts || datasets['counts_Sheet1'] || datasets['Counts'] || datasets['Sheet1'])) || [];
            if ((counts.length > 0) || (datasets && datasets.total && datasets.total.length > 0)) {
              $nextTick(() => renderBarchart());
            }
          });
          window.addEventListener('resize', () => {
            const counts = (datasets && (datasets.counts || datasets['counts_Sheet1'] || datasets['Counts'] || datasets['Sheet1'])) || [];
            if ((counts.length > 0) || (datasets && datasets.total && datasets.total.length > 0)) {
              renderBarchart();
            }
          });
  "
    ></div>

    <div
      class="order-4 col-span-1 row-span-1 bg-black px-4 py-6 max-[440px]:pt-16 lg:col-span-12 lg:row-span-2 lg:px-12 lg:py-8 lg:pb-20"
      x-data="{ selectedCounty: 'Pennsylvania' }"
    >
      <div class="flex h-[76px] w-full">
        <div
          class="justify-left hidden h-full w-1/2 items-center rounded-tl-lg bg-g-9 px-8 pb-4 pt-8 font-serif text-2xl font-semibold text-white md:flex"
        >
          Voter registration over time
        </div>
        <div
          class="flex h-full w-full items-center rounded-tr-lg bg-g-9 px-3 pt-4 max-[849px]:rounded-tl-lg md:w-1/2"
        >
          <div
            class="relative flex h-full w-full items-center justify-end bg-g-9"
          >
            <select
              x-model="selectedCounty"
              @change="$dispatch('county-changed', selectedCounty)"
              class="h-full w-full cursor-pointer appearance-none rounded-lg border-[2px] border-g-8 bg-black px-4 py-3.5 pr-12 text-base font-semibold text-g-4 transition-all duration-200 focus:outline-none focus:ring-0 md:w-3/5"
            >
              <option value="Pennsylvania">Pennsylvania</option>
              <option value="Adams">Adams</option>
              <option value="Allegheny">Allegheny</option>
              <option value="Armstrong">Armstrong</option>
              <option value="Beaver">Beaver</option>
              <option value="Bedford">Bedford</option>
              <option value="Berks">Berks</option>
              <option value="Blair">Blair</option>
              <option value="Bradford">Bradford</option>
              <option value="Bucks">Bucks</option>
              <option value="Butler">Butler</option>
              <option value="Cambria">Cambria</option>
              <option value="Cameron">Cameron</option>
              <option value="Carbon">Carbon</option>
              <option value="Centre">Centre</option>
              <option value="Chester">Chester</option>
              <option value="Clarion">Clarion</option>
              <option value="Clearfield">Clearfield</option>
              <option value="Clinton">Clinton</option>
              <option value="Columbia">Columbia</option>
              <option value="Crawford">Crawford</option>
              <option value="Cumberland">Cumberland</option>
              <option value="Dauphin">Dauphin</option>
              <option value="Delaware">Delaware</option>
              <option value="Elk">Elk</option>
              <option value="Erie">Erie</option>
              <option value="Fayette">Fayette</option>
              <option value="Forest">Forest</option>
              <option value="Franklin">Franklin</option>
              <option value="Fulton">Fulton</option>
              <option value="Greene">Greene</option>
              <option value="Huntingdon">Huntingdon</option>
              <option value="Indiana">Indiana</option>
              <option value="Jefferson">Jefferson</option>
              <option value="Juniata">Juniata</option>
              <option value="Lackawanna">Lackawanna</option>
              <option value="Lancaster">Lancaster</option>
              <option value="Lawrence">Lawrence</option>
              <option value="Lebanon">Lebanon</option>
              <option value="Lehigh">Lehigh</option>
              <option value="Luzerne">Luzerne</option>
              <option value="Lycoming">Lycoming</option>
              <option value="Mckean">McKean</option>
              <option value="Mercer">Mercer</option>
              <option value="Mifflin">Mifflin</option>
              <option value="Monroe">Monroe</option>
              <option value="Montgomery">Montgomery</option>
              <option value="Montour">Montour</option>
              <option value="Northampton">Northampton</option>
              <option value="Northumberland">Northumberland</option>
              <option value="Perry">Perry</option>
              <option value="Philadelphia">Philadelphia</option>
              <option value="Pike">Pike</option>
              <option value="Potter">Potter</option>
              <option value="Schuylkill">Schuylkill</option>
              <option value="Snyder">Snyder</option>
              <option value="Somerset">Somerset</option>
              <option value="Sullivan">Sullivan</option>
              <option value="Susquehanna">Susquehanna</option>
              <option value="Tioga">Tioga</option>
              <option value="Union">Union</option>
              <option value="Venango">Venango</option>
              <option value="Warren">Warren</option>
              <option value="Washington">Washington</option>
              <option value="Wayne">Wayne</option>
              <option value="Westmoreland">Westmoreland</option>
              <option value="Wyoming">Wyoming</option>
              <option value="York">York</option>
            </select>
            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4"
            >
              <svg
                class="h-5 w-5 text-g-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </div>
          </div>
        </div>
      </div>
      <div
        class="flex hidden items-center justify-center gap-4 bg-g-9 px-3 pt-4 max-[449px]:flex"
      >
        <div class="flex items-center gap-1.5">
          <div class="h-1 w-8 bg-[#009edb]"></div>
          <span class="text-sm font-semibold text-white">Dem.</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="h-1 w-8 bg-[#d70000]"></div>
          <span class="text-sm font-semibold text-white">Rep.</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="h-1 w-8 bg-[#1b998b]"></div>
          <span class="text-sm font-semibold text-white">Other</span>
        </div>
      </div>
      <div x-data="splRenderData()" class="w-full rounded-b-lg bg-g-9 p-4">
        <div x-ref="wrap" class="relative h-[350px] w-full overflow-x-auto">
          <svg x-ref="svg"></svg>
          <div
            x-ref="tooltip"
            class="pointer-events-none absolute hidden rounded bg-black/90 px-2 py-1 text-xs font-semibold text-white shadow"
          ></div>
        </div>
      </div>
    </div>

    <div
      class="order-5 col-span-1 row-span-1 bg-white px-4 py-8 lg:col-span-12 lg:px-12 lg:py-12"
    >
      <div class="mx-auto w-full max-w-7xl">
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 lg:gap-12">
          <div
            class="article-content font-serif leading-relaxed lg:col-span-2 lg:border-r-[2px] lg:border-g-4 lg:pr-8"
          >
            <h1
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              About the Data
            </h1>
            <p class="mb-4">
              The data comes from the
              <a
                href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics#accordion-6cb6ca8a99-item-df8c67bfea"
              >
                official website of the Commonwealth of Pennsylvania</a
              >, using the state's Voting & Election Statistics data.
              <br /><br />
              The maps shows the total number of registered voters in each
              county, broken down by political party. The â€œNo partyâ€ column
              includes only voters whose registration lists â€œNo affiliationâ€
              exactly. It does not include voters whose party field is blank or
              listed as â€œnoneâ€ or another unaffiliated designation.
              <br /><br />
              Historical data is compiled from totals reported each November,
              using only party categories that have appeared consistently over
              the years.
            </p>
            <div class="my-8 flex justify-center">
              <hr
                class="w-24 rounded-full border-t-4 border-yellow shadow-sm"
              />
            </div>
            <h1
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              Frequently Asked Questions
            </h1>
            <h2
              class="mx-auto mt-4 w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              How do I register to vote?
            </h2>
            <p class="mb-4">
              To register to vote in Pennsylvania, you can complete a voter
              registration application online, by mail, or in person at various
              government agencies, including Pennsylvania Department of
              Transportation (PennDOT) photo license and driver's license
              centers, and your county election office. The deadline to register
              is typically 15 days before the election. If you do not register,
              you will not be able to vote.
            </p>
            <h2
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              How do I check my voter registration?
            </h2>
            <p class="mb-4">
              To check your voter registration in Pennsylvania, you can visit
              the Department of State's website. There, you can look up your
              status by name or driver's license / PennDOT ID number.
            </p>
            <h2
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              Can I switch my party registration before the election?
            </h2>
            <p class="mb-4">
              In Pennsylvania, you can switch your party registration at any
              time. However, if you want the change to take effect for an
              upcoming election, you must do so at least 15 days before that
              election. If you make the change within 15 days of the election,
              it will take effect for the next election cycle. To change your
              party affiliation, fill out a voter registration form and select
              the box indicating a "change of party."
            </p>
            <h2
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              Can I vote if Iâ€™m registered independent or not registered with a
              party?
            </h2>
            <p class="mb-4">
              Voters unaffiliated with a specific political party are able to
              vote in elections in Pennsylvania, with the exception of primary
              elections, because Pennsylvania has a closed primary system.
              However, such voters can still participate in statewide referenda,
              local ballot initiatives, and special elections that coincide with
              the primaries. All registered voters can participate in general
              elections.
            </p>
            <h2
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              Can I vote if my registration is inactive?
            </h2>
            <p class="mb-4">
              If your voter registration is marked as inactive, you can still
              vote. A voter is marked inactive if they have not voted for two
              consecutive federal election cycles and havenâ€™t responded to a
              county notice about their registration. If thatâ€™s your status, you
              can still vote on election day. Youâ€™ll just have to sign a form
              confirming your eligibility when you visit your polling place.
            </p>
            <div class="my-8 flex justify-center">
              <hr
                class="w-24 rounded-full border-t-4 border-yellow shadow-sm"
              />
            </div>
            <h1
              class="mx-auto w-0 min-w-full font-sans text-xl font-semibold md:text-2xl md:leading-tight"
            >
              Need Help?
            </h1>
            <p class="mb-4">
              If you have any questions or need assistance with voting, you can
              reach out to the
              <a href="https://www.pa.gov/agencies/vote">
                Pennsylvania Department of State</a
              >
              for guidance.
            </p>
          </div>
          <div class="lg:col-span-1">
            <div class="rounded-lg bg-g-1 p-6">
              <h3 class="mb-2 font-sans text-xl font-bold md:text-2xl">
                Election Resources
              </h3>
              <div class="space-y-3">
                <a
                  href="https://www.pavoterservices.pa.gov/pages/VoterRegistrationApplication.aspx"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">ðŸ—³ï¸</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Register to vote</span
                  >
                </a>
                <a
                  href="https://www.spotlightpa.org/pennsylvania-voter-registration/"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">ðŸ“Š</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Track voter registration</span
                  >
                </a>
                <a
                  href="https://www.pavoterservices.pa.gov/pages/voterregistrationstatus.aspx"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">ðŸ“</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Check your registration status</span
                  >
                </a>
                <a
                  href="https://www.pavoterservices.pa.gov/Pages/PollingPlaceInfo.aspx"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">ðŸ“</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Find your polling place</span
                  >
                </a>
                <a
                  href="https://www.pavoterservices.pa.gov/OnlineAbsenteeApplication/#/OnlineMailInBegin"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">âœ‰ï¸</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Request a mail ballot</span
                  >
                </a>
                <a
                  href="https://www.vote.pa.gov/resources/pages/contact-your-election-officials.aspx"
                  class="flex items-center text-black transition-colors hover:text-blue"
                >
                  <span class="mr-2">ðŸ“±</span>
                  <span class="font-bold font-semibold text-blue hover:text-g-6"
                    >Contact your county election office</span
                  >
                </a>
              </div>
            </div>

            {{ with site.GetPage "topics/elections" }}
              {{ $stories := (where .RegularPages "Date" ">" (time "2024-12-31")) | first 4 }}
              <div class="mt-6 rounded-lg bg-g-1 p-6">
                <h3 class="mb-2 font-sans text-xl font-bold md:text-2xl">
                  More Election Coverage
                </h3>
                <ul class="space-y-3">
                  {{ range $stories }}
                    <li>
                      <a
                        href="{{ .RelPermalink }}"
                        class="flex items-start text-black transition-colors hover:text-blue"
                      >
                        <span class="mr-2">ðŸ“°</span>
                        <span class="font-semibold">
                          {{ .Title }}
                          <span class="block text-sm font-normal text-g-7">
                            {{ .Date | time.Format "Jan. 2, 2006" }}
                          </span>
                        </span>
                      </a>
                    </li>
                  {{ end }}
                  <li>
                    <a
                      href="/elections/#coverage"
                      class="flex items-center text-black transition-colors hover:text-blue"
                    >
                      <span class="font-bold">See all election stories â†’</span>
                    </a>
                  </li>
                </ul>
              </div>
            {{ end }}
            <div
              class="mt-6 rounded-lg bg-g-1 p-6"
              id="credits"
              data-ga-category="credits"
            >
              <h3 class="mb-2 font-sans text-xl font-bold md:text-2xl">
                Credits
              </h3>
              <div class="mt-4 flex flex-col gap-4">
                {{ .Params.credits | markdownify }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{{ end }}
{{ define "extra-head" }}
  {{ partial "header/maplibre.html" . }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
{{ end }}
{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}
