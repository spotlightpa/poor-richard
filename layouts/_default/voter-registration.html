{{ define "main" }}

  {{ $params := partialCached "helper/page-params" .Page .RelPermalink }}
  {{ $bylineLink := "" }}
  {{ with .Param "authors" }}
    {{ if len . | eq 1 }}
      {{ $name := index . 0 }}
      {{ $author := partial "helper/get-author" $name }}
      {{ if $author.link }}
        {{ $bylineLink = $author.link }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ partial "s3-data-loader.html" . }}


  <div
    class="grid h-screen w-screen grid-cols-12 grid-rows-6"
    x-data="{
      ...s3DataLoader(),
      
      getPartyData() {
        const datasets = this.datasets || {};
        const totalData = datasets['total'] || [];
        
        if (!Array.isArray(totalData) || totalData.length === 0) {
          return [];
        }
        
        const rows = totalData.filter(r => r.Party && r.Party !== 'Total');
        
        const dem = rows.find(r => r.Party === 'Democrat') || { Total: 0 };
        const rep = rows.find(r => r.Party === 'Republican') || { Total: 0 };
        const noParty = rows.find(r => r.Party === 'No Affiliation') || { Total: 0 };
        const other = rows.find(r => r.Party === 'Other') || { Total: 0 };

        return [
          { 
            name: 'Democrat',
            party: 'Dem.', 
            value: typeof dem.Total === 'number' ? dem.Total : 0, 
            color: '#009edb'
          },
          { 
            name: 'Republican',
            party: 'Rep.', 
            value: typeof rep.Total === 'number' ? rep.Total : 0, 
            color: '#d70000'
          },
          { 
            name: 'No Affiliation',
            party: 'No Party', 
            value: typeof noParty.Total === 'number' ? noParty.Total : 0, 
            color: '#ffcb03'
          },
          { 
            name: 'Other',
            party: 'Other', 
            value: typeof other.Total === 'number' ? other.Total : 0, 
            color: '#1b998b'
          }
        ];
      },

      renderTreemap() {
        const container = this.$refs.treemapContainer;
        if (!container) return;

        const partyData = this.getPartyData();
        if (partyData.length === 0) return;

        const sortedData = [...partyData].sort((a, b) => b.value - a.value);
        
        container.innerHTML = '';

        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;
        
        if (containerWidth < 100 || containerHeight < 100) {
          return;
        }

        const margin = { top: 0, right: 80, bottom: 10, left: 0 };
        const width = containerWidth - margin.left - margin.right;
        const height = containerHeight - margin.top - margin.bottom;

        const svg = d3.select(container)
          .append('svg')
          .attr('width', containerWidth)
          .attr('height', containerHeight)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const labelWidth = 80;
        const x = d3.scaleLinear()
          .domain([0, d3.max(sortedData, d => d.value)])
          .range([labelWidth, width]);

        const y = d3.scaleBand()
          .domain(sortedData.map(d => d.name))
          .range([0, height])
          .padding(0.3)
          .paddingOuter(0.15);

        const gap = y.step() - y.bandwidth();
        svg.selectAll('.separator')
          .data(sortedData.slice(1))
          .join('line')
          .attr('class', 'separator')
          .attr('x1', 0)
          .attr('x2', width)
          .attr('y1', d => y(d.name) - gap / 2)
          .attr('y2', d => y(d.name) - gap / 2)
          .attr('stroke', '#4b5563')
          .attr('stroke-width', 1)
          .attr('stroke-dasharray', '3,3');

        const bars = svg.selectAll('.bar')
          .data(sortedData)
          .join('g')
          .attr('class', 'bar');

        bars.append('rect')
          .attr('x', labelWidth)
          .attr('y', d => y(d.name))
          .attr('width', d => Math.max(0, x(d.value) - labelWidth))
          .attr('height', y.bandwidth())
          .attr('fill', d => d.color);

        bars.append('text')
          .attr('x', 0)
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', 'start')
          .attr('fill', '#ffffff')
          .attr('font-size', '16px')
          .attr('font-weight', '700')
          .text(d => d.party);

        bars.append('text')
          .attr('x', d => {
            const barWidth = x(d.value) - labelWidth;
            if (d.value < 1500000) {
              return x(d.value) + 12;
            } else {
              return x(d.value) - 12;
            }
          })
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', d => d.value < 1500000 ? 'start' : 'end')
          .attr('fill', '#ffffff')
          .attr('font-size', '18px')
          .attr('font-weight', '700')
          .text(d => d.value.toLocaleString());
      }
    }"
    x-init="init()"
  >
    <div
      class="col-span-5 row-span-2 flex flex-col items-start justify-center bg-black p-12 text-white"
    >
      {{ with .Param "kicker" }}
        <p class="font-sans font-bold uppercase text-yellow">
          {{ . }}
        </p>
      {{ end }}


      <h1 class="mt-2 font-serif text-3xl uppercase leading-hed lg:text-4xl">
        {{ .Title }}
      </h1>

      {{ with .Param "dek" }}
        <p class="mb-4 text-2xl">{{ . }}</p>
      {{ else }}
        {{ with .Description }}
          <p class="mb-4 text-2xl">{{ . }}</p>
        {{ end }}
      {{ end }}

      {{ with $params.byline }}
        <p class="text-base font-light">
          <span>by</span>
          <span class="font-semibold">
            {{ if $bylineLink }}
              <a href="{{ $bylineLink }}">{{ . }}</a>
            {{ else }}
              {{ . }}
            {{ end }}
          </span>
          {{ if not $params.evergreen | and $params.published }}
            <span>
              | Last updated:
              <time datetime="{{ $params.publishedISO }}"
                >{{ $params.published }}</time
              >
            </span>
          {{ end }}
        </p>
      {{ end }}

      {{ if not $params.evergreen | and $params.published }}
        <a
          href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-2 block font-semibold"
        >
          Source: Pennsylvania Department of State
        </a>
      {{ end }}
    </div>

    <div
      class="col-span-7 row-span-4 flex flex-col overflow-hidden bg-black px-4 pb-4 pt-12"
      x-data="{
    selectedParty: 'democrat',
    partyConfig: {
      democrat: {
        colors: ['#94e1ff', '#6bd5ff', '#42caff', '#1abeff', '#00acf0', '#008fc7', '#00719e', '#005475'],
        labels: ['10%', '20%', '30%', '40%', '50%', '60%', '70%'],
        borderColor: '#1abeff'
      },
      republican: {
        colors: ['#ff9494', '#ff6b6b', '#ff4242', '#ff1a1a', '#f00000', '#c70000', '#9e0000', '#750000'],
        labels: ['10%', '20%', '30%', '40%', '50%', '60%', '70%'],
        borderColor: '#ff1a1a'
      },
      'no-party': {
        colors: ['#ffea94', '#ffe16b', '#ffd942', '#ffd11a', '#f0c000', '#c79f00', '#9e7e00', '#755e00'],
        labels: ['3%', '6%', '9%', '12%', '15%', '18%', '21%'],
        borderColor: '#f0c000'
      },
      other: {
        colors: ['#a4efe6', '#81e9dd', '#5fe3d3', '#3cddca', '#24ccb8', '#1ea999', '#188679', '#12645a'],
        labels: ['1%', '2%', '3%', '4%', '5%', '6%', '7%'],
        borderColor: '#24ccb8'
      }
    }
  }"
    >
      <div class="relative mb-4 w-full">
        <select
          x-model="selectedParty"
          :style="`border-color: ${partyConfig[selectedParty].borderColor};`"
          class="w-full cursor-pointer appearance-none rounded-lg border-[3px] bg-white px-4 py-3.5 pr-12 text-base font-semibold text-black shadow-lg transition-all duration-200 hover:shadow-xl focus:outline-none focus:ring-0"
        >
          <option value="democrat">Democrats</option>
          <option value="republican">Republicans</option>
          <option value="no-party">No Party</option>
          <option value="other">Other</option>
        </select>
        <div
          class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4"
        >
          <svg
            class="text-gray-700 h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </div>
      </div>

      <div class="relative mb-10 w-full">
        <div class="flex h-5 w-full gap-[1px] bg-black">
          <template
            x-for="(color, index) in partyConfig[selectedParty].colors"
            :key="index"
          >
            <div class="flex-1" :style="`background-color: ${color}`"></div>
          </template>
        </div>
        <div
          class="absolute left-0 top-6 w-full text-base font-extrabold text-white"
        >
          <span
            class="absolute left-[12.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[0]"
          ></span>
          <span
            class="absolute left-[25%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[1]"
          ></span>
          <span
            class="absolute left-[37.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[2]"
          ></span>
          <span
            class="absolute left-[50%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[3]"
          ></span>
          <span
            class="absolute left-[62.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[4]"
          ></span>
          <span
            class="absolute left-[75%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[5]"
          ></span>
          <span
            class="absolute left-[87.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[6]"
          ></span>
        </div>
      </div>

      <div
        class="relative h-full w-full"
        x-data="{
        selected: 'county',
        map: null,
        geojsonData: {},

        async loadGeoJSON() {
          const sources = {{ .Params.geojson.sources | jsonify }};
          const [counties, house, congress, senate] = await Promise.all(
            sources.map(url => fetch(url).then(r => r.json()))
          );
          this.geojsonData = {
            county: counties,
            house: house,
            congressional: congress,
            senate: senate
          };

          if (this.map && this.map.loaded()) {
            this.setupLayers();
          }
        },

        setupLayers() {
          if (!this.map || !this.geojsonData.county) return;

          if (!this.map.getSource('counties')) {
            this.map.addSource('counties', {
              type: 'geojson',
              data: this.geojsonData.county
            });
            this.map.addLayer({
              id: 'counties-fill',
              type: 'fill',
              source: 'counties',
              paint: {
                'fill-color': '#627BC1',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'counties-outline',
              type: 'line',
              source: 'counties',
              paint: {
                'line-color': '#627BC1',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('house') && this.geojsonData.house) {
            this.map.addSource('house', {
              type: 'geojson',
              data: this.geojsonData.house
            });
            this.map.addLayer({
              id: 'house-fill',
              type: 'fill',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#E67E22',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'house-outline',
              type: 'line',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#E67E22',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('congressional') && this.geojsonData.congressional) {
            this.map.addSource('congressional', {
              type: 'geojson',
              data: this.geojsonData.congressional
            });
            this.map.addLayer({
              id: 'congressional-fill',
              type: 'fill',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#8E44AD',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'congressional-outline',
              type: 'line',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#8E44AD',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('senate') && this.geojsonData.senate) {
            this.map.addSource('senate', {
              type: 'geojson',
              data: this.geojsonData.senate
            });
            this.map.addLayer({
              id: 'senate-fill',
              type: 'fill',
              source: 'senate',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#27AE60',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'senate-outline',
              type: 'line',
              source: 'senate',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#27AE60',
                'line-width': 2
              }
            });
          }

          this.updateLayerVisibility();
        },

        updateLayerVisibility() {
          if (!this.map) return;

          const layers = {
            county: ['counties-fill', 'counties-outline'],
            congressional: ['congressional-fill', 'congressional-outline'],
            senate: ['senate-fill', 'senate-outline'],
            house: ['house-fill', 'house-outline']
          };

          Object.entries(layers).forEach(([key, layerIds]) => {
            const visibility = key === this.selected ? 'visible' : 'none';
            layerIds.forEach(id => {
              if (this.map.getLayer(id)) {
                this.map.setLayoutProperty(id, 'visibility', visibility);
              }
            });
          });
        },

        initMap() {
          const el = this.$refs.mapCanvas;
          if (!el || this.map) return;

          const mapComponent = window.maplibreComponent({
            id: 'pa-map',
            styleURL: 'https://tiles.openfreemap.org/styles/positron',
            bounds: [[-80.5199, 39.7198], [-74.6895, 42.26986]],
            padding: 24,
            minZoom: 3,
            maxZoom: 18,
            zoom: 6,
            controls: ['navigation'],
            attributionCompact: true
          });

          mapComponent.init.call({
            $refs: { canvas: el },
            map: null,
            _io: null,
            _ro: null,
            _initializing: false,
            _flyToHandler: null,
            _mobileViewHandler: null,
            _markerInstances: [],
            _baseMarkerInstances: [],
            ...mapComponent
          });

          setTimeout(() => {
            if (window.maplibregl && window.maplibregl.Map) {
              this.map = new maplibregl.Map({
                container: el,
                style: 'https://tiles.openfreemap.org/styles/positron',
                center: [-77.5, 40.9],
                zoom: 6,
                minZoom: 3,
                maxZoom: 18,
                attributionControl: false,
                cooperativeGestures: true
              });

              this.map.addControl(new maplibregl.NavigationControl({
                showCompass: false,
                showZoom: true,
                visualizePitch: false
              }), 'top-right');

              this.map.addControl(new maplibregl.AttributionControl({
                compact: true
              }));

              this.map.on('load', () => {
                this.map.fitBounds([[-80.5199, 39.7198], [-74.6895, 42.26986]], { padding: 24 });
                this.setupLayers();
              });

              this.loadGeoJSON();
            }
          }, 100);
        }
      }"
        x-init="initMap(); $watch('selected', () => updateLayerVisibility())"
      >
        <div x-ref="mapCanvas" class="absolute inset-0 h-full w-full"></div>

        <div
          class="absolute right-[50px] top-[10px] z-20 flex overflow-hidden rounded-md border border-g-3 bg-white shadow"
        >
          <button
            :data-checked="selected === 'county'"
            @click="selected='county'"
            title="County"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Counties
          </button>

          <button
            :data-checked="selected === 'congressional'"
            @click="selected='congressional'"
            title="Congressional"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Congressional
          </button>

          <button
            :data-checked="selected === 'senate'"
            @click="selected='senate'"
            title="Senate"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Senate
          </button>

          <button
            :data-checked="selected === 'house'"
            @click="selected='house'"
            title="House"
            class="px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            House
          </button>
        </div>
      </div>
    </div>

    <div
      class="col-span-5 row-span-2 bg-black pb-2 pl-12 pr-2"
      x-ref="treemapContainer"
      x-show="datasets && datasets.total && datasets.total.length > 0"
      x-init="
        window.addEventListener('inspections-data-ready', () => {
          $nextTick(() => renderTreemap());
        });
        $watch('datasets', () => { 
          if (datasets && datasets.total && datasets.total.length > 0) { 
            $nextTick(() => renderTreemap()); 
          } 
        });
        window.addEventListener('resize', () => {
          if (datasets && datasets.total && datasets.total.length > 0) {
            renderTreemap();
          }
        });
      "
    ></div>

    <div class="col-span-12 bg-orange"></div>

    <div class="col-span-12 bg-orange"></div>
  </div>
{{ end }}

{{ define "extra-head" }}
  {{ partial "header/maplibre.html" . }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
{{ end }}

{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}
