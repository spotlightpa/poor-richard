{{ define "main" }}

  {{ $params := partialCached "helper/page-params" .Page .RelPermalink }}
  {{ $bylineLink := "" }}
  {{ with .Param "authors" }}
    {{ if len . | eq 1 }}
      {{ $name := index . 0 }}
      {{ $author := partial "helper/get-author" $name }}
      {{ if $author.link }}
        {{ $bylineLink = $author.link }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ partial "s3-data-loader.html" . }}


  <div
    class="grid h-screen w-screen grid-cols-12 grid-rows-6"
    x-data="{
      ...s3DataLoader(),
      
      getPartyData() {
        const datasets = this.datasets || {};
        const totalData = datasets['total'] || [];
        
        if (!Array.isArray(totalData) || totalData.length === 0) {
          return [];
        }
        
        const rows = totalData.filter(r => r.Party && r.Party !== 'Total');
        
        const dem = rows.find(r => r.Party === 'Democrat') || { Total: 0 };
        const rep = rows.find(r => r.Party === 'Republican') || { Total: 0 };
        const noParty = rows.find(r => r.Party === 'No Affiliation') || { Total: 0 };
        const other = rows.find(r => r.Party === 'Other') || { Total: 0 };

        return [
          { 
            name: 'Democrat',
            party: 'Dem.', 
            value: typeof dem.Total === 'number' ? dem.Total : 0, 
            color: '#009edb'
          },
          { 
            name: 'Republican',
            party: 'Rep.', 
            value: typeof rep.Total === 'number' ? rep.Total : 0, 
            color: '#d70000'
          },
          { 
            name: 'No Affiliation',
            party: 'No Party', 
            value: typeof noParty.Total === 'number' ? noParty.Total : 0, 
            color: '#E59500'
          },
          { 
            name: 'Other',
            party: 'Other', 
            value: typeof other.Total === 'number' ? other.Total : 0, 
            color: '#1b998b'
          }
        ];
      },

      renderTreemap() {
        const container = this.$refs.treemapContainer;
        if (!container) return;

        const partyData = this.getPartyData();
        if (partyData.length === 0) return;

        const sortedData = [...partyData].sort((a, b) => b.value - a.value);
        
        container.innerHTML = '';

        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;
        
        if (containerWidth < 100 || containerHeight < 100) {
          return;
        }

        const margin = { top: 10, right: 80, bottom: 10, left: 100 };
        const width = containerWidth - margin.left - margin.right;
        const height = containerHeight - margin.top - margin.bottom;

        const svg = d3.select(container)
          .append('svg')
          .attr('width', containerWidth)
          .attr('height', containerHeight)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear()
          .domain([0, d3.max(sortedData, d => d.value)])
          .range([0, width]);

        const y = d3.scaleBand()
          .domain(sortedData.map(d => d.name))
          .range([0, height])
          .padding(0.3)
          .paddingOuter(0.15);

        const gap = y.step() - y.bandwidth();
        svg.selectAll('.separator')
          .data(sortedData.slice(1))
          .join('line')
          .attr('class', 'separator')
          .attr('x1', -margin.left)
          .attr('x2', width)
          .attr('y1', d => y(d.name) - gap / 2)
          .attr('y2', d => y(d.name) - gap / 2)
          .attr('stroke', '#e5e7eb')
          .attr('stroke-width', 1)
          .attr('stroke-dasharray', '3,3');

        const bars = svg.selectAll('.bar')
          .data(sortedData)
          .join('g')
          .attr('class', 'bar');

        bars.append('rect')
          .attr('x', 0)
          .attr('y', d => y(d.name))
          .attr('width', d => Math.max(0, x(d.value)))
          .attr('height', y.bandwidth())
          .attr('fill', d => d.color);

        bars.append('text')
          .attr('x', -margin.left + 12)
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', 'start')
          .attr('fill', '#374151')
          .attr('font-size', '16px')
          .attr('font-weight', '700')
          .text(d => d.party);

        bars.append('text')
          .attr('x', d => {
            if (d.value < 1500000) {
              return Math.max(0, x(d.value)) + 12;
            } else {
              return Math.max(0, x(d.value) - 12);
            }
          })
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', d => d.value < 1500000 ? 'start' : 'end')
          .attr('fill', d => d.value < 1500000 ? '#000000' : 'white')
          .attr('font-size', '18px')
          .attr('font-weight', '700')
          .text(d => d.value.toLocaleString());
      }
    }"
    x-init="init()"
  >
    <div
      class="col-span-5 row-span-2 flex flex-col items-start justify-center bg-black p-12 text-white"
    >
      {{ with .Param "kicker" }}
        <p class="font-sans font-bold uppercase text-yellow">
          {{ . }}
        </p>
      {{ end }}


      <h1 class="mt-2 font-serif text-3xl uppercase leading-hed lg:text-4xl">
        {{ .Title }}
      </h1>

      {{ with .Param "dek" }}
        <p class="mb-4 text-2xl">{{ . }}</p>
      {{ else }}
        {{ with .Description }}
          <p class="mb-4 text-2xl">{{ . }}</p>
        {{ end }}
      {{ end }}

      {{ with $params.byline }}
        <p class="text-base font-light">
          <span>by</span>
          <span class="font-semibold">
            {{ if $bylineLink }}
              <a href="{{ $bylineLink }}">{{ . }}</a>
            {{ else }}
              {{ . }}
            {{ end }}
          </span>
          {{ if not $params.evergreen | and $params.published }}
            <span>
              | Last updated:
              <time datetime="{{ $params.publishedISO }}"
                >{{ $params.published }}</time
              >
            </span>
          {{ end }}
        </p>
      {{ end }}

      {{ if not $params.evergreen | and $params.published }}
        <a
          href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-2 block font-semibold"
        >
          Source: Pennsylvania Department of State
        </a>
      {{ end }}
    </div>

    <div class="col-span-7 row-span-4 overflow-hidden bg-red p-4">
      <div
        class="relative h-full w-full"
        x-data="{
        selected: 'county',
        map: null,
        geojsonData: {},

        async loadGeoJSON() {
          const sources = {{ .Params.geojson.sources | jsonify }};
          const [counties, house, congress, senate] = await Promise.all(
            sources.map(url => fetch(url).then(r => r.json()))
          );
          this.geojsonData = {
            county: counties,
            house: house,
            congressional: congress,
            senate: senate
          };

          if (this.map && this.map.loaded()) {
            this.setupLayers();
          }
        },

        setupLayers() {
          if (!this.map || !this.geojsonData.county) return;

          if (!this.map.getSource('counties')) {
            this.map.addSource('counties', {
              type: 'geojson',
              data: this.geojsonData.county
            });
            this.map.addLayer({
              id: 'counties-fill',
              type: 'fill',
              source: 'counties',
              paint: {
                'fill-color': '#627BC1',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'counties-outline',
              type: 'line',
              source: 'counties',
              paint: {
                'line-color': '#627BC1',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('house') && this.geojsonData.house) {
            this.map.addSource('house', {
              type: 'geojson',
              data: this.geojsonData.house
            });
            this.map.addLayer({
              id: 'house-fill',
              type: 'fill',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#E67E22',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'house-outline',
              type: 'line',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#E67E22',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('congressional') && this.geojsonData.congressional) {
            this.map.addSource('congressional', {
              type: 'geojson',
              data: this.geojsonData.congressional
            });
            this.map.addLayer({
              id: 'congressional-fill',
              type: 'fill',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#8E44AD',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'congressional-outline',
              type: 'line',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#8E44AD',
                'line-width': 2
              }
            });
          }

          if (!this.map.getSource('senate') && this.geojsonData.senate) {
            this.map.addSource('senate', {
              type: 'geojson',
              data: this.geojsonData.senate
            });
            this.map.addLayer({
              id: 'senate-fill',
              type: 'fill',
              source: 'senate',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': '#27AE60',
                'fill-opacity': 0.2
              }
            });
            this.map.addLayer({
              id: 'senate-outline',
              type: 'line',
              source: 'senate',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#27AE60',
                'line-width': 2
              }
            });
          }

          this.updateLayerVisibility();
        },

        updateLayerVisibility() {
          if (!this.map) return;

          const layers = {
            county: ['counties-fill', 'counties-outline'],
            congressional: ['congressional-fill', 'congressional-outline'],
            senate: ['senate-fill', 'senate-outline'],
            house: ['house-fill', 'house-outline']
          };

          Object.entries(layers).forEach(([key, layerIds]) => {
            const visibility = key === this.selected ? 'visible' : 'none';
            layerIds.forEach(id => {
              if (this.map.getLayer(id)) {
                this.map.setLayoutProperty(id, 'visibility', visibility);
              }
            });
          });
        },

        initMap() {
          const el = this.$refs.mapCanvas;
          if (!el || this.map) return;

          const mapComponent = window.maplibreComponent({
            id: 'pa-map',
            styleURL: 'https://tiles.openfreemap.org/styles/positron',
            bounds: [[-80.5199, 39.7198], [-74.6895, 42.26986]],
            padding: 24,
            minZoom: 3,
            maxZoom: 18,
            zoom: 6,
            controls: ['navigation'],
            attributionCompact: true
          });

          mapComponent.init.call({
            $refs: { canvas: el },
            map: null,
            _io: null,
            _ro: null,
            _initializing: false,
            _flyToHandler: null,
            _mobileViewHandler: null,
            _markerInstances: [],
            _baseMarkerInstances: [],
            ...mapComponent
          });

          setTimeout(() => {
            if (window.maplibregl && window.maplibregl.Map) {
              this.map = new maplibregl.Map({
                container: el,
                style: 'https://tiles.openfreemap.org/styles/positron',
                center: [-77.5, 40.9],
                zoom: 6,
                minZoom: 3,
                maxZoom: 18,
                attributionControl: false,
                cooperativeGestures: true
              });

              this.map.addControl(new maplibregl.NavigationControl({
                showCompass: false,
                showZoom: true,
                visualizePitch: false
              }), 'top-right');

              this.map.addControl(new maplibregl.AttributionControl({
                compact: true
              }));

              this.map.on('load', () => {
                this.map.fitBounds([[-80.5199, 39.7198], [-74.6895, 42.26986]], { padding: 24 });
                this.setupLayers();
              });

              this.loadGeoJSON();
            }
          }, 100);
        }
      }"
        x-init="initMap(); $watch('selected', () => updateLayerVisibility())"
      >
        <div x-ref="mapCanvas" class="absolute inset-0 h-full w-full"></div>

        <div
          class="absolute right-[50px] top-[10px] z-20 flex overflow-hidden rounded-md border border-g-3 bg-white shadow"
        >
          <button
            :data-checked="selected === 'county'"
            @click="selected='county'"
            title="County"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Counties
          </button>

          <button
            :data-checked="selected === 'congressional'"
            @click="selected='congressional'"
            title="Congressional"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Congressional
          </button>

          <button
            :data-checked="selected === 'senate'"
            @click="selected='senate'"
            title="Senate"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Senate
          </button>

          <button
            :data-checked="selected === 'house'"
            @click="selected='house'"
            title="House"
            class="px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            House
          </button>
        </div>
      </div>
    </div>

    <div 
      class="col-span-5 row-span-2 bg-white p-2"
      x-ref="treemapContainer"
      x-show="datasets && datasets.total && datasets.total.length > 0"
      x-init="
        window.addEventListener('inspections-data-ready', () => {
          $nextTick(() => renderTreemap());
        });
        $watch('datasets', () => { 
          if (datasets && datasets.total && datasets.total.length > 0) { 
            $nextTick(() => renderTreemap()); 
          } 
        });
        window.addEventListener('resize', () => {
          if (datasets && datasets.total && datasets.total.length > 0) {
            renderTreemap();
          }
        });
      "
    >
    </div>

    <div class="col-span-12 bg-orange"></div>

    <div class="col-span-12 bg-orange"></div>
  </div>

  <section
    class="mx-auto mt-12 max-w-screen-xl grid-cols-12 bg-white px-4 pb-6 text-g-9 lg:grid lg:gap-x-8 xl:px-0"
    id="article"
  >
    <header data-ga-category="header" class="mb-8 w-full lg:col-span-12">
      {{ with .Param "kicker" }}
        <p
          class="inline-block border-2 border-eyebrow-bg bg-eyebrow-bg px-2 font-sans text-xs font-semibold uppercase text-eyebrow md:text-sm"
        >
          {{ . }}
        </p>
      {{ end }}


      <h1
        class="mt-1 text-2xl font-bold leading-tight tracking-tight text-black sm:text-4xl"
      >
        {{ .Title }}
      </h1>

      {{ with $params.byline }}
        <h2
          class="mt-1 font-sans text-base leading-tight tracking-normal text-g-8 sm:leading-normal"
        >
          <span class="font-semibold">
            by
            <span>
              {{ if $bylineLink }}
                <a href="{{ $bylineLink }}">{{ . }}</a>
              {{ else }}
                {{ . }}
              {{ end }}
            </span>
          </span>

          {{ if not $params.evergreen | and $params.published }}
            <span class="font-light">
              | Last updated:
              <time datetime="{{ $params.publishedISO }}"
                >{{ $params.published }}</time
              >
            </span>

            <a
              href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics"
              target="_blank"
              rel="noopener noreferrer"
              class="block font-semibold"
            >
              Source: Pa. Department of State
            </a>
          {{ end }}
        </h2>
      {{ end }}
    </header>

    <article class="w-full lg:col-span-12">
      <div class="w-full">
        {{ .Content }}
        {{ partial "blocks/voter-registration.html" . }}
      </div>
    </article>
  </section>
{{ end }}

{{ define "extra-head" }}
  {{ partial "header/maplibre.html" . }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
{{ end }}

{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}