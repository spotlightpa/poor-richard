{{ define "main" }}

  {{ $params := partialCached "helper/page-params" .Page .RelPermalink }}
  {{ $bylineLink := "" }}
  {{ with .Param "authors" }}
    {{ if len . | eq 1 }}
      {{ $name := index . 0 }}
      {{ $author := partial "helper/get-author" $name }}
      {{ if $author.link }}
        {{ $bylineLink = $author.link }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ partial "s3-data-loader.html" . }}


  <div
    class="grid min-h-screen w-screen grid-cols-12 grid-rows-[repeat(4,minmax(0,1fr))_auto_auto]"
    x-data="{
      ...s3DataLoader(),
      
      apDateLabelFromMDY(mdy) {
        if (!mdy || typeof mdy !== 'string') return null;
        const parts = mdy.split('/');
        if (parts.length !== 3) return null;
        const [mm, dd, yyyy] = parts.map(p => parseInt(p, 10));
        if (!mm || !dd || !yyyy) return null;
        const months = ['Jan.','Feb.','March','April','May','June','July','Aug.','Sept.','Oct.','Nov.','Dec.'];
        return `${months[mm - 1] || ''} ${dd}, ${yyyy}`;
      },
      isoFromMDY(mdy) {
        if (!mdy || typeof mdy !== 'string') return null;
        const parts = mdy.split('/');
        if (parts.length !== 3) return null;
        const [mm, dd, yyyy] = parts.map(p => parseInt(p, 10));
        if (!mm || !dd || !yyyy) return null;
        const mm2 = String(mm).padStart(2,'0');
        const dd2 = String(dd).padStart(2,'0');
        return `${yyyy}-${mm2}-${dd2}`;
      },

      getPartyData() {
        const datasets = this.datasets || {};
        const totalData = datasets['total'] || [];
        
        if (!Array.isArray(totalData) || totalData.length === 0) {
          return [];
        }
        
        const rows = totalData.filter(r => r.Party && r.Party !== 'Total');
        
        const dem = rows.find(r => r.Party === 'Democrat') || { Total: 0 };
        const rep = rows.find(r => r.Party === 'Republican') || { Total: 0 };
        const noParty = rows.find(r => r.Party === 'No Affiliation') || { Total: 0 };
        const other = rows.find(r => r.Party === 'Other') || { Total: 0 };

        return [
          { 
            name: 'Democrat',
            party: 'Dem.', 
            value: typeof dem.Total === 'number' ? dem.Total : 0, 
            color: '#009edb'
          },
          { 
            name: 'Republican',
            party: 'Rep.', 
            value: typeof rep.Total === 'number' ? rep.Total : 0, 
            color: '#d70000'
          },
          { 
            name: 'No Affiliation',
            party: 'No Party', 
            value: typeof noParty.Total === 'number' ? noParty.Total : 0, 
            color: '#ffcb03'
          },
          { 
            name: 'Other',
            party: 'Other', 
            value: typeof other.Total === 'number' ? other.Total : 0, 
            color: '#1b998b'
          }
        ];
      },

      renderTreemap() {
        const container = this.$refs.treemapContainer;
        if (!container) return;

        const partyData = this.getPartyData();
        if (partyData.length === 0) return;

        const sortedData = [...partyData].sort((a, b) => b.value - a.value);
        
        container.innerHTML = '';

        const containerWidth = container.clientWidth;
        const containerHeight = container.clientHeight;
        
        if (containerWidth < 100 || containerHeight < 100) {
          return;
        }

        const margin = { top: 0, right: 80, bottom: 10, left: 0 };
        const width = containerWidth - margin.left - margin.right;
        const height = containerHeight - margin.top - margin.bottom;

        const svg = d3.select(container)
          .append('svg')
          .attr('width', containerWidth)
          .attr('height', containerHeight)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const labelWidth = 80;
        const x = d3.scaleLinear()
          .domain([0, d3.max(sortedData, d => d.value)])
          .range([labelWidth, width]);

        const y = d3.scaleBand()
          .domain(sortedData.map(d => d.name))
          .range([0, height])
          .padding(0.3)
          .paddingOuter(0.15);

        const gap = y.step() - y.bandwidth();
        svg.selectAll('.separator')
          .data(sortedData.slice(1))
          .join('line')
          .attr('class', 'separator')
          .attr('x1', 0)
          .attr('x2', width)
          .attr('y1', d => y(d.name) - gap / 2)
          .attr('y2', d => y(d.name) - gap / 2)
          .attr('stroke', '#4b5563')
          .attr('stroke-width', 1)
          .attr('stroke-dasharray', '3,3');

        const bars = svg.selectAll('.bar')
          .data(sortedData)
          .join('g')
          .attr('class', 'bar');

        bars.append('rect')
          .attr('x', labelWidth)
          .attr('y', d => y(d.name))
          .attr('width', d => Math.max(0, x(d.value) - labelWidth))
          .attr('height', y.bandwidth())
          .attr('fill', d => d.color);

        bars.append('text')
          .attr('x', 0)
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', 'start')
          .attr('fill', '#ffffff')
          .attr('font-size', '16px')
          .attr('font-weight', '700')
          .text(d => d.party);

        bars.append('text')
          .attr('x', d => {
            const barWidth = x(d.value) - labelWidth;
            if (d.value < 1500000) {
              return x(d.value) + 12;
            } else {
              return x(d.value) - 12;
            }
          })
          .attr('y', d => y(d.name) + y.bandwidth() / 2)
          .attr('dy', '0.35em')
          .attr('text-anchor', d => d.value < 1500000 ? 'start' : 'end')
          .attr('fill', '#ffffff')
          .attr('font-size', '18px')
          .attr('font-weight', '700')
          .text(d => d.value.toLocaleString());
      }
    }"
    x-init="init()"
  >
    <div
      class="col-span-5 row-span-2 flex flex-col items-start justify-center bg-black p-12 text-white"
    >
      {{ with .Param "kicker" }}
        <p class="font-sans font-bold uppercase text-yellow">
          {{ . }}
        </p>
      {{ end }}


      <h1 class="mt-2 font-serif text-3xl uppercase leading-hed lg:text-4xl">
        {{ .Title }}
      </h1>

      {{ with .Param "dek" }}
        <p class="mb-4 text-2xl">{{ . }}</p>
      {{ else }}
        {{ with .Description }}
          <p class="mb-4 text-2xl">{{ . }}</p>
        {{ end }}
      {{ end }}

      {{ with $params.byline }}
        <p class="text-base font-light">
          <span>by</span>
          <span class="font-semibold">
            {{ if $bylineLink }}
              <a href="{{ $bylineLink }}">{{ . }}</a>
            {{ else }}
              {{ . }}
            {{ end }}
          </span>
          {{ if not $params.evergreen | and $params.published }}
            <span>
              | Last updated:
              <time
                :datetime="(metadata && (metadata.generated_at_utc || isoFromMDY(metadata.last_updated))) || {{ $params.publishedISO | jsonify }}"
                x-text="(metadata && apDateLabelFromMDY(metadata.last_updated)) || {{ $params.published | jsonify }}"
              >
                {{ $params.published }}
              </time>
            </span>
          {{ end }}

        </p>
      {{ end }}

      {{ if not $params.evergreen | and $params.published }}
        <a
          href="https://www.pa.gov/agencies/dos/resources/voting-and-elections-resources/voting-and-election-statistics"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-2 block font-semibold"
        >
          Source: Pennsylvania Department of State
        </a>
      {{ end }}
    </div>

    <div
      class="col-span-7 row-span-4 flex flex-col overflow-visible bg-black px-4 pb-4 pr-12 pt-12"
      x-data="{
    selectedParty: 'democrat',
partyConfig: {
  democrat: {
    colors: ['#d4f1ff', '#8fd6ff', '#4bbcff', '#009eff', '#0079d1', '#005aa3', '#003c75', '#001f47'],
    labels: ['10%', '20%', '30%', '40%', '50%', '60%', '70%'],
    borderColor: '#1abeff'
  },
  republican: {
    colors: ['#ffe0e0', '#ffb3b3', '#ff8080', '#ff4d4d', '#e00000', '#b30000', '#7a0000', '#330000'],
    labels: ['10%', '20%', '30%', '40%', '50%', '60%', '70%'],
    borderColor: '#ff1a1a'
  },
  'no-party': {
    colors: ['#fff6cc', '#ffe999', '#ffdc66', '#ffcf33', '#e0b300', '#b38600', '#7a5c00', '#332600'],
    labels: ['3%', '6%', '9%', '12%', '15%', '18%', '21%'],
    borderColor: '#f0c000'
  },
  other: {
    colors: ['#d8fbf6', '#aff5ea', '#86efe0', '#5de9d6', '#22cdb8', '#199e8e', '#0f6f63', '#083934'],
    labels: ['1%', '2%', '3%', '4%', '5%', '6%', '7%'],
    borderColor: '#24ccb8'
  }
}

  }"
    >
      <div class="mb-4 grid w-full grid-cols-2 items-stretch gap-3">
        <div class="relative h-full">
          <select
            @change="window.dispatchEvent(new CustomEvent('party-changed', { detail: $event.target.value }))"
            x-model="selectedParty"
            :style="`border-color: ${partyConfig[selectedParty].borderColor};`"
            class="h-full w-full cursor-pointer appearance-none rounded-lg border-[3px] bg-white px-4 py-3.5 pr-12 text-base font-semibold text-black shadow-lg transition-all duration-200 hover:shadow-xl focus:outline-none focus:ring-0"
          >
            <option value="democrat">Democrat</option>
            <option value="republican">Republican</option>
            <option value="no-party">No Party</option>
            <option value="other">Other</option>
          </select>

          <div
            class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4"
          >
            <svg
              class="text-gray-700 h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </div>
        </div>

        <form
          @submit.prevent="window.dispatchEvent(new CustomEvent('search-submitted', { detail: { query: $refs.addressSearch.value } }))"
          class="relative h-full"
        >
          <input
            x-ref="addressSearch"
            type="text"
            placeholder="Search by address"
            class="placeholder-gray-5 h-full w-full rounded-lg border-[3px] border-g-4 bg-white px-4 py-3.5 pr-12 text-base font-semibold text-black shadow-lg transition-all duration-200 hover:shadow-xl focus:outline-none focus:ring-0"
          />

          <button
            type="submit"
            class="absolute inset-y-0 right-0 flex items-center pr-4 text-g-7 hover:opacity-80 focus:outline-none"
            title="Search"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"
              />
            </svg>
          </button>
        </form>
      </div>

      <div class="relative mb-10 w-full">
        <div
          x-ref="legend"
          class="flex h-6 w-full gap-[1px] rounded-sm border border-g-1 bg-g-1"
          x-init="
    const highlight = (idx) => {
      const bins = $refs.legend.querySelectorAll('.legend-bin');
      const clear = idx == null || idx < 0 || Number.isNaN(idx);
      bins.forEach((b, i) => {
        const active = !clear && i === idx;
        b.style.outline = active ? '4px solid #fff' : '';
        b.style.outlineOffset = '-2px';
        b.style.opacity = clear ? '1' : (active ? '1' : '0.4');
        b.style.transition = 'opacity 0.15s ease, outline 0.15s ease';
      });
    };


    window.addEventListener('legend-active-bin', (e) => {
      if (e.detail.party !== selectedParty) return;
      highlight(e.detail.index);
    });

    window.addEventListener('legend-clear', () => {
      const bins = $refs.legend.querySelectorAll('.legend-bin');
      bins.forEach(b => {
        b.style.outline = '';
        b.style.opacity = '1';
      });
    });
  "
        >
          <template
            x-for="(color, index) in partyConfig[selectedParty].colors"
            :key="index"
          >
            <div
              class="legend-bin flex-1"
              :style="`background-color: ${color}`"
            ></div>
          </template>
        </div>

        <div
          class="absolute left-0 top-6 w-full text-base font-extrabold text-white"
        >
          <span
            class="absolute left-[12.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[0]"
          ></span>
          <span
            class="absolute left-[25%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[1]"
          ></span>
          <span
            class="absolute left-[37.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[2]"
          ></span>
          <span
            class="absolute left-[50%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[3]"
          ></span>
          <span
            class="absolute left-[62.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[4]"
          ></span>
          <span
            class="absolute left-[75%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[5]"
          ></span>
          <span
            class="absolute left-[87.5%] -translate-x-1/2"
            x-text="partyConfig[selectedParty].labels[6]"
          ></span>
        </div>
      </div>

      <div
        class="relative h-full w-full"
        @search-submitted.window="handleAddressSearch((($event.detail?.query || '').trim() ? ($event.detail.query.trim() + ', Pennsylvania') : ''))"
        x-data="{
        selected: 'county',
        selectedParty: 'democrat',
        map: null,
        geojsonData: {},
        countyData: [],
        popup: null,
        hoveredId: null,
        hoveredDistrictId: null,
        searchPopup: null,




async geocodeAddress(q) {
  if (!q || typeof q !== 'string') return null;
  const map = this.map;
  const bounds = map && map.getBounds();
  const params = new URLSearchParams({
    format: 'jsonv2',
    q,
    countrycodes: 'us',
    limit: '1'
  });
  if (bounds) {
    params.set('viewbox', [
      bounds.getWest().toFixed(6),
      bounds.getNorth().toFixed(6),
      bounds.getEast().toFixed(6),
      bounds.getSouth().toFixed(6)
    ].join(','));
    params.set('bounded', '1');
  }
  const res = await fetch(`https://nominatim.openstreetmap.org/search?${params.toString()}`, {
    headers: { 'Accept-Language': 'en' }
  }).catch(() => null);
  if (!res || !res.ok) return null;
  const data = await res.json().catch(() => null);
  if (!Array.isArray(data) || !data.length) return null;
  const hit = data[0];
  const lon = parseFloat(hit.lon);
  const lat = parseFloat(hit.lat);
  return (Number.isFinite(lon) && Number.isFinite(lat)) ? { lon, lat } : null;
},

isPointInRing([x, y], ring) {
  let inside = false;
  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
    const xi = ring[i][0], yi = ring[i][1];
    const xj = ring[j][0], yj = ring[j][1];
    const intersect = ((yi > y) !== (yj > y)) && (x < ((xj - xi) * (y - yi)) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
},

isPointInFeature([x, y], feature) {
  const g = feature?.geometry;
  if (!g) return false;
  if (g.type === 'Polygon') {
    const [outer, ...holes] = g.coordinates;
    if (!this.isPointInRing([x,y], outer)) return false;
    return !holes.some(h => this.isPointInRing([x,y], h));
  }
  if (g.type === 'MultiPolygon') {
    return g.coordinates.some(poly => {
      const [outer, ...holes] = poly;
      if (!this.isPointInRing([x,y], outer)) return false;
      return !holes.some(h => this.isPointInRing([x,y], h));
    });
  }
  return false;
},

getFeatureBounds(feature) {
  const g = feature.geometry;
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  const walk = (coords) => {
    if (typeof coords[0] === 'number') {
      const [x, y] = coords;
      if (x < minX) minX = x; if (y < minY) minY = y;
      if (x > maxX) maxX = x; if (y > maxY) maxY = y;
    } else coords.forEach(walk);
  };
  walk(g.coordinates);
  return [[minX, minY], [maxX, maxY]];
},

findContainingFeature(lon, lat) {
  const order = [this.selected, 'county'];
  for (const layer of order) {
    const fc = this.geojsonData?.[layer];
    if (!fc?.features) continue;
    const hit = fc.features.find(f => this.isPointInFeature([lon, lat], f));
    if (hit) return { layerType: layer, feature: hit };
  }
  return null;
},

buildHoverPopupHTML(feature, layerType) {
  const partyKeyMap = {
    democrat:   { share: 'democratShare',   total: 'democratTotal',   color: '#0079d1', text: '#ffffff', label: 'Democrat' },
    republican: { share: 'republicanShare', total: 'republicanTotal', color: '#d70000', text: '#ffffff', label: 'Republican' },
    'no-party': { share: 'noPartyShare',    total: 'noPartyTotal',    color: '#ffcb03', text: '#000000', label: 'No Party' },
    other:      { share: 'otherShare',      total: 'otherTotal',      color: '#1b998b', text: '#ffffff', label: 'Other' }
  };

  const activeParty = this.selectedParty;
  const active = partyKeyMap[activeParty];

  const shareVal = feature.properties?.[active.share];
  const totalVal = feature.properties?.[active.total];
  const sharePct = Number.isFinite(shareVal)
    ? Math.max(0, Math.min(100, Math.round(shareVal)))
    : null;

  {
    const breaks = this.getBreaksForParty(activeParty);
    let idx = -1;
    if (Number.isFinite(sharePct)) {
      idx = breaks.findIndex(b => sharePct < b);
      if (idx === -1) idx = breaks.length - 1;
    }
    window.dispatchEvent(new CustomEvent('legend-active-bin', { detail: { party: activeParty, index: idx } }));
  }

  const title = (layerType === 'county')
    ? `${feature.properties?.county_nam || 'County'} County`
    : feature.properties?.districtName || `District ${feature.properties?.DISTRICT || ''}`;

  const others = Object.entries(partyKeyMap)
    .filter(([k]) => k !== activeParty)
    .map(([k, meta]) => ({
      label: meta.label,
      color: meta.color,
      textColor: meta.text,
      pct: Number.isFinite(feature.properties?.[meta.share])
        ? Math.max(0, Math.min(100, Math.round(feature.properties?.[meta.share])))
        : 0
    }));

  const renderBar = ({ label, pct, color, textColor }) => [
    '<div style=&quot;margin-top:8px;&quot;>',
    `<span style=&quot;font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;&quot;>${label}:</span>`,
    '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;&quot;>',
    `<div style=&quot;width:${pct || 0}%; background:${color}; height:100%; position:relative;&quot;>`,
    (pct >= 30
      ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${pct}%</span>`
      : ''),
    '</div>',
    (pct < 30
      ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${pct || 0}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${pct}%</span>`
      : ''),
    '</div>',
    '</div>'
  ].join('');

  const html = [
    '<div style=&quot;padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;&quot;>',
    `<strong style=&quot;font-size: 1.15rem; display: block; margin-bottom: 6px;&quot;>${title}</strong>`,

    '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;&quot;>',
    `<div style=&quot;width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;&quot;>`,
    (sharePct !== null && sharePct >= 30
      ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${sharePct}%</span>`
      : ''),
    '</div>',
    (sharePct !== null && sharePct < 30
      ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${sharePct}%</span>`
      : ''),
    '</div>',

    '<div style=&quot;height:6px;&quot;></div>',
    '<span style=&quot;font-size:0.95rem; font-weight:700;&quot;>Total:</span> ',
    `<span style=&quot;font-size:0.95rem;&quot;>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : '—'}</span>`,

    '<div style=&quot;height:8px;&quot;></div>',
    '<div style=&quot;height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;&quot;></div>',

    renderBar(others[0]),
    renderBar(others[1]),
    renderBar(others[2]),
    '</div>'
  ].join('');

  return html;
},


async handleAddressSearch(query) {
  const hit = await this.geocodeAddress(query);
  if (!hit) return alert('Address not found');
  const { lon, lat } = hit;

  const containing = this.findContainingFeature(lon, lat);
  if (containing) {
    const { feature, layerType } = containing;
    if (layerType !== this.selected) { this.selected = layerType; this.updateLayerVisibility?.(); }
    this.map.fitBounds(this.getFeatureBounds(feature), { padding: 32, maxZoom: 10 });
    if (!this.popup) this.popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
    this.popup.setLngLat([lon, lat]).setHTML(this.buildHoverPopupHTML(feature, layerType)).addTo(this.map);
  } else {
    this.map.flyTo({ center: [lon, lat], zoom: 12 });
    if (this.popup) this.popup.remove();
  }
},


        properCase(str) {
          return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        },

        async loadGeoJSON() {
          const sources = {{ .Params.geojson.sources | jsonify }};
          const [counties, house, congress, senate] = await Promise.all(
            sources.map(url => fetch(url).then(r => r.json()))
          );
          
          if (counties && counties.features) {
            counties.features.forEach(feature => {
              if (feature.properties && feature.properties.county_nam) {
                feature.properties.county_nam = this.properCase(feature.properties.county_nam);
              }
              const name = feature.properties?.county_nam || '';
              feature.properties.__id = name.toLowerCase().replace(/\s+/g, '_');
            });
          }

          
          this.geojsonData = {
            county: counties,
            house: house,
            congressional: congress,
            senate: senate
          };

          if (this.map && this.map.loaded()) {
            await this.joinCountyData();
            await this.joinDistrictData();
            this.setupLayers();
          }
        },

        async joinCountyData() {
          await new Promise(resolve => {
            if (this.datasets && this.datasets.county) {
              resolve();
            } else {
              const checkData = setInterval(() => {
                if (this.datasets && this.datasets.county) {
                  clearInterval(checkData);
                  resolve();
                }
              }, 100);
            }
          });

          this.countyData = this.datasets.county || [];
          
          if (this.geojsonData.county && this.geojsonData.county.features) {
            this.geojsonData.county.features.forEach(feature => {
              const countyName = feature.properties.county_nam;
              const countyRecord = this.countyData.find(d => d.CountyName === countyName);
              
              if (countyRecord) {
                feature.properties.democratShare   = countyRecord['Democrat Share'];
                feature.properties.republicanShare = countyRecord['Republican Share'];
                feature.properties.noPartyShare    = countyRecord['No Affiliation Share'];
                feature.properties.otherShare      = countyRecord['Other Share'];

                feature.properties.democratTotal   = Number(countyRecord['Democrat']) || null;
                feature.properties.republicanTotal = Number(countyRecord['Republican']) || null;
                feature.properties.noPartyTotal    = Number(countyRecord['No Affiliation']) || null;
                feature.properties.otherTotal      = Number(countyRecord['Other']) || null;
              }
            });
          }
        },

        async joinDistrictData() {
          await new Promise(resolve => {
            if (this.datasets && this.datasets.congress && this.datasets.senate && this.datasets.house) {
              resolve();
            } else {
              const checkData = setInterval(() => {
                if (this.datasets && this.datasets.congress && this.datasets.senate && this.datasets.house) {
                  clearInterval(checkData);
                  resolve();
                }
              }, 100);
            }
          });

          if (this.geojsonData.congressional && this.geojsonData.congressional.features && this.datasets.congress) {
            this.geojsonData.congressional.features.forEach(feature => {
              const districtId = feature.properties.DISTRICT;
              const districtRecord = this.datasets.congress.find(d => Number(d.DistrictCode) === Number(districtId));
              
              if (districtRecord) {
                const total = Number(districtRecord.Total) || 1;
                const dem = Number(districtRecord.Democratic || districtRecord.Democrat) || 0;
                const rep = Number(districtRecord.Republican) || 0;
                const noParty = Number(districtRecord['No Affiliation']) || 0;
                const other = Number(districtRecord.Other) || 0;
                
                feature.properties.democratShare = (dem / total) * 100;
                feature.properties.republicanShare = (rep / total) * 100;
                feature.properties.noPartyShare = (noParty / total) * 100;
                feature.properties.otherShare = (other / total) * 100;
                
                feature.properties.democratTotal = dem;
                feature.properties.republicanTotal = rep;
                feature.properties.noPartyTotal = noParty;
                feature.properties.otherTotal = other;
                feature.properties.districtName = `Congressional District ${districtId}`;
              }
            });
          }

          if (this.geojsonData.senate && this.geojsonData.senate.features && this.datasets.senate) {
            this.geojsonData.senate.features.forEach(feature => {
              const districtId = feature.properties.DISTRICT;
              const districtRecord = this.datasets.senate.find(d => Number(d.DistrictCode) === Number(districtId));
              
              if (districtRecord) {
                const total = Number(districtRecord.Total) || 1;
                const dem = Number(districtRecord.Democratic || districtRecord.Democrat) || 0;
                const rep = Number(districtRecord.Republican) || 0;
                const noParty = Number(districtRecord['No Affiliation']) || 0;
                const other = Number(districtRecord.Other) || 0;
                
                feature.properties.democratShare = (dem / total) * 100;
                feature.properties.republicanShare = (rep / total) * 100;
                feature.properties.noPartyShare = (noParty / total) * 100;
                feature.properties.otherShare = (other / total) * 100;
                
                feature.properties.democratTotal = dem;
                feature.properties.republicanTotal = rep;
                feature.properties.noPartyTotal = noParty;
                feature.properties.otherTotal = other;
                feature.properties.districtName = `Senate District ${districtId}`;
              }
            });
          }

          if (this.geojsonData.house && this.geojsonData.house.features && this.datasets.house) {
            this.geojsonData.house.features.forEach(feature => {
              const districtId = feature.properties.DISTRICT;
              const districtRecord = this.datasets.house.find(d => Number(d.DistrictCode) === Number(districtId));
              
              if (districtRecord) {
                const total = Number(districtRecord.Total) || 1;
                const dem = Number(districtRecord.Democratic || districtRecord.Democrat) || 0;
                const rep = Number(districtRecord.Republican) || 0;
                const noParty = Number(districtRecord['No Affiliation']) || 0;
                const other = Number(districtRecord.Other) || 0;
                
                feature.properties.democratShare = (dem / total) * 100;
                feature.properties.republicanShare = (rep / total) * 100;
                feature.properties.noPartyShare = (noParty / total) * 100;
                feature.properties.otherShare = (other / total) * 100;
                
                feature.properties.democratTotal = dem;
                feature.properties.republicanTotal = rep;
                feature.properties.noPartyTotal = noParty;
                feature.properties.otherTotal = other;
                feature.properties.districtName = `House District ${districtId}`;
              }
            });
          }
},

getBreaksForParty(party) {
  if (party === 'no-party') return [3, 6, 9, 12, 15, 18, 21, 999];
  if (party === 'other')    return [1, 2, 3, 4, 5, 6, 7, 999];
  return [10, 20, 30, 40, 50, 60, 70, 999];
},

handleDistrictHover(e, layerType) {
  if (e.features.length > 0) {
    this.map.getCanvas().style.cursor = 'crosshair';
    const feature = e.features[0];
    
    if (this.hoveredDistrictId !== undefined && this.hoveredDistrictId !== feature.id) {
      this.map.setFeatureState(
        { source: layerType, id: this.hoveredDistrictId },
        { hover: false }
      );
    }
    this.hoveredDistrictId = feature.id;
    this.map.setFeatureState(
      { source: layerType, id: this.hoveredDistrictId },
      { hover: true }
    );
    
    if (!this.popup) {
      this.popup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false
      });
    }
    
    const partyKeyMap = {
      democrat:   { share: 'democratShare',   total: 'democratTotal',   color: '#0079d1', text: '#ffffff', label: 'Democrat' },
      republican: { share: 'republicanShare', total: 'republicanTotal', color: '#d70000', text: '#ffffff', label: 'Republican' },
      'no-party': { share: 'noPartyShare',    total: 'noPartyTotal',    color: '#ffcb03', text: '#000000', label: 'No Party' },
      other:      { share: 'otherShare',      total: 'otherTotal',      color: '#1b998b', text: '#ffffff', label: 'Other' }
    };
    
    const activeParty = this.selectedParty;
    const active = partyKeyMap[activeParty];
    
    const shareVal = feature.properties[active.share];
    const totalVal = feature.properties[active.total];
const sharePct = Number.isFinite(shareVal)
  ? Math.max(0, Math.min(100, Math.round(shareVal)))
  : null;
{
  const breaks = this.getBreaksForParty(activeParty);
  let idx = -1;
  if (Number.isFinite(sharePct)) {
    idx = breaks.findIndex(b => sharePct < b);
    if (idx === -1) idx = breaks.length - 1;
  }
  window.dispatchEvent(new CustomEvent('legend-active-bin', { detail: { party: activeParty, index: idx } }));
}
    
    const others = Object.entries(partyKeyMap)
      .filter(([k]) => k !== activeParty)
      .map(([k, meta]) => ({
        label: meta.label,
        color: meta.color,
        textColor: meta.text,
        pct: Number.isFinite(feature.properties[meta.share])
          ? Math.max(0, Math.min(100, Math.round(feature.properties[meta.share])))
          : 0
      }));
    
    const districtName = feature.properties.districtName || `District ${feature.properties.DISTRICT}`;
    
    const renderBar = ({ label, pct, color, textColor }) => [
      '<div style=&quot;margin-top:8px;&quot;>',
      `<span style=&quot;font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;&quot;>${label}:</span>`,
      '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;&quot;>',
      `<div style=&quot;width:${pct || 0}%; background:${color}; height:100%; position:relative;&quot;>`,
      (pct >= 30
        ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${pct}%</span>`
        : ''),
      '</div>',
      (pct < 30
        ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${pct || 0}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${pct}%</span>`
        : ''),
      '</div>',
      '</div>'
    ].join('');
    
    const htmlContent = [
      '<div style=&quot;padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;&quot;>',
      `<strong style=&quot;font-size: 1.15rem; display: block; margin-bottom: 6px;&quot;>${districtName}</strong>`,
      
      '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;&quot;>',
      `<div style=&quot;width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;&quot;>`,
      (sharePct !== null && sharePct >= 30
        ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${sharePct}%</span>`
        : ''),
      '</div>',
      (sharePct !== null && sharePct < 30
        ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${sharePct}%</span>`
        : ''),
      '</div>',
      
      '<div style=&quot;height:6px;&quot;></div>',
      '<span style=&quot;font-size:0.95rem; font-weight:700;&quot;>Total:</span> ',
      `<span style=&quot;font-size:0.95rem;&quot;>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : '—'}</span>`,
      
      '<div style=&quot;height:8px;&quot;></div>',
      '<div style=&quot;height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;&quot;></div>',
      
      renderBar(others[0]),
      renderBar(others[1]),
      renderBar(others[2]),
      '</div>'
    ].join('');
    
    this.popup
      .setLngLat(e.lngLat)
      .setHTML(htmlContent)
      .addTo(this.map);
    
    const popupEl = this.popup.getElement();
    popupEl.style.zIndex = '9999';
    const contentEl = popupEl.querySelector('.maplibregl-popup-content');
    if (contentEl) {
      contentEl.style.padding = '8px';
      contentEl.style.boxSizing = 'border-box';
    }
}
},

handleDistrictLeave(layerType) {
  this.map.getCanvas().style.cursor = '';
  if (this.popup) {
    this.popup.remove();
  }

  window.dispatchEvent(new Event('legend-clear'));
  
  if (this.hoveredDistrictId !== undefined) {
    this.map.setFeatureState(
      { source: layerType, id: this.hoveredDistrictId },
      { hover: false }
    );
    this.hoveredDistrictId = undefined;
  }
},

getPaletteForParty(party) {
  const cfg = {
    democrat:   ['#d4f1ff', '#8fd6ff', '#4bbcff', '#009eff', '#0079d1', '#005aa3', '#003c75', '#001f47'],
    republican: ['#ffe0e0', '#ffb3b3', '#ff8080', '#ff4d4d', '#e00000', '#b30000', '#7a0000', '#330000'],
    'no-party': ['#fff6cc', '#ffe999', '#ffdc66', '#ffcf33', '#e0b300', '#b38600', '#7a5c00', '#332600'],
    other:      ['#d8fbf6', '#aff5ea', '#86efe0', '#5de9d6', '#22cdb8', '#199e8e', '#0f6f63', '#083934']
  };
  return cfg[party];
},
getSharePropKey(party) {
  return ({
    democrat: 'democratShare',
    republican: 'republicanShare',
    'no-party': 'noPartyShare',
    other: 'otherShare'
  })[party];
},
buildFillColorExpression(party) {
  const key = this.getSharePropKey(party);
  const breaks = this.getBreaksForParty(party);
  const colors = this.getPaletteForParty(party);
  const expr = ['case', ['==', ['get', key], null], '#cccccc'];
  for (let i = 0; i < breaks.length - 1; i++) {
    expr.push(['<', ['get', key], breaks[i]], colors[i]);
  }
  expr.push(colors[colors.length - 1]);
  return expr;
},

setupLayers() {
          if (!this.map || !this.geojsonData.county) return;

          const labelLayerId = this.map.getStyle().layers.find(l =>
            l.type === 'symbol' && l.layout && l.layout['text-field']
          )?.id;

          if (!this.map.getSource('counties')) {
            this.map.addSource('counties', {
  type: 'geojson',
  data: this.geojsonData.county,
  promoteId: '__id'
});

this.map.addLayer({
  id: 'counties-fill',
  type: 'fill',
  source: 'counties',
  paint: {
    'fill-color': this.buildFillColorExpression('democrat'),
    'fill-opacity': 1.0
  }
}, labelLayerId);


this.map.addLayer({
  id: 'counties-outline',
  type: 'line',
  source: 'counties',
  paint: {
    'line-color': [
      'case',
      ['boolean', ['feature-state', 'hover'], false],
      '#000000',
      '#ffffff'
    ],
    'line-width': [
      'case',
      ['boolean', ['feature-state', 'hover'], false],
      3,
      1
    ]
  }
}, labelLayerId);


this.map.addLayer({
  id: 'counties-outline-hover',
  type: 'line',
  source: 'counties',
  layout: {
    'line-join': 'round',
    'line-cap': 'round'
  },
  paint: {
    'line-color': '#000000',
    'line-width': 4,
    'line-opacity': [
      'case',
      ['boolean', ['feature-state', 'hover'], false],
      1,
      0
    ]
  }
});

this.map.on('mousemove', 'counties-fill', (e) => {
  if (e.features.length > 0) {
    this.map.getCanvas().style.cursor = 'crosshair';
    const feature = e.features[0];

    if (this.hoveredId !== feature.id) {
      if (this.hoveredId) {
        this.map.setFeatureState(
          { source: 'counties', id: this.hoveredId },
          { hover: false }
        );
      }
      this.hoveredId = feature.id;
      this.map.setFeatureState(
        { source: 'counties', id: this.hoveredId },
        { hover: true }
      );
    }

    if (!this.popup) {
      this.popup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false
      });
    }

    const partyKeyMap = {
      democrat:   { share: 'democratShare',   total: 'democratTotal',   color: '#0079d1', text: '#ffffff', label: 'Democrat' },
      republican: { share: 'republicanShare', total: 'republicanTotal', color: '#d70000', text: '#ffffff', label: 'Republican' },
      'no-party': { share: 'noPartyShare',    total: 'noPartyTotal',    color: '#ffcb03', text: '#000000', label: 'No Party' },
      other:      { share: 'otherShare',      total: 'otherTotal',      color: '#1b998b', text: '#ffffff', label: 'Other' }
    };

    const activeParty = this.selectedParty;
    const active = partyKeyMap[activeParty];

    const shareVal = feature.properties[active.share];
    const totalVal = feature.properties[active.total];
const sharePct = Number.isFinite(shareVal)
  ? Math.max(0, Math.min(100, Math.round(shareVal)))
  : null;

{
  const breaks = this.getBreaksForParty(activeParty);
  let idx = -1;
  if (Number.isFinite(sharePct)) {
    idx = breaks.findIndex(b => sharePct < b);
    if (idx === -1) idx = breaks.length - 1;
  }
  window.dispatchEvent(new CustomEvent('legend-active-bin', { detail: { party: activeParty, index: idx } }));
}

    const others = Object.entries(partyKeyMap)
      .filter(([k]) => k !== activeParty)
      .map(([k, meta]) => ({
        label: meta.label,
        color: meta.color,
        textColor: meta.text,
        pct: Number.isFinite(feature.properties[meta.share])
          ? Math.max(0, Math.min(100, Math.round(feature.properties[meta.share])))
          : 0
      }));

    const countyName = feature.properties.county_nam;

    const renderBar = ({ label, pct, color, textColor }) => [
      '<div style=&quot;margin-top:8px;&quot;>',
      `<span style=&quot;font-size:0.85rem; font-weight:600; display:block; margin-bottom:2px;&quot;>${label}:</span>`,
      '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin-left: 0;&quot;>',
      `<div style=&quot;width:${pct || 0}%; background:${color}; height:100%; position:relative;&quot;>`,
      (pct >= 30
        ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${textColor}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${pct}%</span>`
        : ''),
      '</div>',
      (pct < 30
        ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${pct ||
            0}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${pct}%</span>`
        : ''),
      '</div>',
      '</div>'
    ].join('');

    const htmlContent = [
      '<div style=&quot;padding: 10px; font-family: sans-serif; color: #111111; border-radius: 4px; position: relative; min-width: 240px; box-sizing: border-box;&quot;>',
      `<strong style=&quot;font-size: 1.15rem; display: block; margin-bottom: 6px;&quot;>${countyName} County</strong>`,

      '<div style=&quot;position: relative; width: calc(100% - 14px); height: 22px; border: 2px solid #000; background: #e5e7eb; box-sizing: border-box; overflow: visible; margin: 0;&quot;>',
      `<div style=&quot;width:${sharePct !== null ? sharePct : 0}%; background:${active.color}; height:100%; position:relative;&quot;>`,
      (sharePct !== null && sharePct >= 30
        ? `<span style=&quot;position:absolute; right:6px; top:50%; transform:translateY(-50%); color:${active.text}; font-weight:700; font-size:0.9rem; white-space:nowrap;&quot;>${sharePct}%</span>`
        : ''),
      '</div>',
      (sharePct !== null && sharePct < 30
        ? `<span style=&quot;position:absolute; top:50%; transform:translateY(-50%); left:calc(${sharePct}% + 8px); color:#111111; font-weight:700; font-size:0.95rem; white-space:nowrap;&quot;>${sharePct}%</span>`
        : ''),
      '</div>',

      '<div style=&quot;height:6px;&quot;></div>',
      '<span style=&quot;font-size:0.95rem; font-weight:700;&quot;>Total:</span> ',
      `<span style=&quot;font-size:0.95rem;&quot;>${Number.isFinite(totalVal) ? totalVal.toLocaleString() : '—'}</span>`,

      '<div style=&quot;height:8px;&quot;></div>',
      '<div style=&quot;height:1px; background:#d1d5db; width:calc(100% - 14px); margin-left:0;&quot;></div>',

      renderBar(others[0]),
      renderBar(others[1]),
      renderBar(others[2]),
      '</div>'
    ].join('');

    this.popup
      .setLngLat(e.lngLat)
      .setHTML(htmlContent)
      .addTo(this.map);

    const popupEl = this.popup.getElement();
    popupEl.style.zIndex = '9999';
    const contentEl = popupEl.querySelector('.maplibregl-popup-content');
    if (contentEl) {
      contentEl.style.padding = '8px';
      contentEl.style.boxSizing = 'border-box';
    }
  }
});


        this.map.on('mouseleave', 'counties-fill', () => {
          this.map.getCanvas().style.cursor = '';

          if (this.hoveredId) {
            this.map.setFeatureState(
              { source: 'counties', id: this.hoveredId },
              { hover: false }
            );
            this.hoveredId = null;
          }

if (this.popup) {
  this.popup.remove();
}
window.dispatchEvent(new Event('legend-clear'));

        });
}
          
        if (!this.map.getSource('house') && this.geojsonData.house) {
            this.map.addSource('house', {
              type: 'geojson',
              data: this.geojsonData.house,
              promoteId: 'DISTRICT'
            });
            this.map.addLayer({
              id: 'house-fill',
              type: 'fill',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': this.buildFillColorExpression(this.selectedParty),
                'fill-opacity': 1.0
              }
            }, labelLayerId);

            this.map.addLayer({
              id: 'house-outline',
              type: 'line',
              source: 'house',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#ffffff',
                'line-width': 1
              }
            }, labelLayerId);

            this.map.addLayer({
              id: 'house-outline-hover',
              type: 'line',
              source: 'house',
              layout: {
                visibility: 'none',
                'line-join': 'round',
                'line-cap': 'round'
              },
              paint: {
                'line-color': '#000000',
                'line-width': 4,
                'line-opacity': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  1,
                  0
                ]
              }
            }, labelLayerId);
            
            this.map.on('mousemove', 'house-fill', (e) => {
              if (this.selected === 'house') {
                this.handleDistrictHover(e, 'house');
              }
            });
            
            this.map.on('mouseleave', 'house-fill', () => {
              if (this.selected === 'house') {
                this.handleDistrictLeave('house');
              }
            });
          }


        if (!this.map.getSource('congressional') && this.geojsonData.congressional) {
            this.map.addSource('congressional', {
              type: 'geojson',
              data: this.geojsonData.congressional,
              promoteId: 'DISTRICT'
            });
            this.map.addLayer({
              id: 'congressional-fill',
              type: 'fill',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'fill-color': this.buildFillColorExpression(this.selectedParty),
                'fill-opacity': 1.0
              }
            }, labelLayerId);


            this.map.addLayer({
              id: 'congressional-outline',
              type: 'line',
              source: 'congressional',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#ffffff',
                'line-width': 1
              }
            }, labelLayerId);

            this.map.addLayer({
              id: 'congressional-outline-hover',
              type: 'line',
              source: 'congressional',
              layout: {
                visibility: 'none',
                'line-join': 'round',
                'line-cap': 'round'
              },
              paint: {
                'line-color': '#000000',
                'line-width': 4,
                'line-opacity': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  1,
                  0
                ]
              }
            }, labelLayerId);
            
            this.map.on('mousemove', 'congressional-fill', (e) => {
              if (this.selected === 'congressional') {
                this.handleDistrictHover(e, 'congressional');
              }
            });
            
            this.map.on('mouseleave', 'congressional-fill', () => {
              if (this.selected === 'congressional') {
                this.handleDistrictLeave('congressional');
              }
            });
          }

          if (!this.map.getSource('senate') && this.geojsonData.senate) {
                      this.map.addSource('senate', {
                        type: 'geojson',
                        data: this.geojsonData.senate,
                        promoteId: 'DISTRICT'
                      });
                      this.map.addLayer({
                        id: 'senate-fill',
                        type: 'fill',
                        source: 'senate',
                        layout: {
                          visibility: 'none'
                        },
                        paint: {
                          'fill-color': this.buildFillColorExpression(this.selectedParty),
                          'fill-opacity': 1.0
                        }
                      }, labelLayerId);


            this.map.addLayer({
              id: 'senate-outline',
              type: 'line',
              source: 'senate',
              layout: {
                visibility: 'none'
              },
              paint: {
                'line-color': '#ffffff',
                'line-width': 1
              }
            }, labelLayerId);

            this.map.addLayer({
              id: 'senate-outline-hover',
              type: 'line',
              source: 'senate',
              layout: {
                visibility: 'none',
                'line-join': 'round',
                'line-cap': 'round'
              },
              paint: {
                'line-color': '#000000',
                'line-width': 4,
                'line-opacity': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  1,
                  0
                ]
              }
            }, labelLayerId);
            
            this.map.on('mousemove', 'senate-fill', (e) => {
              if (this.selected === 'senate') {
                this.handleDistrictHover(e, 'senate');
              }
            });
            
            this.map.on('mouseleave', 'senate-fill', () => {
              if (this.selected === 'senate') {
                this.handleDistrictLeave('senate');
              }
            });
          }
          this.updateLayerVisibility();
        },

      updateLayerVisibility() {
          if (!this.map) return;

          const layers = {
            county: ['counties-fill', 'counties-outline', 'counties-outline-hover'],
            congressional: ['congressional-fill', 'congressional-outline', 'congressional-outline-hover'],
            senate: ['senate-fill', 'senate-outline', 'senate-outline-hover'],
            house: ['house-fill', 'house-outline', 'house-outline-hover']
          };

          Object.entries(layers).forEach(([key, layerIds]) => {
            const visibility = key === this.selected ? 'visible' : 'none';
            layerIds.forEach(id => {
              if (this.map.getLayer(id)) {
                this.map.setLayoutProperty(id, 'visibility', visibility);
              }
            });
          });
        },

        initMap() {
          const el = this.$refs.mapCanvas;
          if (!el || this.map) return;

          const mapComponent = window.maplibreComponent({
            id: 'pa-map',
            styleURL: 'https://tiles.openfreemap.org/styles/positron',
            bounds: [[-80.5199, 39.7198], [-74.6895, 42.26986]],
            padding: 24,
            minZoom: 3,
            maxZoom: 18,
            zoom: 6,
            controls: ['navigation'],
            attributionCompact: true
          });

          mapComponent.init.call({
            $refs: { canvas: el },
            map: null,
            _io: null,
            _ro: null,
            _initializing: false,
            _flyToHandler: null,
            _mobileViewHandler: null,
            _markerInstances: [],
            _baseMarkerInstances: [],
            ...mapComponent
          });

          setTimeout(() => {
            if (window.maplibregl && window.maplibregl.Map) {
              this.map = new maplibregl.Map({
                container: el,
                style: 'https://tiles.openfreemap.org/styles/positron',
                center: [-77.5, 40.9],
                zoom: 6,
                minZoom: 3,
                maxZoom: 18,
                attributionControl: false,
                cooperativeGestures: true
              });

              this.map.addControl(new maplibregl.NavigationControl({
                showCompass: false,
                showZoom: true,
                visualizePitch: false
              }), 'top-right');

              this.map.addControl(new maplibregl.AttributionControl({
                compact: true
              }));

        this.map.on('load', () => {
          this.map.fitBounds([[-80.5199, 39.7198], [-74.6895, 42.26986]], { padding: 24 });

          this.map.getStyle().layers.forEach(layer => {
            if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
              this.map.setPaintProperty(layer.id, 'text-halo-color', '#ffffff');
              this.map.setPaintProperty(layer.id, 'text-halo-width', 2.5);
              this.map.setPaintProperty(layer.id, 'text-halo-blur', 0.5);  
              this.map.setPaintProperty(layer.id, 'text-color', '#111111');
            }
          });

          Promise.all([
            this.joinCountyData(),
            this.joinDistrictData()
          ]).then(() => {
            this.setupLayers();
            if (this.map.getLayer('counties-fill')) {
              this.map.setPaintProperty('counties-fill', 'fill-color', this.buildFillColorExpression(this.selectedParty));
            }
          });

          this.map.getCanvas().addEventListener('mouseleave', () => {
            window.dispatchEvent(new Event('legend-clear'));
          });
        });


              this.loadGeoJSON();
            }
          }, 100);
        }
      }"
        x-init="
     initMap();

$watch('selected', () => {
  updateLayerVisibility();
  window.dispatchEvent(new Event('legend-clear'));
});

window.addEventListener('party-changed', (e) => {
  this.selectedParty = e.detail;
  const map = this.map;
  if (map) {
    ['counties-fill', 'congressional-fill', 'senate-fill', 'house-fill'].forEach((layerId) => {
      if (map.getLayer(layerId)) {
        map.setPaintProperty(layerId, 'fill-color', this.buildFillColorExpression(this.selectedParty));
      }
    });
    window.dispatchEvent(new Event('legend-clear'));
  }
});


          "
      >
        <div
          x-ref="mapCanvas"
          class="absolute inset-0 h-full w-full"
          style="overflow: visible;"
        ></div>

        <div
          class="absolute right-[50px] top-[10px] z-20 flex overflow-hidden rounded-md border border-g-3 bg-white shadow"
        >
          <button
            :data-checked="selected === 'county'"
            @click="selected='county'"
            title="County"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Counties
          </button>

          <button
            :data-checked="selected === 'congressional'"
            @click="selected='congressional'"
            title="Congressional"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Congressional
          </button>

          <button
            :data-checked="selected === 'senate'"
            @click="selected='senate'"
            title="Senate"
            class="border-r border-g-3 px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            Senate
          </button>

          <button
            :data-checked="selected === 'house'"
            @click="selected='house'"
            title="House"
            class="px-3 py-2 text-sm font-semibold text-black hover:bg-g-1 focus:outline-none focus:ring-2 focus:ring-g-4 active:bg-g-2 data-[checked=true]:bg-g-2"
          >
            House
          </button>
        </div>
      </div>
    </div>

    <div
      class="col-span-5 row-span-2 bg-black pb-2 pl-12 pr-2"
      x-ref="treemapContainer"
      x-show="datasets && datasets.total && datasets.total.length > 0"
      x-init="
        window.addEventListener('inspections-data-ready', () => {
          $nextTick(() => renderTreemap());
        });
        $watch('datasets', () => { 
          if (datasets && datasets.total && datasets.total.length > 0) { 
            $nextTick(() => renderTreemap()); 
          } 
        });
        window.addEventListener('resize', () => {
          if (datasets && datasets.total && datasets.total.length > 0) {
            renderTreemap();
          }
        });
      "
    ></div>

    <div class="col-span-12 row-span-2 bg-black px-12 py-8">
      <div
        x-data="{
    datasets: {},
    svg: null,
    init() {
      const onReady = (e) => { this.datasets = e.detail.datasets || {}; this.render(); };
      window.addEventListener('inspections-data-ready', onReady);
      window.addEventListener('inspections-data-updated', (e) => { this.datasets = (e.detail && e.detail.datasets) || this.datasets; this.render(); });
      window.addEventListener('resize', () => this.render());
      this.$nextTick(() => this.render());
    },
    parseRows() {
      const rows = (this.datasets['party-year'] || []).map(d => ({
        Year: +d.Year,
        Democrat: +d.Democrat,
        Republican: +d.Republican,
        Other: +(d['Other Parties'] ?? d.Other ?? 0)
      })).filter(d => Number.isFinite(d.Year));
      rows.sort((a,b) => a.Year - b.Year);
      return rows;
    },
    render() {
      const data = this.parseRows();
      const wrap = this.$refs.wrap;
      const svg = d3.select(this.$refs.svg);

      if (!wrap || data.length === 0) {
        if (svg) svg.selectAll('*').remove();
        return;
      }

      const W = Math.max(640, wrap.clientWidth);
      const H = Math.max(300, wrap.clientHeight);
      const margin = { top: 12, right: 96, bottom: 30, left: 64 };
      const width = W - margin.left - margin.right;
      const height = H - margin.top - margin.bottom;

      svg.selectAll('*').remove();
      svg.attr('viewBox', `0 0 ${W} ${H}`);

      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const series = [
        { key: 'Democrat',   color: '#009edb', label: 'Democrat' },
        { key: 'Republican', color: '#d70000', label: 'Republican' },
        { key: 'Other',      color: '#1b998b', label: 'Other parties' }
      ];

      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.Year))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => Math.max(d.Democrat, d.Republican, d.Other)) * 1.05])
        .nice()
        .range([height, 0]);

      g.append('g')
        .attr('class', 'y-grid')
        .attr('opacity', 0.25)
        .call(d3.axisLeft(y).tickSize(-width).tickFormat('').tickSizeOuter(0))
        .call(g => g.select('.domain').remove())
        .selectAll('line').attr('stroke', '#9ca3af');

      g.append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0,${height})`)
        .call(
          d3.axisBottom(x)
            .tickFormat(d => d === 1998 ? '' : d3.format('d')(d))
            .tickSize(0)
        )
        .call(a => a.selectAll('text').attr('font-size', 14).attr('fill', '#888').attr('dy', '1em'));


      g.append('g')
        .attr('class', 'y-axis')
        .call(
          d3.axisLeft(y)
            .ticks(6)
            .tickFormat(d => d === 0 ? '' : d3.format('~s')(d).replace('G','B'))
            .tickSize(0)
        )
        .call(a => a.selectAll('text').attr('font-size', 14).attr('fill', '#A2A2A2').attr('dx', '-3'))
        .call(a => a.select('.domain').remove());

      const line = d3.line()
        .defined(d => Number.isFinite(d.value))
        .x(d => x(d.Year))
        .y(d => y(d.value))
        .curve(d3.curveMonotoneX);

      series.forEach(s => {
        const values = data.map(d => ({ Year: d.Year, value: d[s.key] }));
        g.append('path')
          .datum(values)
          .attr('fill', 'none')
          .attr('stroke', s.color)
          .attr('stroke-width', 3)
          .attr('d', line);
      });

      const shortLabel = { Democrat: 'Dem.', Republican: 'Rep.', Other: 'Other' };
      series.forEach(s => {
        const last = data[data.length - 1];
        if (Number.isFinite(last[s.key])) {
          g.append('text')
            .attr('x', x(last.Year) + 6)
            .attr('y', y(last[s.key]))
            .attr('dominant-baseline', 'middle')
            .attr('font-weight', 700)
            .attr('font-size', 14)
            .attr('fill', s.color)
            .text(shortLabel[s.key]);
        }
      });

      const bisect = d3.bisector(d => d.Year).left;

      const focus = g.append('g').style('display', 'none');
      focus.append('line')
        .attr('class', 'x-guide')
        .attr('y1', 0).attr('y2', height)
        .attr('stroke', '#111').attr('stroke-dasharray', '3,3').attr('opacity', 0.4);

      const dots = {};
      series.forEach(s => {
        dots[s.key] = focus.append('circle').attr('r', 4.5).attr('fill', s.color).attr('stroke', '#fff').attr('stroke-width', 1.5);
      });

      const tooltip = d3.select(this.$refs.tooltip);

      svg.append('rect')
        .attr('transform', `translate(${margin.left},${margin.top})`)
        .attr('width', width).attr('height', height)
        .attr('fill', 'transparent')
        .style('cursor', 'crosshair')
        .on('mousemove', (event) => {
          const [px] = d3.pointer(event);
          const year = Math.round(x.invert(px));
          const idx = Math.min(Math.max(bisect(data, year) - 1, 0), data.length - 1);
          const d = data[idx];

          focus.style('display', null);
          focus.select('.x-guide').attr('transform', `translate(${x(d.Year)},0)`);

          series.forEach(s => {
            dots[s.key].attr('cx', x(d.Year)).attr('cy', y(d[s.key]));
          });

          tooltip.classed('hidden', false)
            .html(`
              <div style='font-weight:700; margin-bottom:4px'>${d.Year}</div>
              <div>Democrat: ${d3.format(',')(d.Democrat)}</div>
              <div>Republican: ${d3.format(',')(d.Republican)}</div>
              <div>Other: ${d3.format(',')(d.Other)}</div>
            `);

          const tW = tooltip.node().offsetWidth || 140;
          const tH = tooltip.node().offsetHeight || 60;
          const tx = margin.left + x(d.Year) + 12 + tW > W ? margin.left + x(d.Year) - 12 - tW : margin.left + x(d.Year) + 12;
          const minY = Math.min(y(d.Democrat), y(d.Republican), y(d.Other));
          const ty = margin.top + minY - tH - 8;
          tooltip.style('left', `${Math.max(8, tx)}px`).style('top', `${Math.max(8, ty)}px`);
        })
        .on('mouseleave', () => {
          focus.style('display', 'none');
          tooltip.classed('hidden', true);
        });
    }
  }"
        class="h-full w-full bg-g-1 p-4"
      >
        <div
          x-ref="wrap"
          class="relative h-[360px] w-full md:h-[420px] lg:h-[460px]"
        >
          <svg x-ref="svg" class="absolute inset-0 h-full w-full"></svg>
          <div
            x-ref="tooltip"
            class="pointer-events-none absolute hidden rounded bg-black/90 px-2 py-1 text-xs font-semibold text-white shadow"
          ></div>
        </div>
      </div>
    </div>
  </div>
{{ end }}

{{ define "extra-head" }}
  {{ partial "header/maplibre.html" . }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
{{ end }}

{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}
