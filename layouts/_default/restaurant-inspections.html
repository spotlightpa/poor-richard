{{ define "main" }}
  <section class="mt-6 bg-black pb-6">
    <div
      class="mx-auto w-full max-w-screen-xl flex-wrap gap-4 px-4 pt-16 md:gap-x-6 md:px-0 lg:gap-x-12"
    >
      {{ with .Param "eyebrow" }}
        <div class="mx-auto w-full md:w-7/12">
          <p
            class="ga:component:main:header:eyebrow text-small inline-block border-2 border-white bg-white px-2 font-sans font-semibold uppercase text-black md:text-lg"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <h1
        class="mx-auto mt-4 w-full pb-2 font-serif text-3xl font-semibold leading-tight text-white sm:text-4xl md:w-7/12 lg:text-5xl"
      >
        {{ .Title }}
      </h1>

      {{ $byline := .Param "byline" }}
      {{ $outlet := .Param "outlet" | default "Spotlight PA" }}
      {{ $bylineLink := "" }}

      {{ with .Param "authors" }}
        {{ if len . | eq 1 }}
          {{ $name := index . 0 }}
          {{ $author := partial "helper/get-author" $name }}
          {{ if $author.link }}
            {{ $bylineLink = $author.link }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $byline }}
        <div
          class="mx-auto mt-4 w-full text-lg leading-none text-white md:w-7/12 lg:text-xl"
        >
          <span class="font-sans">
            by
            {{ if $bylineLink }}
              <a
                href="{{ $bylineLink }}"
                class="font-semibold underline hover:text-yellow"
                >{{ $byline }}</a
              >
            {{ else }}
              <span class="font-semibold">{{ $byline }}</span>
            {{ end }}
            of
            {{ $outlet }}
          </span>
        </div>
      {{ end }}


      <div class="mx-auto w-full md:w-7/12">
        {{ partial "tw/horizontal-social-buttons.html" . }}
      </div>

      {{ with .Param "deck" }}
        <div class="mx-auto mt-4 w-full md:w-7/12">
          <p class="font-serif text-xl text-white md:text-2xl md:leading-tight">
            {{ . }}
          </p>
        </div>
      {{ end }}

      {{ with .Param "search-instructions" }}
        <div class="mx-auto mt-8 w-full md:w-7/12">
          <p
            class="font-serif text-xl italic text-white md:text-2xl md:leading-tight"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <div
        class="mx-auto mt-6 w-full md:w-7/12"
        x-data="inspectionsUI()"
        x-init="init()"
      >
        {{ partial "blocks/search.html" (dict
          "placeholder" (default "Search restaurants" (.Param "search-placeholder"))
          "showLocation" (.Param "search-location")
          "context" .
          )
        }}
      </div>
    </div>
  </section>

  {{ partial "blocks/mobile-scroll.html" . }}


  <section class="bg-white" data-ga-category="about">
    <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
      <div class="mx-auto w-full space-y-8 md:w-7/12">
        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "about-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "about-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "questions-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "questions-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "tips-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "tips-description" }}
          </p>
        </div>
      </div>
    </div>
  </section>

  {{ with .Page.RenderString (.Param "credits") }}
    <section
      class="bg-white"
      id="credits"
      data-ga-category="credits"
      x-data
      x-intersect.half="$dispatch('intersect:about', $el.id)"
    >
      <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
        <div class="mx-auto w-full md:w-7/12">
          <h2
            class="w-full border-b border-black font-sans text-2xl font-extrabold capitalize leading-tight tracking-wide md:text-3xl"
          >
            Credits
          </h2>
          <div class="space-y-8 py-6">
            {{ . }}
          </div>
        </div>
      </div>
    </section>
  {{ end }}

  <script>
    function inspectionsUI() {
      return {
        q: "",
        cards: [],
        index: new Map(),
        activeCard: null,
        lastReadMoreButton: null,
        initializedDelegates: false,

        init() {
          this.cards = Array.from(document.querySelectorAll('[data-card="inspection"]'));
          this.cards.forEach((card) => {
            if (!card.querySelector('.list-content')) {
              const wrap = document.createElement('div');
              wrap.className = 'list-content';
              while (card.firstChild) wrap.appendChild(card.firstChild);
              card.appendChild(wrap);
            }
          });
          const norm = (s) => (s || "").toLowerCase().replace(/[^a-z0-9\s]/g, "").replace(/\s+/g, " ").trim();
          this.cards.forEach((card) => {
            this.index.set(card, norm(card.dataset.index || card.textContent));
          });
          this.applySearch();
          if (!this.initializedDelegates) {
            document.addEventListener("click", (e) => {
              const readMoreBtn = e.target.closest('button[aria-label="Read more about this inspection"]');
              if (readMoreBtn) {
                e.preventDefault();
                const card = readMoreBtn.closest('[data-card="inspection"]');
                if (card) {
                  this.lastReadMoreButton = readMoreBtn;
                  this.openDetails(card);
                }
                return;
              }
              const backBtn = e.target.closest('[data-action="back-to-results"]');
              if (backBtn) {
                e.preventDefault();
                this.backToResults();
                return;
              }
            });
            this.initializedDelegates = true;
          }
        },

        norm(s) { return (s || "").toLowerCase().replace(/[^a-z0-9\s]/g, "").replace(/\s+/g, " ").trim(); },
        syncHidden(card) {
          const hide = card.classList.contains('hidden-by-search') || card.classList.contains('hidden-by-detail');
          card.classList.toggle('hidden', hide);
        },
        escapeHTML(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); },

        doSearch(val) { if (typeof val === "string") this.q = val; this.applySearch(); },
        applySearch() {
          const needle = this.norm(this.q); let visible = 0;
          this.cards.forEach((card) => {
            const hit = !needle || this.index.get(card).includes(needle);
            card.classList.toggle('hidden-by-search', !hit);
            this.syncHidden(card);
            if (!card.classList.contains('hidden')) visible++;
          });
          const noResultsEl = document.getElementById("no-results");
          if (noResultsEl) noResultsEl.classList.toggle("hidden", visible !== 0);
        },

        openDetails(card) {
          this.cards.forEach((c) => {
            if (c !== card) c.classList.add('hidden-by-detail');
            else c.classList.remove('hidden-by-detail');
            this.syncHidden(c);
          });
          const body = card;
          const listContent = body.querySelector('.list-content');
          let detail = body.querySelector('.detail-content');
          if (!detail) {
            detail = document.createElement('div');
            detail.className = 'detail-content';
            body.appendChild(detail);
          }
          detail.innerHTML = this.buildDetailHTML(card);
          listContent?.classList.add('hidden');
          detail.querySelector('[data-action="back-to-results"]')?.focus({ preventScroll: true });
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
          this.activeCard = card;
          document.getElementById("no-results")?.classList.add("hidden");
        },

        backToResults() {
          if (!this.activeCard) return;
          const card = this.activeCard;
          card.querySelector('.detail-content')?.remove();
          card.querySelector('.list-content')?.classList.remove('hidden');
          this.cards.forEach((c) => { c.classList.remove('hidden-by-detail'); this.syncHidden(c); });
          this.applySearch();
          this.lastReadMoreButton?.focus({ preventScroll: true });
          this.activeCard = null;
        },

        buildDetailHTML(card) {
          const title = (card.querySelector('h2')?.textContent || '').trim();
          const infoLines = Array.from(card.querySelectorAll('.list-content span')).map(n => n.textContent.trim());
          const location = infoLines.find(t => !/Last inspection:/i.test(t)) || '';
          const lastDate = (infoLines.find(t => /Last inspection:/i.test(t)) || '').replace(/^Last inspection:\s*/i, '');
          const violations = this.readViolations(card);
          const items = violations.map(v => this.renderViolationItem(v)).join('') || `    <li class="space-y-2">
      <div class="flex items-start pt-3 gap-2">
        <svg class="mt-1 h-5 w-5 fill-election-green" aria-hidden="true">
          {{ partial "helper/svg.html" "circle-check" }}
        </svg>
        <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
          No violations reported.
        </h4>
      </div>
    </li>`;
          return `

            <div>

              <button
                type="button"
                class="inline-flex items-center font-sans font-bold text-black-9 hover:text-yellow-3"
                data-action="back-to-results"
                aria-label="Back to results"
              >
                <svg class="h-5 w-5 flex-shrink-0 fill-current" aria-hidden="true">
                  {{ partial "helper/svg.html" "chevron-left" }}
                </svg>
                <span class="ml-1.5">Back</span>
              </button>

              <div class="flex items-start justify-between gap-6 py-4 pr-4 sm:pr-6">

                  <div class="min-w-0">
                    <h2 class="text-3xl font-bold text-black break-words">${this.escapeHTML(title)}</h2>

                  <div class="mt-2 space-y-1 text-g-6">
                    ${location ? `
                      <div class="flex items-center gap-1">
                        <svg class="h-4 w-4 flex-shrink-0 fill-g-5" aria-hidden="true">
                          {{ partial "helper/svg.html" "map-pin" }}
                        </svg>
                        <span>${this.escapeHTML(location)}</span>
                      </div>
                    ` : ''}
                  </div>

                    <div class="mt-3">

                    <button class="inline-flex items-center gap-2 rounded-md border-2 border-yellow-5 bg-yellow-4 px-4 py-2 font-sans font-semibold text-yellow-9 hover:bg-yellow-3">
                      <span>Get alerts</span>
                      <svg class="h-5 w-5 fill-yellow-9" aria-hidden="true">
                        {{ partial "helper/svg.html" "bell" }}
                      </svg>
                    </button>


                      <p class="mt-2 text-sm font-sans text-g-6">Receive an email when new reports are available for this facility.</p>
                    </div>
                  </div>

        {{/*  switch to horizontal in line buttons for responsiveness  */}}

        {{/*  <div class="shrink-0 flex flex-col items-center gap-2 sm:flex mt-[-4px]">
          <!-- Email -->
          <button class="rounded-full p-2 hover:bg-g-2" aria-label="Share via Email">
            <svg class="h-5 w-5 fill-g-7" aria-hidden="true">
              {{ partial "helper/svg.html" "envelope" }}
            </svg>
          </button>

          <!-- Facebook -->
          <button class="rounded-full p-2 hover:bg-g-2" aria-label="Share on Facebook">
            <svg class="h-5 w-5 fill-[#1877F2]" aria-hidden="true">
              {{ partial "helper/svg.html" "fb" }}
            </svg>
          </button>

          <!-- X (Twitter) -->
          <button class="rounded-full p-2 hover:bg-g-2" aria-label="Share on X">
            <svg class="h-5 w-5 fill-black" aria-hidden="true">
              {{ partial "helper/svg.html" "twitter" }}
            </svg>
          </button>

          <!-- Generic Share -->
          <button class="rounded-full p-2 hover:bg-g-2" aria-label="Copy link">
            <svg class="h-5 w-5 fill-g-7" aria-hidden="true">
              {{ partial "helper/svg.html" "share" }}
            </svg>
          </button>
        </div>  */}}


      </div>
    <section aria-labelledby="violations-title" class="space-y-3">

      <ul class="space-y-3">${items}</ul>
    </section>


<div class="pt-5">
  <a href="#"
     class="group inline-flex items-center gap-2 font-sans font-semibold text-navy hover:text-blue">
    <svg class="h-5 w-5 flex-shrink-0 fill-current group-hover:text-blue"
         aria-hidden="true">
      {{ partial "helper/svg.html" "link" }}
    </svg>
    <span>Read the full report</span>
  </a>
</div>

`;
  },

        renderViolationItem(v) {
          const { level = 'low', title = '', comment = '' } = v;

          const iconFill =
            level === 'high' ? 'fill-red-7'
            : level === 'moderate' ? 'fill-yellow-4'
            : 'fill-blue-6';

          const words = title.split(/\s+/);
          const lastWord = words.pop();
          const before = words.join(' ');

          return `
            <li class="space-y-2">
              <div class="flex items-start pt-5 gap-2">
                <svg class="mt-1 h-5 w-5 ${iconFill}" aria-hidden="true">
                  {{ partial "helper/svg.html" "triangle-exclamation" }}
                </svg>
                <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
                  ${before}
                  <span class="inline-flex items-center gap-1">
                    ${lastWord}
                    <svg class="h-5 w-5 ml-1 color-red" aria-hidden="true">
                      {{ partial "helper/svg.html" "circle-question" }}
                    </svg>
                  </span>
                </h4>
              </div>
              ${comment ? `
                <p class="font-serif leading-relaxed text-g-7 border-l-4 border-g-5 pl-4">
                  ${this.escapeHTML(comment)}
                </p>` : ''
              }
            </li>`;
        },

        readViolations(card) {
          const list = card.querySelector('ul.violations-data');
          if (list) {
            return Array.from(list.querySelectorAll('li')).map(li => ({
              level: li.getAttribute('data-level') || '',
              title: li.querySelector('h4')?.textContent?.trim() || '',
              comment: li.querySelector('p')?.textContent?.trim() || ''
            })).filter(v => v.title || v.comment);
          }
          const csv = card.getAttribute('data-violations-csv');
          if (csv) return this.parseViolationsCSV(csv);
          return [];
        },

        parseViolationsCSV(csvText) {
          const rows = []; let i = 0, s = csvText;
          const nextField = () => {
            if (s[i] === '"') {
              i++; let out = '';
              while (i < s.length) {
                if (s[i] === '"' && s[i+1] === '"') { out += '"'; i += 2; continue; }
                if (s[i] === '"' && (s[i+1] === ',' || s[i+1] === '\n' || i+1 === s.length)) { i++; return out; }
                out += s[i++];
              }
              return out;
            } else {
              const start = i;
              while (i < s.length && s[i] !== ',' && s[i] !== '\n') i++;
              return s.slice(start, i);
            }
          };
          const consume = ch => { if (s[i] === ch) i++; };
          const peek = s.slice(0, 48).toLowerCase();
          const hasHeader = peek.includes('level') && peek.includes('title');
          if (hasHeader) { while (i < s.length && s[i] !== '\n') i++; if (s[i] === '\n') i++; }
          while (i < s.length) {
            const level = nextField(); consume(',');
            const title = nextField(); consume(',');
            const comment = nextField();
            while (i < s.length && s[i] !== '\n') i++;
            if (s[i] === '\n') i++;
            if (title || comment) rows.push({ level, title, comment });
          }
          return rows;
        }
      };
    }
  </script>
{{ end }}
