{{ define "extra-head" }}
  {{ partial "header/maplibre.html" . }}
{{ end }}

{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}

{{ define "main" }}
  <section class="mt-6 bg-black pb-6">
    <div
      class="mx-auto w-full max-w-screen-xl flex-wrap gap-4 px-4 pt-16 md:gap-x-6 md:px-0 lg:gap-x-12"
    >
      {{ with .Param "eyebrow" }}
        <div class="mx-auto w-full md:w-7/12">
          <p
            class="ga:component:main:header:eyebrow text-small inline-block border-2 border-white bg-white px-2 font-sans font-semibold uppercase text-black md:text-lg"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <h1
        class="mx-auto mt-4 w-full pb-2 font-serif text-3xl font-semibold leading-tight text-white sm:text-4xl md:w-7/12 lg:text-5xl"
      >
        {{ .Title }}
      </h1>

      {{ $byline := .Param "byline" }}
      {{ $outlet := .Param "outlet" | default "Spotlight PA" }}
      {{ $bylineLink := "" }}

      {{ with .Param "authors" }}
        {{ if len . | eq 1 }}
          {{ $name := index . 0 }}
          {{ $author := partial "helper/get-author" $name }}
          {{ if $author.link }}
            {{ $bylineLink = $author.link }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $byline }}
        <div
          class="mx-auto mt-4 w-full text-lg leading-none text-white md:w-7/12 lg:text-xl"
        >
          <span class="font-sans">
            by
            {{ if $bylineLink }}
              <a
                href="{{ $bylineLink }}"
                class="font-semibold underline hover:text-yellow"
                >{{ $byline }}</a
              >
            {{ else }}
              <span class="font-semibold">{{ $byline }}</span>
            {{ end }}
            of
            {{ $outlet }}
          </span>
        </div>
      {{ end }}


      <div class="mx-auto w-full md:w-7/12">
        {{ partial "tw/horizontal-social-buttons.html" . }}
      </div>

      {{ with .Param "deck" }}
        <div class="mx-auto mt-4 w-full md:w-7/12">
          <p class="font-serif text-xl text-white md:text-2xl md:leading-tight">
            {{ . }}
          </p>
        </div>
      {{ end }}

      {{ with .Param "search-instructions" }}
        <div class="mx-auto mt-8 w-full md:w-7/12">
          <p
            class="font-serif text-xl italic text-white md:text-2xl md:leading-tight"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <div
        x-data="mobileViewToggle()"
        x-init="init()"
        class="mx-auto mb-4 mt-12 w-full md:hidden md:w-7/12"
      >
        <div
          class="flex w-full overflow-hidden rounded border-[3px] border-yellow"
        >
          <button
            @click="setView('list')"
            :class="view === 'list' 
            ? 'bg-yellow' 
            : 'bg-white'"
            class="w-1/2 border-r-[3px] border-yellow py-3 pl-4 pr-12 text-center font-sans text-2xl font-bold text-yellow-9 transition-colors duration-200"
          >
            List
          </button>

          <button
            @click="setView('map')"
            :class="view === 'map' 
            ? 'bg-yellow' 
            : 'bg-white'"
            class="w-1/2 py-3 pl-4 pr-12 text-center font-sans text-2xl font-bold text-yellow-9 transition-colors duration-200"
          >
            Map
          </button>
        </div>
      </div>

      <div
        class="mx-auto mt-6 w-full md:hidden"
        x-data="inspectionsUI()"
        x-init="init()"
      >
        {{ partial "blocks/search.html" (dict
          "placeholder" (default "Search restaurants" (.Param "search-placeholder"))
          "showLocation" (.Param "search-location")
          "context" .
          )
        }}
      </div>
    </div>
  </section>

  <section class="hidden md:block" x-data="inspectionsUI()" x-init="init()">
    <div class="bg-black pb-8 md:pb-8"></div>
    <div class="w-full bg-white px-4 md:px-0">
      <div class="grid h-[600px] grid-cols-[1fr_auto_2fr_2fr]">
        <div class="flex flex-col px-4 py-3">
          <h3 class="font-sans text-xl font-bold">Sort By</h3>

          <div class="mt-4 hidden space-y-3 md:block">
            <label
              class="flex cursor-pointer items-center gap-3 rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 font-sans text-base font-semibold text-yellow-9"
            >
              <input
                type="radio"
                name="sort"
                value="date"
                class="h-5 w-5 shrink-0 accent-yellow-9"
                checked
              />
              <span>Most Recent</span>
            </label>

            <label
              class="flex cursor-pointer items-center gap-3 rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 font-sans text-base font-semibold text-yellow-9"
            >
              <input
                type="radio"
                name="sort"
                value="high-risk"
                class="h-5 w-5 shrink-0 accent-yellow-9"
              />
              <span>Highest Risk</span>
            </label>

            <label
              class="flex cursor-pointer items-center gap-3 rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 font-sans text-base font-semibold text-yellow-9"
            >
              <input
                type="radio"
                name="sort"
                value="alphabetical"
                class="h-5 w-5 shrink-0 accent-yellow-9"
              />
              <span>Alphabetical</span>
            </label>
          </div>

          <div class="my-6 border-t-2 border-g-2"></div>
          <h3 class="font-sans text-xl font-bold">Filter</h3>

          <div class="mt-4 hidden flex-col gap-3 md:flex">
            <div class="relative">
              <select
                id="cuisine-filter"
                class="w-full cursor-pointer appearance-none rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 pr-10 font-sans text-base font-semibold text-yellow-9 focus:border-yellow-5 focus:outline-none focus:ring-1 focus:ring-yellow-5"
              >
                <option value="">All Cuisines</option>
                <option value="american">American</option>
                <option value="italian">Italian</option>
                <option value="chinese">Chinese</option>
                <option value="mexican">Mexican</option>
                <option value="other">Other</option>
              </select>
              <svg
                class="pointer-events-none absolute right-4 top-1/2 h-5 w-5 -translate-y-1/2 fill-yellow-9"
              >
                {{ partial "helper/svg.html" "chevron" }}
              </svg>
            </div>

            <div class="relative">
              <select
                id="city-filter"
                class="w-full cursor-pointer appearance-none rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 pr-10 font-sans text-base font-semibold text-yellow-9 focus:border-yellow-5 focus:outline-none focus:ring-1 focus:ring-yellow-5"
              >
                <option value="">All Cities</option>
                <option value="Aliquippa">Aliquippa</option>
                <option value="Allentown">Allentown</option>
                <option value="Altoona">Altoona</option>
                <option value="Arnold">Arnold</option>
                <option value="Beaver Falls">Beaver Falls</option>
                <option value="Bethlehem">Bethlehem</option>
                <option value="Bradford">Bradford</option>
                <option value="Butler">Butler</option>
                <option value="Carbondale">Carbondale</option>
                <option value="Chester">Chester</option>
                <option value="Clairton">Clairton</option>
                <option value="Coatesville">Coatesville</option>
                <option value="Connellsville">Connellsville</option>
                <option value="Corry">Corry</option>
                <option value="DuBois">DuBois</option>
                <option value="Duquesne">Duquesne</option>
                <option value="Easton">Easton</option>
                <option value="Erie">Erie</option>
                <option value="Farrell">Farrell</option>
                <option value="Franklin">Franklin</option>
                <option value="Greensburg">Greensburg</option>
                <option value="Harrisburg">Harrisburg</option>
                <option value="Hazleton">Hazleton</option>
                <option value="Hermitage">Hermitage</option>
                <option value="Jeannette">Jeannette</option>
                <option value="Johnstown">Johnstown</option>
                <option value="Lancaster">Lancaster</option>
                <option value="Lebanon">Lebanon</option>
                <option value="Lock Haven">Lock Haven</option>
                <option value="Lower Burrell">Lower Burrell</option>
                <option value="McKeesport">McKeesport</option>
                <option value="Meadville">Meadville</option>
                <option value="Monessen">Monessen</option>
                <option value="Monongahela">Monongahela</option>
                <option value="Nanticoke">Nanticoke</option>
                <option value="New Castle">New Castle</option>
                <option value="New Kensington">New Kensington</option>
                <option value="Oil City">Oil City</option>
                <option value="Parker">Parker</option>
                <option value="Philadelphia">Philadelphia</option>
                <option value="Pittsburgh">Pittsburgh</option>
                <option value="Pittston">Pittston</option>
                <option value="Pottsville">Pottsville</option>
                <option value="Reading">Reading</option>
                <option value="Scranton">Scranton</option>
                <option value="Shamokin">Shamokin</option>
                <option value="Sharon">Sharon</option>
                <option value="St. Marys">St. Marys</option>
                <option value="Sunbury">Sunbury</option>
                <option value="Titusville">Titusville</option>
                <option value="Uniontown">Uniontown</option>
                <option value="Warren">Warren</option>
                <option value="Washington">Washington</option>
                <option value="Wilkes-Barre">Wilkes-Barre</option>
                <option value="Williamsport">Williamsport</option>
                <option value="York">York</option>
                <option value="Other">Other</option>
              </select>
              <svg
                class="pointer-events-none absolute right-4 top-1/2 h-5 w-5 -translate-y-1/2 fill-yellow-9"
              >
                {{ partial "helper/svg.html" "chevron" }}
              </svg>
            </div>
          </div>

          <button
            @click="
          document.getElementById('cuisine-filter').value = '';
          document.getElementById('city-filter').value = '';
          currentCity = '';
          applyFilters();
        "
            class="mt-5 w-full rounded border-2 border-red-7 bg-red-5 px-4 py-2 font-sans text-base font-semibold text-white transition-colors duration-200 hover:bg-red-7 hover:text-white"
          >
            Clear
          </button>
        </div>

        <div aria-hidden="true" class="h-full w-3 bg-g-3"></div>

        <div class="flex min-h-0 flex-col">
          <div class="md:bg-white md:p-4 md:shadow">
            {{ partial "blocks/search.html" (dict
              "placeholder" (default "Search" (or (.Param "search-desktop-placeholder") (.Param "search-placeholder")))
              "showLocation" (.Param "search-location")
              "context" .
              )
            }}
          </div>

          <div
            class="relative min-h-0 grow overflow-hidden rounded-t-[40px] bg-g-3 md:rounded-none"
            x-data="customScroll()"
            x-init="init()"
            @resize.window="update()"
          >
            <div
              x-ref="viewport"
              class="sb-hide h-full overflow-y-auto bg-white pr-[12px]"
              @scroll="onScroll()"
              tabindex="0"
              aria-label="Inspection results list"
            >
              {{ partial "blocks/mobile-scroll.html" . }}
            </div>

            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex w-[12px] items-stretch"
              aria-hidden="true"
            >
              <div
                x-ref="track"
                class="pointer-events-auto relative h-full w-full rounded-none bg-g-4 [box-shadow:inset_0_0_0_1px_rgba(0,0,0,0.06)]"
                @mousedown.prevent="startDrag($event)"
                @click.stop="trackJump($event)"
              >
                <div
                  x-ref="thumb"
                  class="absolute left-0 right-0 w-full rounded-none bg-g-7"
                  :style="thumbStyle"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex h-full flex-col">
          {{ partial "blocks/maplibre-assets.html" (dict
            "ctx" .
            "id" "inspections-map"
            "ariaLabel" "Pennsylvania inspections map"
            "class" "relative h-full w-full"
            )
          }}
        </div>
      </div>
    </div>
  </section>

  <div
    class="md:hidden"
    x-data="mobileViewToggle()"
    x-init="init()"
    @mobile-view-changed.window="view = $event.detail.view"
  >
    <div x-show="view === 'list'">
      {{ partial "blocks/mobile-scroll.html" . }}
    </div>

    <template x-if="view === 'map'">
      <div class="h-[500px] w-full bg-white">
        {{ partial "blocks/maplibre-assets.html" (dict
          "ctx" .
          "id" "inspections-map-mobile"
          "ariaLabel" "Pennsylvania inspections map"
          "class" "relative h-full w-full"
          )
        }}
      </div>
    </template>
  </div>

  {{ partial "tw/newsletter-box-lg.html" (dict
    "newsletterDek" "Sign up for PA Post to understand what's happening across PA - in less than five minutes a day."
    "newsletterField" "newsletter/papost-hidden.html"
    )
  }}


  <section class="bg-white" data-ga-category="about">
    <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
      <div class="mx-auto w-full space-y-8 md:w-7/12">
        <div>
          <h2 class="mt-6 font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "about-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "about-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "questions-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "questions-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "tips-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "tips-description" }}
          </p>
        </div>
      </div>
    </div>
  </section>

  {{ with .Page.RenderString (.Param "credits") }}
    <section
      class="bg-white"
      id="credits"
      data-ga-category="credits"
      x-data
      x-intersect.half="$dispatch('intersect:about', $el.id)"
    >
      <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
        <div class="mx-auto w-full md:w-7/12">
          <h2
            class="w-full border-b border-black font-sans text-2xl font-extrabold capitalize leading-tight tracking-wide md:text-3xl"
          >
            Credits
          </h2>
          <div class="space-y-8 py-6">
            {{ . }}
          </div>
        </div>
      </div>
    </section>
  {{ end }}


  <script>
    function mobileViewToggle() {
      return {
        view: "list",

        init() {
          this.view = "list";
        },

        setView(newView) {
          this.view = newView;
          window.dispatchEvent(
            new CustomEvent("mobile-view-changed", {
              detail: { view: newView },
            }),
          );
        },
      };
    }

    function inspectionsUI() {
      return {
        q: "",
        cards: [],
        index: new Map(),
        cityMap: new Map(),
        activeCard: null,
        lastReadMoreButton: null,
        initializedDelegates: false,
        dataLoaded: false,
        currentSort: "date",
        currentCity: "",
        paCities: [
          "Aliquippa",
          "Allentown",
          "Altoona",
          "Arnold",
          "Beaver Falls",
          "Bethlehem",
          "Bradford",
          "Butler",
          "Carbondale",
          "Chester",
          "Clairton",
          "Coatesville",
          "Connellsville",
          "Corry",
          "DuBois",
          "Duquesne",
          "Easton",
          "Erie",
          "Farrell",
          "Franklin",
          "Greensburg",
          "Harrisburg",
          "Hazleton",
          "Hermitage",
          "Jeannette",
          "Johnstown",
          "Lancaster",
          "Lebanon",
          "Lock Haven",
          "Lower Burrell",
          "McKeesport",
          "Meadville",
          "Monessen",
          "Monongahela",
          "Nanticoke",
          "New Castle",
          "New Kensington",
          "Oil City",
          "Parker",
          "Philadelphia",
          "Pittsburgh",
          "Pittston",
          "Pottsville",
          "Reading",
          "Scranton",
          "Shamokin",
          "Sharon",
          "St. Marys",
          "Sunbury",
          "Titusville",
          "Uniontown",
          "Warren",
          "Washington",
          "Wilkes-Barre",
          "Williamsport",
          "York",
        ],

        init() {
          const noResultsEl = document.getElementById("no-results");
          if (noResultsEl) {
            noResultsEl.classList.add("hidden");
          }

          window.addEventListener("inspections-data-ready", () => {
            this.dataLoaded = true;
            this.refreshCards();
            if (noResultsEl) {
              noResultsEl.classList.add("hidden");
            }
          });

          if (
            typeof window.inspectionsDataLoaded === "function" &&
            window.inspectionsDataLoaded()
          ) {
            this.dataLoaded = true;
          }

          this.refreshCards();

          this.initSortListeners();

          this.initFilterListeners();

          this.initCityTypeahead();

          if (!this.initializedDelegates) {
            document.addEventListener("click", (e) => {
              const readMoreBtn = e.target.closest(
                'button[aria-label="Read more about this inspection"]',
              );
              if (readMoreBtn) {
                e.preventDefault();
                const card = readMoreBtn.closest('[data-card="inspection"]');
                if (card) {
                  this.lastReadMoreButton = readMoreBtn;
                  this.openDetails(card);
                }
                return;
              }
              const backBtn = e.target.closest(
                '[data-action="back-to-results"]',
              );
              if (backBtn) {
                e.preventDefault();
                this.backToResults();
                return;
              }
            });
            this.initializedDelegates = true;
          }
        },

        initSortListeners() {
          const sortRadios = document.querySelectorAll('input[name="sort"]');
          sortRadios.forEach((radio) => {
            radio.addEventListener("change", (e) => {
              if (e.target.checked) {
                this.currentSort = e.target.value;
                this.sortCards();
              }
            });
          });
        },

        initFilterListeners() {
          const cityFilter = document.getElementById("city-filter");
          if (cityFilter) {
            cityFilter.addEventListener("change", (e) => {
              this.currentCity = e.target.value;
              this.applyFilters();
            });
          }

          const clearButtons = document.querySelectorAll('[class*="Clear"]');
          clearButtons.forEach((btn) => {
            if (btn.textContent.trim().toLowerCase().includes("clear")) {
              btn.addEventListener("click", () => {
                this.clearFilters();
              });
            }
          });
        },

        initCityTypeahead() {
          const cityFilter = document.getElementById("city-filter");
          if (!cityFilter) return;

          let typeaheadBuffer = "";
          let typeaheadTimeout = null;

          cityFilter.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              typeaheadBuffer = "";
              return;
            }

            if (e.key.length > 1 && e.key !== "Backspace") return;

            if (e.key === "Backspace") {
              typeaheadBuffer = typeaheadBuffer.slice(0, -1);
            } else if (e.key.length === 1) {
              typeaheadBuffer += e.key.toLowerCase();
            }

            clearTimeout(typeaheadTimeout);
            typeaheadTimeout = setTimeout(() => {
              typeaheadBuffer = "";
            }, 1000);

            if (typeaheadBuffer) {
              const options = Array.from(cityFilter.options);
              const match = options.find((opt) =>
                opt.text.toLowerCase().startsWith(typeaheadBuffer),
              );

              if (match) {
                cityFilter.value = match.value;
                cityFilter.dispatchEvent(new Event("input", { bubbles: true }));
              }
            }
          });

          cityFilter.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              cityFilter.dispatchEvent(new Event("change", { bubbles: true }));
              typeaheadBuffer = "";
            }
          });
        },

        clearFilters() {
          const cityFilter = document.getElementById("city-filter");
          if (cityFilter) {
            cityFilter.value = "";
            this.currentCity = "";
          }

          const cuisineFilter = document.getElementById("cuisine-filter");
          if (cuisineFilter) {
            cuisineFilter.value = "";
          }

          this.applyFilters();
        },

        refreshCards() {
          this.cards = Array.from(
            document.querySelectorAll('[data-card="inspection"]'),
          );
          this.cards.forEach((card) => {
            if (!card.querySelector(".list-content")) {
              const wrap = document.createElement("div");
              wrap.className = "list-content";
              while (card.firstChild) wrap.appendChild(card.firstChild);
              card.appendChild(wrap);
            }
          });
          const norm = (s) =>
            (s || "")
              .toLowerCase()
              .replace(/[^a-z0-9\s]/g, "")
              .replace(/\s+/g, " ")
              .trim();
          this.cards.forEach((card) => {
            this.index.set(card, norm(card.dataset.index || card.textContent));

            const city = this.extractCity(card);
            this.cityMap.set(card, city);
          });
          if (this.dataLoaded) {
            this.sortCards();
            this.applyFilters();
          }
        },

        extractCity(card) {
          if (card.dataset.city) {
            return card.dataset.city.trim();
          }

          const spans = card.querySelectorAll(".list-content span");
          for (const span of spans) {
            const text = span.textContent;
            if (text.includes(",")) {
              const parts = text.split(",");
              if (parts.length >= 2) {
                const potentialCity = parts[parts.length - 1].trim();
                const match = this.paCities.find((city) =>
                  potentialCity.toLowerCase().includes(city.toLowerCase()),
                );
                if (match) {
                  return match;
                }
              }
            }
          }

          return "";
        },

        getCityCategory(city) {
          if (!city) return "Other";

          const normalizedCity = city.trim();
          const match = this.paCities.find(
            (paCity) =>
              normalizedCity.toLowerCase() === paCity.toLowerCase() ||
              normalizedCity.toLowerCase().includes(paCity.toLowerCase()),
          );

          return match || "Other";
        },

        sortCards() {
          if (this.cards.length === 0) return;

          const container = this.cards[0].parentElement;
          if (!container) return;

          const sortedCards = [...this.cards];

          switch (this.currentSort) {
            case "date":
              sortedCards.sort((a, b) => {
                const dateA = this.getInspectionDate(a);
                const dateB = this.getInspectionDate(b);
                return dateB - dateA;
              });
              break;

            case "alphabetical":
              sortedCards.sort((a, b) => {
                const nameA = this.getFacilityName(a).toLowerCase();
                const nameB = this.getFacilityName(b).toLowerCase();
                return nameA.localeCompare(nameB);
              });
              break;

            case "high-risk":
              // Placeholder for future high-risk sorting
              // For now, keep current order
              break;
          }

          sortedCards.forEach((card) => {
            container.appendChild(card);
          });

          this.cards = sortedCards;
        },

        getInspectionDate(card) {
          const dateText = card.querySelector("[data-date]")?.dataset.date;
          if (dateText) {
            return new Date(dateText);
          }

          const spans = card.querySelectorAll(".list-content span");
          for (const span of spans) {
            const text = span.textContent;
            if (text.includes("Last inspection:")) {
              const dateMatch = text.match(/Last inspection:\s*(.+)/i);
              if (dateMatch && dateMatch[1]) {
                return new Date(dateMatch[1].trim());
              }
            }
          }

          return new Date(0);
        },

        getFacilityName(card) {
          const h2 = card.querySelector("h2");
          return h2 ? h2.textContent.trim() : "";
        },

        norm(s) {
          return (s || "")
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, "")
            .replace(/\s+/g, " ")
            .trim();
        },

        syncHidden(card) {
          const hide =
            card.classList.contains("hidden-by-search") ||
            card.classList.contains("hidden-by-city") ||
            card.classList.contains("hidden-by-detail");
          card.classList.toggle("hidden", hide);
        },

        escapeHTML(s) {
          return String(s).replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              })[m],
          );
        },

        doSearch(val) {
          if (typeof val === "string") this.q = val;
          this.applyFilters();
        },

        applySearch() {
          this.applyFilters();
        },

        applyFilters() {
          if (!this.dataLoaded || this.cards.length === 0) {
            const noResultsEl = document.getElementById("no-results");
            if (noResultsEl) {
              noResultsEl.classList.add("hidden");
            }
            return;
          }

          const needle = this.norm(this.q);
          let visible = 0;

          this.cards.forEach((card) => {
            const searchHit = !needle || this.index.get(card).includes(needle);
            card.classList.toggle("hidden-by-search", !searchHit);

            let cityHit = true;
            if (this.currentCity) {
              const cardCity = this.cityMap.get(card) || "";
              const cardCityCategory = this.getCityCategory(cardCity);

              if (this.currentCity === "Other") {
                cityHit = cardCityCategory === "Other";
              } else {
                cityHit = cardCityCategory === this.currentCity;
              }
            }
            card.classList.toggle("hidden-by-city", !cityHit);

            this.syncHidden(card);
            if (!card.classList.contains("hidden")) visible++;
          });

          const noResultsEl = document.getElementById("no-results");
          if (noResultsEl)
            noResultsEl.classList.toggle("hidden", visible !== 0);
        },

        openDetails(card) {
          this.cards.forEach((c) => {
            if (c !== card) c.classList.add("hidden-by-detail");
            else c.classList.remove("hidden-by-detail");
            this.syncHidden(c);
          });
          const body = card;
          const listContent = body.querySelector(".list-content");
          let detail = body.querySelector(".detail-content");
          if (!detail) {
            detail = document.createElement("div");
            detail.className = "detail-content";
            body.appendChild(detail);
          }

          const title = (card.querySelector("h2")?.textContent || "").trim();
          const infoLines = Array.from(
            card.querySelectorAll(".list-content span"),
          ).map((n) => n.textContent.trim());
          const location =
            infoLines.find((t) => !/Last inspection:/i.test(t)) || "";
          const violations = this.readViolations(card);
          const items =
            violations.map((v) => this.renderViolationItem(v)).join("") ||
            `
        <li class="space-y-2">
          <div class="flex items-start pt-3 gap-2">
            <svg class="mt-1 h-5 w-5 fill-election-green" aria-hidden="true">
              <use href="#circle-check"></use>
            </svg>
            <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
              No violations reported.
            </h4>
          </div>
        </li>`;

          detail.innerHTML = `
        <div>
          <button
            type="button"
            class="inline-flex items-center font-sans font-bold text-black-9 hover:text-yellow-3"
            data-action="back-to-results"
            aria-label="Back to results"
          >
            <svg class="h-5 w-5 flex-shrink-0 fill-current" aria-hidden="true">
              <use href="#chevron-left"></use>
            </svg>
            <span class="ml-1.5">Back</span>
          </button>

          <div class="flex items-start justify-between gap-6 py-4 pr-4 sm:pr-6">
            <div class="min-w-0">
              <h2 class="text-3xl font-bold text-black break-words">${this.escapeHTML(title)}</h2>
              <div class="mt-2 space-y-1 text-g-6">
                ${
                  location
                    ? `
                  <div class="flex items-center gap-1">
                    <svg class="h-4 w-4 flex-shrink-0 fill-g-5" aria-hidden="true">
                      <use href="#map-pin"></use>
                    </svg>
                    <span>${this.escapeHTML(location)}</span>
                  </div>
                `
                    : ""
                }
              </div>
              <div class="mt-3">
                <button class="inline-flex items-center gap-2 rounded-md border-2 border-yellow-5 bg-yellow-4 px-4 py-2 font-sans font-semibold text-yellow-9 hover:bg-yellow-3">
                  <span>Get alerts</span>
                  <svg class="h-5 w-5 fill-yellow-9" aria-hidden="true">
                    <use href="#bell"></use>
                  </svg>
                </button>
                <p class="mt-2 text-sm font-sans text-g-6">Receive an email when new reports are available for this facility.</p>
              </div>
            </div>

            <div class="shrink-0 flex flex-col items-center gap-2 sm:flex mt-[-4px]">
              <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share via Email">
                <svg class="h-5 w-5 fill-white" aria-hidden="true">
                  <use href="#envelope"></use>
                </svg>
              </button>
              <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share on Facebook">
                <svg class="h-5 w-5 fill-white" aria-hidden="true">
                  <use href="#fb"></use>
                </svg>
              </button>
              <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share on X">
                <svg class="h-5 w-5 fill-white" aria-hidden="true">
                  <use href="#twitter"></use>
                </svg>
              </button>
              <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Copy link">
                <svg class="h-5 w-5 fill-white" aria-hidden="true">
                  <use href="#share"></use>
                </svg>
              </button>
            </div>
          </div>

          <section aria-labelledby="violations-title" class="space-y-3">
            <ul class="space-y-3">${items}</ul>
          </section>

          <div class="pt-5">
            <a href="#"
               class="group inline-flex items-center gap-2 font-sans font-semibold text-navy hover:text-blue">
              <svg class="h-5 w-5 flex-shrink-0 fill-current group-hover:text-blue" aria-hidden="true">
                <use href="#link"></use>
              </svg>
              <span>Read the full report</span>
            </a>
          </div>
        </div>
      `;
          listContent?.classList.add("hidden");
          detail
            .querySelector('[data-action="back-to-results"]')
            ?.focus({ preventScroll: true });
          card.scrollIntoView({ behavior: "smooth", block: "start" });
          this.activeCard = card;
          document.getElementById("no-results")?.classList.add("hidden");
        },

        backToResults() {
          if (!this.activeCard) return;
          const card = this.activeCard;
          card.querySelector(".detail-content")?.remove();
          card.querySelector(".list-content")?.classList.remove("hidden");
          this.cards.forEach((c) => {
            c.classList.remove("hidden-by-detail");
            this.syncHidden(c);
          });
          this.applyFilters();
          this.lastReadMoreButton?.focus({ preventScroll: true });
          this.activeCard = null;
        },

        renderViolationItem(v) {
          const { level = "low", title = "", comment = "" } = v;

          const iconFill =
            level === "high"
              ? "fill-red-7"
              : level === "moderate"
                ? "fill-yellow-4"
                : "fill-blue-6";

          const words = title.split(/\s+/);
          const lastWord = words.pop();
          const before = words.join(" ");

          return `
        <li class="space-y-2">
          <div class="flex items-start pt-5 gap-2">
            <svg class="mt-1 h-5 w-5 ${iconFill}" aria-hidden="true">
              <use href="#triangle-exclamation"></use>
            </svg>
            <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
              ${before}
              <span class="inline-flex items-center gap-1">
                ${lastWord}
                <svg class="h-5 w-5 ml-1 color-red" aria-hidden="true">
                  <use href="#circle-question"></use>
                </svg>
              </span>
            </h4>
          </div>
          ${
            comment
              ? `
            <p class="font-serif leading-relaxed text-g-7 border-l-4 border-g-5 pl-4">
              ${this.escapeHTML(comment)}
            </p>`
              : ""
          }
        </li>`;
        },

        readViolations(card) {
          const list = card.querySelector("ul.violations-data");
          if (list) {
            return Array.from(list.querySelectorAll("li"))
              .map((li) => ({
                level: li.getAttribute("data-level") || "",
                title: li.querySelector("h4")?.textContent?.trim() || "",
                comment: li.querySelector("p")?.textContent?.trim() || "",
              }))
              .filter((v) => v.title || v.comment);
          }
          const csv = card.getAttribute("data-violations-csv");
          if (csv) return this.parseViolationsCSV(csv);
          return [];
        },

        parseViolationsCSV(csvText) {
          const rows = [];
          let i = 0,
            s = csvText;
          const nextField = () => {
            if (s[i] === '"') {
              i++;
              let out = "";
              while (i < s.length) {
                if (s[i] === '"' && s[i + 1] === '"') {
                  out += '"';
                  i += 2;
                  continue;
                }
                if (
                  s[i] === '"' &&
                  (s[i + 1] === "," || s[i + 1] === "\n" || i + 1 === s.length)
                ) {
                  i++;
                  return out;
                }
                out += s[i++];
              }
              return out;
            } else {
              const start = i;
              while (i < s.length && s[i] !== "," && s[i] !== "\n") i++;
              return s.slice(start, i);
            }
          };
          const consume = (ch) => {
            if (s[i] === ch) i++;
          };
          const peek = s.slice(0, 48).toLowerCase();
          const hasHeader = peek.includes("level") && peek.includes("title");
          if (hasHeader) {
            while (i < s.length && s[i] !== "\n") i++;
            if (s[i] === "\n") i++;
          }
          while (i < s.length) {
            const level = nextField();
            consume(",");
            const title = nextField();
            consume(",");
            const comment = nextField();
            while (i < s.length && s[i] !== "\n") i++;
            if (s[i] === "\n") i++;
            if (title || comment) rows.push({ level, title, comment });
          }
          return rows;
        },
      };
    }

    function customScroll() {
      return {
        thumbTop: 0,
        thumbH: 32,
        thumbStyle: "height:32px; transform:translateY(0);",
        dragging: false,
        dragStartY: 0,
        dragStartTop: 0,
        ro: null,
        mo: null,

        init() {
          this.update();
          this.onScroll();

          this.ro = new ResizeObserver(() => this.update());
          this.ro.observe(this.$refs.viewport);

          this.mo = new MutationObserver(() => {
            requestAnimationFrame(() => this.update());
          });

          this.mo.observe(this.$refs.viewport, {
            childList: true,
            subtree: true,
            characterData: true,
          });

          window.addEventListener("inspections-data-ready", () => {
            setTimeout(() => this.update(), 100);
          });

          document.addEventListener("click", (e) => {
            const isReadMore = e.target.closest(
              '[aria-label="Read more about this inspection"]',
            );
            const isBack = e.target.closest('[data-action="back-to-results"]');
            if (isReadMore || isBack) {
              setTimeout(() => this.update(), 50);
            }
          });
        },

        update() {
          const vp = this.$refs.viewport;
          const track = this.$refs.track;
          if (!vp || !track) return;

          const trackH = track.clientHeight;
          const vh = vp.clientHeight;
          const sh = vp.scrollHeight;

          if (sh <= vh) {
            this.thumbH = 0;
            this.thumbStyle = "height:0; transform:translateY(0);";
            return;
          }

          const minThumb = 24;
          const ratio = vh / sh;
          this.thumbH = Math.max(minThumb, Math.round(trackH * ratio));
          this.onScroll();
        },

        onScroll() {
          const vp = this.$refs.viewport;
          const track = this.$refs.track;
          if (!vp || !track) return;

          const trackH = track.clientHeight;
          const maxThumbTop = Math.max(0, trackH - this.thumbH);
          const denom = Math.max(1, vp.scrollHeight - vp.clientHeight);
          const pct = vp.scrollTop / denom;
          this.thumbTop = Math.round(maxThumbTop * pct);
          this.thumbStyle = `height:${this.thumbH}px; transform:translateY(${this.thumbTop}px);`;
        },

        startDrag(e) {
          if (!e.target || e.target !== this.$refs.thumb) return;
          this.dragging = true;
          this.dragStartY = e.clientY;
          this.dragStartTop = this.thumbTop;
          const move = (ev) => this.onDrag(ev);
          const up = () => this.stopDrag(move, up);
          document.addEventListener("mousemove", move);
          document.addEventListener("mouseup", up, { once: true });
        },

        onDrag(ev) {
          if (!this.dragging) return;
          const track = this.$refs.track;
          const trackH = track.clientHeight;
          const delta = ev.clientY - this.dragStartY;
          const nextTop = Math.min(
            Math.max(0, this.dragStartTop + delta),
            trackH - this.thumbH,
          );
          this.thumbTop = nextTop;
          const vp = this.$refs.viewport;
          const ratio = nextTop / Math.max(1, trackH - this.thumbH);
          vp.scrollTop = ratio * Math.max(0, vp.scrollHeight - vp.clientHeight);
          this.thumbStyle = `height:${this.thumbH}px; transform:translateY(${this.thumbTop}px);`;
        },

        stopDrag(move, up) {
          this.dragging = false;
          document.removeEventListener("mousemove", move);
          document.removeEventListener("mouseup", up);
        },

        trackJump(e) {
          const track = this.$refs.track;
          const rect = track.getBoundingClientRect();
          const y = e.clientY - rect.top - this.thumbH / 2;
          const trackH = track.clientHeight;
          const top = Math.min(Math.max(0, y), trackH - this.thumbH);
          const ratio = top / Math.max(1, trackH - this.thumbH);
          const vp = this.$refs.viewport;
          vp.scrollTop = ratio * Math.max(0, vp.scrollHeight - vp.clientHeight);
        },
      };
    }
  </script>
{{ end }}
