{{ define "extra-head" }}
  {{ if .Param "map" }}
    {{ partial "header/maplibre.html" . }}
  {{ end }}
{{ end }}

{{ define "extra-footer" }}
  {{ partial "blocks/maplibre.html" . }}
{{ end }}

{{ define "main" }}
  <section class="mt-6 bg-black pb-6">
    <div
      class="mx-auto w-full max-w-screen-xl flex-wrap gap-4 px-4 pt-16 md:gap-x-6 md:px-0 lg:gap-x-12"
    >
      {{ with .Param "eyebrow" }}
        <div class="mx-auto w-full md:w-7/12">
          <p
            class="ga:component:main:header:eyebrow text-small inline-block border-2 border-white bg-white px-2 font-sans font-semibold uppercase text-black md:text-lg"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <h1
        class="mx-auto mt-4 w-full pb-2 font-serif text-3xl font-semibold leading-tight text-white sm:text-4xl md:w-7/12 lg:text-5xl"
      >
        {{ .Title }}
      </h1>

      {{ $byline := .Param "byline" }}
      {{ $outlet := .Param "outlet" | default "Spotlight PA" }}
      {{ $bylineLink := "" }}

      {{ with .Param "authors" }}
        {{ if len . | eq 1 }}
          {{ $name := index . 0 }}
          {{ $author := partial "helper/get-author" $name }}
          {{ if $author.link }}
            {{ $bylineLink = $author.link }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $byline }}
        <div
          class="mx-auto mt-4 w-full text-lg leading-none text-white md:w-7/12 lg:text-xl"
        >
          <span class="font-sans">
            by
            {{ if $bylineLink }}
              <a
                href="{{ $bylineLink }}"
                class="font-semibold underline hover:text-yellow"
                >{{ $byline }}</a
              >
            {{ else }}
              <span class="font-semibold">{{ $byline }}</span>
            {{ end }}
            of
            {{ $outlet }}
          </span>
        </div>
      {{ end }}


      <div class="mx-auto w-full md:w-7/12">
        {{ partial "tw/horizontal-social-buttons.html" . }}
      </div>

      {{ with .Param "deck" }}
        <div class="mx-auto mt-4 w-full md:w-7/12">
          <p class="font-serif text-xl text-white md:text-2xl md:leading-tight">
            {{ . }}
          </p>
        </div>
      {{ end }}

      {{ with .Param "search-instructions" }}
        <div class="mx-auto mt-8 w-full md:w-7/12">
          <p
            class="font-serif text-xl italic text-white md:text-2xl md:leading-tight"
          >
            {{ . }}
          </p>
        </div>
      {{ end }}


      <div
        class="mx-auto mt-6 w-full md:hidden"
        x-data="inspectionsUI()"
        x-init="init()"
      >
        {{ partial "blocks/search.html" (dict
          "placeholder" (default "Search restaurants" (.Param "search-placeholder"))
          "showLocation" (.Param "search-location")
          "context" .
          )
        }}
      </div>
    </div>
  </section>

  <section
    class="hidden bg-white md:block"
    x-data="inspectionsUI()"
    x-init="init()"
  >
    <div class="w-full px-4 md:px-0">
      <div class="grid h-[525px] grid-cols-[1fr_auto_2fr_2fr]">
        <div class="flex flex-col px-4 py-3">
          <h3 class="font-sans text-3xl font-bold">Filters</h3>

          <div class="mt-4 hidden space-y-3 md:block">
            <button
              class="flex w-full items-center justify-between gap-2 rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 font-sans text-lg font-semibold text-yellow-9 transition hover:bg-yellow-3"
            >
              <span>Filter</span>
              <svg class="h-5 w-5 fill-yellow-9">
                {{ partial "helper/svg.html" "filter" }}
              </svg>
            </button>

            <button
              class="flex w-full items-center justify-between gap-2 rounded-lg border-2 border-yellow-5 bg-yellow-4 px-6 py-3 font-sans text-lg font-semibold text-yellow-9 transition hover:bg-yellow-3"
            >
              <span>Sort</span>
              <svg class="h-5 w-5 fill-yellow-9">
                {{ partial "helper/svg.html" "chevron" }}
              </svg>
            </button>
          </div>
        </div>

        <div aria-hidden="true" class="h-full w-3 bg-[#e9e9e9]"></div>

        <div class="flex min-h-0 flex-col">
          <div class="md:bg-white md:p-4 md:shadow">
            {{ partial "blocks/search.html" (dict
              "placeholder" (default "Search" (or (.Param "search-desktop-placeholder") (.Param "search-placeholder")))
              "showLocation" (.Param "search-location")
              "context" .
              )
            }}
          </div>

          <div
            class="relative min-h-0 grow overflow-hidden rounded-t-[40px] bg-g-3 md:rounded-none"
            x-data="customScroll()"
            x-init="init()"
            @resize.window="update()"
          >
            <div
              x-ref="viewport"
              class="sb-hide h-full overflow-y-auto bg-white pr-[12px]"
              @scroll="onScroll()"
              tabindex="0"
              aria-label="Inspection results list"
            >
              {{ partial "blocks/mobile-scroll.html" . }}
            </div>

            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex w-[12px] items-stretch"
              aria-hidden="true"
            >
              <div
                x-ref="track"
                class="pointer-events-auto relative h-full w-full rounded-none bg-g-4 [box-shadow:inset_0_0_0_1px_rgba(0,0,0,0.06)]"
                @mousedown.prevent="startDrag($event)"
                @click.stop="trackJump($event)"
              >
                <div
                  x-ref="thumb"
                  class="absolute left-0 right-0 w-full rounded-none bg-g-7"
                  :style="thumbStyle"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex h-full flex-col">
          {{ partial "blocks/maplibre-assets.html" (dict
            "ctx" .
            "id" "inspections-map"
            "ariaLabel" "Pennsylvania inspections map"
            "class" "relative h-full w-full"
            )
          }}
        </div>
      </div>
    </div>
  </section>

  <div class="md:hidden">
    {{ partial "blocks/mobile-scroll.html" . }}
  </div>

  <section class="bg-white" data-ga-category="about">
    <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
      <div class="mx-auto w-full space-y-8 md:w-7/12">
        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "about-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "about-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "questions-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "questions-description" }}
          </p>
        </div>

        <div>
          <h2 class="font-sans text-2xl font-bold text-black md:text-3xl">
            {{ .Param "tips-title" }}
          </h2>
          <p class="pt-4 font-serif leading-relaxed text-black">
            {{ .Param "tips-description" }}
          </p>
        </div>
      </div>
    </div>
  </section>

  {{ with .Page.RenderString (.Param "credits") }}
    <section
      class="bg-white"
      id="credits"
      data-ga-category="credits"
      x-data
      x-intersect.half="$dispatch('intersect:about', $el.id)"
    >
      <div class="mx-auto w-full max-w-screen-xl px-4 py-6 md:px-0">
        <div class="mx-auto w-full md:w-7/12">
          <h2
            class="w-full border-b border-black font-sans text-2xl font-extrabold capitalize leading-tight tracking-wide md:text-3xl"
          >
            Credits
          </h2>
          <div class="space-y-8 py-6">
            {{ . }}
          </div>
        </div>
      </div>
    </section>
  {{ end }}

  <script>
    function inspectionsUI() {
      return {
        q: "",
        cards: [],
        index: new Map(),
        activeCard: null,
        lastReadMoreButton: null,
        initializedDelegates: false,

        init() {
          this.cards = Array.from(
            document.querySelectorAll('[data-card="inspection"]'),
          );
          this.cards.forEach((card) => {
            if (!card.querySelector(".list-content")) {
              const wrap = document.createElement("div");
              wrap.className = "list-content";
              while (card.firstChild) wrap.appendChild(card.firstChild);
              card.appendChild(wrap);
            }
          });
          const norm = (s) =>
            (s || "")
              .toLowerCase()
              .replace(/[^a-z0-9\s]/g, "")
              .replace(/\s+/g, " ")
              .trim();
          this.cards.forEach((card) => {
            this.index.set(card, norm(card.dataset.index || card.textContent));
          });
          this.applySearch();
          if (!this.initializedDelegates) {
            document.addEventListener("click", (e) => {
              const readMoreBtn = e.target.closest(
                'button[aria-label="Read more about this inspection"]',
              );
              if (readMoreBtn) {
                e.preventDefault();
                const card = readMoreBtn.closest('[data-card="inspection"]');
                if (card) {
                  this.lastReadMoreButton = readMoreBtn;
                  this.openDetails(card);
                }
                return;
              }
              const backBtn = e.target.closest(
                '[data-action="back-to-results"]',
              );
              if (backBtn) {
                e.preventDefault();
                this.backToResults();
                return;
              }
            });
            this.initializedDelegates = true;
          }
        },

        norm(s) {
          return (s || "")
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, "")
            .replace(/\s+/g, " ")
            .trim();
        },
        syncHidden(card) {
          const hide =
            card.classList.contains("hidden-by-search") ||
            card.classList.contains("hidden-by-detail");
          card.classList.toggle("hidden", hide);
        },
        escapeHTML(s) {
          return String(s).replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              })[m],
          );
        },

        doSearch(val) {
          if (typeof val === "string") this.q = val;
          this.applySearch();
        },
        applySearch() {
          const needle = this.norm(this.q);
          let visible = 0;
          this.cards.forEach((card) => {
            const hit = !needle || this.index.get(card).includes(needle);
            card.classList.toggle("hidden-by-search", !hit);
            this.syncHidden(card);
            if (!card.classList.contains("hidden")) visible++;
          });
          const noResultsEl = document.getElementById("no-results");
          if (noResultsEl)
            noResultsEl.classList.toggle("hidden", visible !== 0);
        },

        openDetails(card) {
          this.cards.forEach((c) => {
            if (c !== card) c.classList.add("hidden-by-detail");
            else c.classList.remove("hidden-by-detail");
            this.syncHidden(c);
          });
          const body = card;
          const listContent = body.querySelector(".list-content");
          let detail = body.querySelector(".detail-content");
          if (!detail) {
            detail = document.createElement("div");
            detail.className = "detail-content";
            body.appendChild(detail);
          }

          const title = (card.querySelector("h2")?.textContent || "").trim();
          const infoLines = Array.from(
            card.querySelectorAll(".list-content span"),
          ).map((n) => n.textContent.trim());
          const location =
            infoLines.find((t) => !/Last inspection:/i.test(t)) || "";
          const violations = this.readViolations(card);
          const items =
            violations.map((v) => this.renderViolationItem(v)).join("") ||
            `
            <li class="space-y-2">
              <div class="flex items-start pt-3 gap-2">
                <svg class="mt-1 h-5 w-5 fill-election-green" aria-hidden="true">
                  {{ partial "helper/svg.html" "circle-check" }}
                </svg>
                <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
                  No violations reported.
                </h4>
              </div>
            </li>`;

          detail.innerHTML = `
            <div>
              <button
                type="button"
                class="inline-flex items-center font-sans font-bold text-black-9 hover:text-yellow-3"
                data-action="back-to-results"
                aria-label="Back to results"
              >
                <svg class="h-5 w-5 flex-shrink-0 fill-current" aria-hidden="true">
                  {{ partial "helper/svg.html" "chevron-left" }}
                </svg>
                <span class="ml-1.5">Back</span>
              </button>

              <div class="flex items-start justify-between gap-6 py-4 pr-4 sm:pr-6">
                <div class="min-w-0">
                  <h2 class="text-3xl font-bold text-black break-words">${this.escapeHTML(title)}</h2>
                  <div class="mt-2 space-y-1 text-g-6">
                    ${
                      location
                        ? `
                      <div class="flex items-center gap-1">
                        <svg class="h-4 w-4 flex-shrink-0 fill-g-5" aria-hidden="true">
                          {{ partial "helper/svg.html" "map-pin" }}
                        </svg>
                        <span>${this.escapeHTML(location)}</span>
                      </div>
                    `
                        : ""
                    }
                  </div>
                  <div class="mt-3">
                    <button class="inline-flex items-center gap-2 rounded-md border-2 border-yellow-5 bg-yellow-4 px-4 py-2 font-sans font-semibold text-yellow-9 hover:bg-yellow-3">
                      <span>Get alerts</span>
                      <svg class="h-5 w-5 fill-yellow-9" aria-hidden="true">
                        {{ partial "helper/svg.html" "bell" }}
                      </svg>
                    </button>
                    <p class="mt-2 text-sm font-sans text-g-6">Receive an email when new reports are available for this facility.</p>
                  </div>
                </div>

                <div class="shrink-0 flex flex-col items-center gap-2 sm:flex mt-[-4px]">
                  <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share via Email">
                    <svg class="h-5 w-5 fill-white" aria-hidden="true">
                      {{ partial "helper/svg.html" "envelope" }}
                    </svg>
                  </button>
                  <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share on Facebook">
                    <svg class="h-5 w-5 fill-white" aria-hidden="true">
                      {{ partial "helper/svg.html" "fb" }}
                    </svg>
                  </button>
                  <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Share on X">
                    <svg class="h-5 w-5 fill-white" aria-hidden="true">
                      {{ partial "helper/svg.html" "twitter" }}
                    </svg>
                  </button>
                  <button class="rounded-full p-2 bg-[#000000] hover:bg-[#333333]" aria-label="Copy link">
                    <svg class="h-5 w-5 fill-white" aria-hidden="true">
                      {{ partial "helper/svg.html" "share" }}
                    </svg>
                  </button>
                </div>
              </div>

              <section aria-labelledby="violations-title" class="space-y-3">
                <ul class="space-y-3">${items}</ul>
              </section>

              <div class="pt-5">
                <a href="#"
                   class="group inline-flex items-center gap-2 font-sans font-semibold text-navy hover:text-blue">
                  <svg class="h-5 w-5 flex-shrink-0 fill-current group-hover:text-blue" aria-hidden="true">
                    {{ partial "helper/svg.html" "link" }}
                  </svg>
                  <span>Read the full report</span>
                </a>
              </div>
            </div>
          `;
          listContent?.classList.add("hidden");
          detail
            .querySelector('[data-action="back-to-results"]')
            ?.focus({ preventScroll: true });
          card.scrollIntoView({ behavior: "smooth", block: "start" });
          this.activeCard = card;
          document.getElementById("no-results")?.classList.add("hidden");
        },

        backToResults() {
          if (!this.activeCard) return;
          const card = this.activeCard;
          card.querySelector(".detail-content")?.remove();
          card.querySelector(".list-content")?.classList.remove("hidden");
          this.cards.forEach((c) => {
            c.classList.remove("hidden-by-detail");
            this.syncHidden(c);
          });
          this.applySearch();
          this.lastReadMoreButton?.focus({ preventScroll: true });
          this.activeCard = null;
        },

        renderViolationItem(v) {
          const { level = "low", title = "", comment = "" } = v;

          const iconFill =
            level === "high"
              ? "fill-red-7"
              : level === "moderate"
                ? "fill-yellow-4"
                : "fill-blue-6";

          const words = title.split(/\s+/);
          const lastWord = words.pop();
          const before = words.join(" ");

          return `
            <li class="space-y-2">
              <div class="flex items-start pt-5 gap-2">
                <svg class="mt-1 h-5 w-5 ${iconFill}" aria-hidden="true">
                  {{ partial "helper/svg.html" "triangle-exclamation" }}
                </svg>
                <h4 class="font-sans text-lg font-bold text-black flex flex-wrap items-center gap-1">
                  ${before}
                  <span class="inline-flex items-center gap-1">
                    ${lastWord}
                    <svg class="h-5 w-5 ml-1 color-red" aria-hidden="true">
                      {{ partial "helper/svg.html" "circle-question" }}
                    </svg>
                  </span>
                </h4>
              </div>
              ${
                comment
                  ? `
                <p class="font-serif leading-relaxed text-g-7 border-l-4 border-g-5 pl-4">
                  ${this.escapeHTML(comment)}
                </p>`
                  : ""
              }
            </li>`;
        },

        readViolations(card) {
          const list = card.querySelector("ul.violations-data");
          if (list) {
            return Array.from(list.querySelectorAll("li"))
              .map((li) => ({
                level: li.getAttribute("data-level") || "",
                title: li.querySelector("h4")?.textContent?.trim() || "",
                comment: li.querySelector("p")?.textContent?.trim() || "",
              }))
              .filter((v) => v.title || v.comment);
          }
          const csv = card.getAttribute("data-violations-csv");
          if (csv) return this.parseViolationsCSV(csv);
          return [];
        },

        parseViolationsCSV(csvText) {
          const rows = [];
          let i = 0,
            s = csvText;
          const nextField = () => {
            if (s[i] === '"') {
              i++;
              let out = "";
              while (i < s.length) {
                if (s[i] === '"' && s[i + 1] === '"') {
                  out += '"';
                  i += 2;
                  continue;
                }
                if (
                  s[i] === '"' &&
                  (s[i + 1] === "," || s[i + 1] === "\n" || i + 1 === s.length)
                ) {
                  i++;
                  return out;
                }
                out += s[i++];
              }
              return out;
            } else {
              const start = i;
              while (i < s.length && s[i] !== "," && s[i] !== "\n") i++;
              return s.slice(start, i);
            }
          };
          const consume = (ch) => {
            if (s[i] === ch) i++;
          };
          const peek = s.slice(0, 48).toLowerCase();
          const hasHeader = peek.includes("level") && peek.includes("title");
          if (hasHeader) {
            while (i < s.length && s[i] !== "\n") i++;
            if (s[i] === "\n") i++;
          }
          while (i < s.length) {
            const level = nextField();
            consume(",");
            const title = nextField();
            consume(",");
            const comment = nextField();
            while (i < s.length && s[i] !== "\n") i++;
            if (s[i] === "\n") i++;
            if (title || comment) rows.push({ level, title, comment });
          }
          return rows;
        },
      };
    }

    function customScroll() {
      return {
        thumbTop: 0,
        thumbH: 32,
        thumbStyle: "height:32px; transform:translateY(0);",
        dragging: false,
        dragStartY: 0,
        dragStartTop: 0,
        ro: null,

        init() {
          this.update();
          this.onScroll();
          this.ro = new ResizeObserver(() => this.update());
          this.ro.observe(this.$refs.viewport);
        },

        update() {
          const vp = this.$refs.viewport;
          const trackH = this.$refs.track.clientHeight;
          if (!vp || !trackH) return;
          const vh = vp.clientHeight;
          const sh = vp.scrollHeight;
          const minThumb = 24;
          const ratio = sh > 0 ? vh / sh : 1;
          this.thumbH = Math.max(minThumb, Math.round(trackH * ratio));
          this.onScroll();
        },

        onScroll() {
          const vp = this.$refs.viewport;
          const trackH = this.$refs.track.clientHeight;
          const maxThumbTop = Math.max(0, trackH - this.thumbH);
          const denom = Math.max(1, vp.scrollHeight - vp.clientHeight);
          const pct = vp.scrollTop / denom;
          this.thumbTop = Math.round(maxThumbTop * pct);
          this.thumbStyle = `height:${this.thumbH}px; transform:translateY(${this.thumbTop}px);`;
        },

        startDrag(e) {
          if (!e.target || e.target !== this.$refs.thumb) return;
          this.dragging = true;
          this.dragStartY = e.clientY;
          this.dragStartTop = this.thumbTop;
          const move = (ev) => this.onDrag(ev);
          const up = () => this.stopDrag(move, up);
          document.addEventListener("mousemove", move);
          document.addEventListener("mouseup", up, { once: true });
        },

        onDrag(ev) {
          if (!this.dragging) return;
          const trackH = this.$refs.track.clientHeight;
          const delta = ev.clientY - this.dragStartY;
          const nextTop = Math.min(
            Math.max(0, this.dragStartTop + delta),
            trackH - this.thumbH,
          );
          this.thumbTop = nextTop;
          const vp = this.$refs.viewport;
          const ratio = nextTop / Math.max(1, trackH - this.thumbH);
          vp.scrollTop =
            ratio * Math.max(0, vp.scrollHeight - vp.clientHeight);
          this.thumbStyle = `height:${this.thumbH}px; transform:translateY(${this.thumbTop}px);`;
        },

        stopDrag(move, up) {
          this.dragging = false;
          document.removeEventListener("mousemove", move);
          document.removeEventListener("mouseup", up);
        },

        trackJump(e) {
          const rect = this.$refs.track.getBoundingClientRect();
          const y = e.clientY - rect.top - this.thumbH / 2;
          const trackH = this.$refs.track.clientHeight;
          const top = Math.min(Math.max(0, y), trackH - this.thumbH);
          const ratio = top / Math.max(1, trackH - this.thumbH);
          const vp = this.$refs.viewport;
          vp.scrollTop =
            ratio * Math.max(0, vp.scrollHeight - vp.clientHeight);
        },
      };
    }
  </script>
{{ end }}
